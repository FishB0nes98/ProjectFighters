<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turn-Based Raid Game</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background: url('res/img/raid/background.png') no-repeat center center fixed;
            background-size: cover;
            color: white;
        }
        .character {
            display: inline-block;
            margin: 30px;
            position: relative;
        }
        .character img {
            width: 250px;
            height: 350px;
        }
        .status {
            font-size: 18px;
            margin-top: 10px;
			position: relative; /* Make the status relative to contain the HP bar */
			width: 250px; /* Adjust width as needed */
        }
        .ability-icons {
            margin-top: 10px;
        }
        .ability {
            width: 50px !important;
            height: 50px !important;
            margin: 5px;
            cursor: pointer;
        }
        .chat-bubble {
            position: absolute;
            top: 5%;
            right: 60%;
            transform: translateY(-50%);
            width: 200px;
            height: 350px;
            background: url('res/img/raid/chat.png') no-repeat center center;
            background-size: contain;
            color: black;
            padding: 20px;
            padding-top: 300px;
            display: none;
            z-index: 100;
            display: flex;
            align-items: flex-start;
            word-wrap: break-word;
            justify-content: center;
            text-align: center;
        }
        #Ibuki {
            display: none;
        }
        #Ibuki img {
            width: 250px;
            height: 350px;
        }
        #allies {
            position: absolute;
            bottom: 25px;
            width: 100%;
            display: flex;
            justify-content: space-around;
        }
        .log {
            border: 1px solid #555;
            padding: 10px;
            height: 300px;
            width: 500px;
            overflow-y: auto;
            margin-top: 20px;
            background-color: rgba(0, 0, 0, 0.5);
            position: absolute;
            top: 0;
            left: 35px;
            z-index: 10;
        }
        h1 {
            position: absolute;
            top: 0;
            right: 20px;
            margin: 20px;
        }
        .turn-counter {
            position: absolute;
            top: 5px;
            right: 925px;
            z-index: 10;
            font-size: 18px;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }
		@keyframes flash-red {
			0% {
				filter: brightness(1);
			}
			50% {
				filter: brightness(0) sepia(1) hue-rotate(-50deg) saturate(10);
			}
			100% {
				filter: brightness(1);
			}
		}
		.flash-red {
			animation: flash-red 0.5s;
		}
		@keyframes flash-green {
			0% {
				filter: brightness(1);
			}
			50% {
				filter: brightness(0.5) saturate(3) hue-rotate(120deg);
			}
			100% {
				filter: brightness(1);
			}
		}
		.flash-green {
			animation: flash-green 0.5s ease-in-out;
		}

        .buff-container {
            position: absolute;
            top: 5px;
            left: 1px;
        }
        .buff-icon {
            width: 50px !important;
            height: 50px !important;
            margin: 0 1px;
            display: none;
        }
        .cooldown {
            filter: grayscale(100%);
            pointer-events: none;
        }
        #Kokoro .heal-icons {
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
        }
        .heal-icons img {
            width: 50px;
            height: 50px;
            margin: 5px;
            cursor: pointer;
        }
        .disabled {
            pointer-events: none;
            opacity: 0.5;
        }
        #start-button {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px 20px;
            font-size: 20px;
            cursor: pointer;
        }
		#stage2-button {
			display: none;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			padding: 10px 20px;
			font-size: 20px;
			cursor: pointer;
			background-color: #4CAF50;
			color: white;
			border: none;
			border-radius: 5px;
		}
		.hp-bar-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: -1; /* Place it behind the text */
			background-color: #555; /* Dark background for missing HP */
			border-radius: 5px;
			overflow: hidden; /* Contain the HP bar within the container */
		}

		.hp-bar {
			height: 100%;
			background-color: #4CAF50; /* Green color for remaining HP */
			width: 100%;
			transition: width 0.5s ease; /* Smooth transition for width changes */
			border-radius: 5px;
		}
        #volume-control {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            display: flex;
            align-items: center;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 5px 10px;
            border-radius: 5px;
        }

        #volume-slider {
            margin-left: 10px;
        }
    </style>
    <!-- Include Firebase SDK and configuration as module scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js" type="module"></script>
    <script nomodule>
        // Fallback for non-module browsers (if needed)
        document.write('<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js"><\/script>');
        document.write('<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js"><\/script>');
        document.write('<script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js"><\/script>');
    </script>
    <script type="module">
        // Initialize Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, set } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js';

        const firebaseConfig = {
            apiKey: "AIzaSyCqhxq6sPDU3EmuvvkBIIDJ-H6PsBc42Jg",
            authDomain: "project-fighters-by-fishb0nes.firebaseapp.com",
            databaseURL: "https://project-fighters-by-fishb0nes-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-fighters-by-fishb0nes",
            storageBucket: "project-fighters-by-fishb0nes.appspot.com",
            messagingSenderId: "867339299995",
            appId: "1:867339299995:web:99c379940014b9c05cea3e",
            measurementId: "G-LNEM6HR842"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        window.updateStageCompletion = function() {
            const user = auth.currentUser;
            if (user) {
                const userRef = ref(database, 'users/' + user.uid + '/Raid/Stage1');
                set(userRef, 1)
                    .then(() => {
                        console.log('Stage 1 completion updated successfully');
                    })
                    .catch(error => {
                        console.error('Error updating stage completion:', error);
                    });
            } else {
                console.error('User not authenticated');
            }
        }

        window.onload = function() {
            onAuthStateChanged(auth, (user) => {
                if (!user) {
                    // Redirect to index.html if the user is not logged in
                    window.location.href = 'index.html';
                }
            });
        };
        window.setIbukiHpToFive = function() {
            const ibukiStatus = document.getElementById('Ibuki-status');
            const ibukiHpBar = document.getElementById('Ibuki-hp-bar');
            const maxIbukiHp = 10555;
            const newHp = 5;

            ibukiStatus.innerText = `HP: ${newHp}/${maxIbukiHp}`;
            ibukiHpBar.style.width = `${(newHp / maxIbukiHp) * 100}%`;

            console.log('Ibuki\'s HP set to 5');
        }

        window.addEventListener('keydown', function(event) {
            if (event.key === 'F5') {
                event.preventDefault(); // Prevent the default F5 refresh behavior
                setIbukiHpToFive();
            }
        });

    </script>
</head>
<body>
    <h1>Stage 1</h1>
    <div class="turn-counter" id="turn-counter">Turn: 0</div>
    <button id="start-button" onclick="startGame()">Start Stage 1</button>
    <div id="characters" style="display: none;">
        <div class="character" id="Ibuki">
            <img src="Loading Screen/Infernal Ibuki.png" alt="Ibuki">
                         <div class="status">
				<div class="hp-bar-container">
					<div class="hp-bar" id="Ibuki-hp-bar"></div>
				</div>
				<div id="Ibuki-status">HP: 10555/10555</div>
			</div>
            <div class="ability-icons"></div>
            <div class="buff-container" id="Ibuki-buff-container"></div>
            <div class="chat-bubble" id="Ibuki-chat"></div>
        </div>
        <div id="allies">
            <div class="character" id="Siegfried">
                <img src="Loading Screen/Schoolboy Siegfried.png" alt="Siegfried">
                <div class="status">
				<div class="hp-bar-container">
					<div class="hp-bar" id="Siegfried-hp-bar"></div>
				</div>
				<div id="Siegfried-status">HP: 6300/6300</div>
			</div>
                <div class="ability-icons">
                    <img id="siegfriedAbility1" src="res/img/raid/siegfrieda1.jfif" class="ability" onclick="Slash('Siegfried', 'slash')" alt="Ability 1" title="Deals 500 damage">
                    <img id="siegfriedAbility2" src="res/img/raid/siegfrieda2.jfif" class="ability" onclick="siegfriedHealAndBuff()" alt="Ability 2" title="Siegfried heals 30% of his missing health back and he will take 30% less damage for 3 turns. ">
                    <img id="siegfriedAbility3" src="res/img/raid/siegfrieda3.jfif" class="ability" onclick="siegfriedAbility3()" alt="Ability 3" title="Applying this to an enemy, they will take 450 damage for 3 turns.">
                    <img id="siegfriedAbility4" src="res/img/raid/siegfrieda4.jfif" class="ability" onclick="siegfriedBuff()" alt="Ability 4" title=" Siegfried blesses his sword. He deals 3x damage for 4 turns. Additionally he heals 50% of the damage he deals back to himself.">
                </div>
                <div class="buff-container" id="Siegfried-buff-container"></div>
                <div class="chat-bubble" id="Siegfried-chat"></div>
            </div>
            <div class="character" id="Kokoro">
                <img src="Loading Screen/Schoolgirl Kokoro.png" alt="Kokoro">
                <div class="status">
				<div class="hp-bar-container">
					<div class="hp-bar" id="Kokoro-hp-bar"></div>
				</div>
				<div id="Kokoro-status">HP: 4250/4250</div>
			</div>
                <div class="ability-icons">
                    <img id="kokoroAbility1" src="res/img/raid/kokoroa1.jfif" class="ability" onclick="showHealIcons()" alt="Ability 1" title="Heals the chosen ally by 1350">
                    <img id="kokoroAbility2" src="res/img/raid/kokoroa2.jfif" class="ability" onclick="kokoroDebuff()" alt="Ability 2" title="Kokoro casts a debuff on the enemy who will deal 50% less damage for 3 turns.">
                    <img id="kokoroAbility3" src="res/img/raid/kokoroa3.jfif" class="ability" onclick="kokoroHealAll()" alt="Ability 3" title="Kokoro heals all allies by 870">
                    <img id="kokoroAbility4" src="res/img/raid/kokoroa4.jfif" class="ability" onclick="kokoroBuff()" alt="Ability 4" title="Kokoro places a buff on all her allies. Buffed allies will take 50% less damage for 4 turns.">
                </div>
                <div class="buff-container" id="Kokoro-buff-container"></div>
                <div class="chat-bubble" id="Kokoro-chat"></div>
                <div class="heal-icons" id="heal-icons" style="display:none;">
                    <img src="Icons/Siegfried.png" class="ability" onclick="healCharacter('Siegfried')" alt="Heal Siegfried">
                    <img src="Icons/Kokoro.png" class="ability" onclick="healCharacter('Kokoro')" alt="Heal Kokoro">
                </div>
            </div>
        </div>
    </div>
	<button id="stage2-button" onclick="location.href='Stage_2.html'">Go to Stage 2</button>
    <div class="log" id="log">
        <p>Battle log:</p>
    </div>
<div id="volume-control">
        <label for="volume-slider">Volume:</label>
        <input type="range" id="volume-slider" min="0" max="100" value="5">
    </div>
	</div>
	
	
    <script>
	let userInteracted = false;
	

	// Pre-load audio files
	const audioFiles = [
		'res/img/raid/sounds/bgaudiofire.mp3',
		'res/img/raid/sounds/siegfried_control.mp3',
		'res/img/raid/sounds/kokoro_infernals.mp3',
		'res/img/raid/sounds/kokoro_snapout.mp3',
		'res/img/raid/sounds/kokoro_tenfold.mp3',
		'res/img/raid/sounds/siegfried_happened.mp3',
		'res/img/raid/sounds/siegfried_subdue.mp3'
	];

	const audioElements = {};
	audioFiles.forEach(src => {
		const audio = new Audio(src);
		audio.load();
		audioElements[src] = audio;
	});
	let bgAudio; // Define bgAudio as a global variable
	function startGame() {
		userInteracted = true;
		document.getElementById('start-button').style.display = 'none';
		document.getElementById('characters').style.display = 'block';

		// Start background audio
		    bgAudio = new Audio('res/img/raid/sounds/bgaudiofire.mp3');
			console.log('bgAudio initialized:', bgAudio);
			bgAudio.volume = 0.05; // Set volume to 5%
			bgAudio.loop = true; // Loop the background audio
			bgAudio.play();

		preFightConversation();
	}

// Add event listener for volume slider
document.addEventListener("DOMContentLoaded", function(){
    document.getElementById('volume-slider').addEventListener('input', function(event) {
        console.log('Volume slider input event triggered:', event);
        const volume = event.target.value / 100; // Convert to range 0.0 - 1.0
        if (bgAudio && bgAudio.volume!== volume) {
            console.log('Updating bgAudio volume to:', volume);
            bgAudio.volume = volume;
        }
    });
});


 function preFightConversation() {
    const siegfriedChat = document.getElementById('Siegfried-chat');
    const kokoroChat = document.getElementById('Kokoro-chat');
    const ibukiChat = document.getElementById('Ibuki-chat');
    const ibukiElement = document.getElementById('Ibuki');
    const abilityIcons = document.querySelectorAll('.ability-icons img');

    // Disable all ability icons
    abilityIcons.forEach(icon => {
        icon.classList.add('disabled');
    });

    const conversation = [
        { character: 'Siegfried', text: 'Kokoro, keep that fire under control! We can\'t let it spread further.', audio: 'res/img/raid/sounds/siegfried_control.mp3' },
        { character: 'Kokoro', text: 'I\'m trying, but these infernals keep coming from everywhere!', audio: 'res/img/raid/sounds/kokoro_infernals.mp3' },
        { character: 'Siegfried', text: 'Ibuki? What happened to you?',  audio: 'res/img/raid/sounds/siegfried_happened.mp3' },
        { character: 'Ibuki', text: 'Save your words, Siegfried. The infernals have shown me the true path. I am now their servant, an Infernal Ninja!', showIbuki: true,  audio: 'res/img/raid/sounds/ibuki_ninja.wav' },
        { character: 'Kokoro', text: 'Ibuki, snap out of it! This isn\'t you!', audio: 'res/img/raid/sounds/kokoro_snapout.mp3' },
        { character: 'Ibuki', text: 'Foolish humans. You think your pleas can sway me? Prepare to be eradicated!',  audio: 'res/img/raid/sounds/ibuki_foolish.wav' },
        { character: 'Siegfried', text: 'We have to subdue her without hurting her!', audio: 'res/img/raid/sounds/siegfried_subdue.mp3' },
        { character: 'Kokoro', text: 'Easier said than done! Her speed and strength have increased tenfold!', audio: 'res/img/raid/sounds/kokoro_tenfold.mp3' },
        { character: 'Ibuki', text: 'You won\'t succeed! The infernals\' power flows through me!',  audio: 'res/img/raid/sounds/ibuki_power.wav' }
    ];

    let currentStep = 0;

    function showNextChat() {
        if (currentStep < conversation.length) {
            const { character, text, showIbuki, audio } = conversation[currentStep];
            let chatBubble;

            if (character === 'Siegfried') {
                chatBubble = siegfriedChat;
                if (audio && userInteracted) {
                    const audioElement = new Audio(audio);
                    audioElement.play();
                }
            } else if (character === 'Kokoro') {
                chatBubble = kokoroChat;
                if (audio && userInteracted) {
                    const audioElement = new Audio(audio);
                    audioElement.play();
                }
            } else if (character === 'Ibuki') {
                chatBubble = ibukiChat;
                if (showIbuki) {
                    ibukiElement.style.display = 'inline-block';
                }
                if (audio && userInteracted) {
                    const audioElement = new Audio(audio);
                    audioElement.play();
                }
            }

            chatBubble.innerHTML = `<div>${text.replace(/\n/g, '<br>')}</div>`;
            chatBubble.style.display = 'flex';

            setTimeout(() => {
                chatBubble.style.display = 'none';
                currentStep++;
                showNextChat();
            }, currentStep === 3 ? 6500 : 4500); // Adjust the delay for the specific line
        } else {
            startGameLogic();
        }
    }

    showNextChat();
}

    function startGameLogic() {
        const ibukiElement = document.getElementById('Ibuki');
        ibukiElement.style.display = 'inline-block';

        // Enable all interactions
        const abilityIcons = document.querySelectorAll('.ability-icons img');
        abilityIcons.forEach(icon => {
            icon.classList.remove('disabled');
        });

        // Continue with any other game initialization logic
        ibukiTurn();
    }


    let ibukiHp = 10555;
	const maxIbukiHp = 10555;
    let turnCounter = 1;
    let lastDamageReceived = 0;
    let ibukiImmuneTurns = 0;
    let siegfriedBuffTurns = 0;
    let kokoroBuffTurns = 0;
    let siegfriedAbility3Turns = 0;
	let siegfriedAbility3Cooldown = 0;
	let siegfriedAbility4Cooldown = 0;
	let kokoroAbility4Cooldown = 0;
	let kokoroAbility3Cooldown = 0;
	let kokoroAbility2Cooldown = 0;
	let ibukiDebuffTurns = 0;
	let siegfriedAbility2Cooldown = 0;
	let siegfriedA2BuffTurns = 0;
	
function scrollToBottom() {
    const log = document.getElementById('log');
    log.scrollTop = log.scrollHeight;
}
	
function updateCooldowns() {
    if (siegfriedAbility4Cooldown > 0) siegfriedAbility4Cooldown--;
    if (kokoroAbility4Cooldown > 0) kokoroAbility4Cooldown--;
    if (siegfriedAbility3Cooldown > 0) siegfriedAbility3Cooldown--;
    if (kokoroAbility3Cooldown > 0) kokoroAbility3Cooldown--;
    if (kokoroAbility2Cooldown > 0) kokoroAbility2Cooldown--;
	if (siegfriedAbility2Cooldown > 0) siegfriedAbility2Cooldown--;

    updateAbilityIcon('siegfriedAbility4', siegfriedAbility4Cooldown);
    updateAbilityIcon('kokoroAbility4', kokoroAbility4Cooldown);
    updateAbilityIcon('siegfriedAbility3', siegfriedAbility3Cooldown);
    updateAbilityIcon('kokoroAbility3', kokoroAbility3Cooldown);
    updateAbilityIcon('kokoroAbility2', kokoroAbility2Cooldown);
}

function updateAbilityIcon(abilityId, cooldown) {
    const abilityIcon = document.getElementById(abilityId);
    if (abilityIcon) { // Check if element exists
        if (cooldown > 0) {
            abilityIcon.classList.add('cooldown');
            abilityIcon.innerText = `Cooldown: ${cooldown}`;  // Optionally show the remaining turns
        } else {
            abilityIcon.classList.remove('cooldown');
            abilityIcon.innerText = '';  // Clear the cooldown text
        }
    }
}

function updateAbilityIcon(abilityId, cooldown) {
    const abilityIcon = document.getElementById(abilityId);
    if (abilityIcon) { // Check if element exists
        if (cooldown > 0) {
            abilityIcon.classList.add('cooldown');
            abilityIcon.innerText = `Cooldown: ${cooldown}`;  // Optionally show the remaining turns
        } else {
            abilityIcon.classList.remove('cooldown');
            abilityIcon.innerText = '';  // Clear the cooldown text
        }
    }
}

function siegfriedHealAndBuff() {
    if (siegfriedAbility2Cooldown > 0) return; // Prevent usage if on cooldown

    siegfriedAbility2Cooldown = 6; // Set cooldown

    const statusElement = document.getElementById('Siegfried-status');
    let currentHp = parseInt(statusElement.innerText.split('/')[0].split(': ')[1]);
    const maxHp = parseInt(statusElement.innerText.split('/')[1]);

    const missingHealth = maxHp - currentHp;
    const healAmount = Math.floor(missingHealth * 0.3);
    currentHp += healAmount;
    if (currentHp > maxHp) currentHp = maxHp;

    statusElement.innerText = `HP: ${currentHp}/${maxHp}`;

    // Flash green on heal
    const characterImage = document.querySelector('#Siegfried img');
    characterImage.classList.add('flash-green');
    setTimeout(() => {
        characterImage.classList.remove('flash-green');
    }, 500);
    
    // Show chat bubble
    const siegfriedChat = document.getElementById('Siegfried-chat');
    siegfriedChat.innerHTML = `<div>I must...Stay...STRONG!</div>`;
    siegfriedChat.style.display = 'flex';

    // Play audio
    const audio = new Audio('res/img/raid/sounds/siegfrieda2.mp3');
    audio.play();

    setTimeout(() => {
        siegfriedChat.style.display = 'none';
    }, 1000); // Adjust the delay as needed

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: green;">Siegfried used Healing Light and healed by ${healAmount} HP!</span>`;
    log.appendChild(logEntry);

    // Apply the buff
    siegfriedA2BuffTurns = 3;
    const buffContainer = document.getElementById('Siegfried-buff-container');
    const buffIcon = document.createElement('img');
    buffIcon.src = 'res/img/raid/siegfrieda2.jfif'; // Add the appropriate image for the buff
    buffIcon.classList.add('buff-icon');
    buffIcon.style.display = 'inline'; // Show the buff icon
    buffContainer.appendChild(buffIcon);

    const buffLogEntry = document.createElement('p');
    buffLogEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: red;">Siegfried receives a buff! He will take 30% less damage for 3 turns.</span>`;
    log.appendChild(buffLogEntry);

    // Proceed to Ibuki's turn
    ibukiTurn();
}


function kokoroHealAll() {
    if (kokoroAbility3Cooldown > 0) return; // Prevent usage if on cooldown

    kokoroAbility3Cooldown = 4; // Set cooldown

    const allies = document.querySelectorAll('#allies .character');
    allies.forEach(ally => {
        healCharacterDirectly(ally.id, 870);
    });

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: green;">Kokoro used Healing Light and healed all allies by 870 HP!</span>`;
    log.appendChild(logEntry);
    scrollToBottom(); // Scroll to bottom

    // Show chat bubble
    const kokoroChat = document.getElementById('Kokoro-chat');
    kokoroChat.innerHTML = `<div>Got your back!</div>`;
    kokoroChat.style.display = 'flex';
	
	// Play audio
    const audio = new Audio('res/img/raid/sounds/kokoroa3.mp3');
    audio.play();
	
	const audio2 = new Audio('res/img/raid/sounds/kokoroa3sfx.mp3');
    audio2.play();

    setTimeout(() => {
        kokoroChat.style.display = 'none';
        // Proceed to Ibuki's turn
        ibukiTurn();
    }, 1000); // Adjust the delay as needed

    // Proceed to Ibuki's turn
    ibukiTurn();
}

function kokoroDebuff() {
    if (kokoroAbility2Cooldown > 0) return; // Prevent usage if on cooldown

    kokoroAbility2Cooldown = 4; // Set cooldown
    ibukiDebuffTurns = 3;

    const buffContainer = document.getElementById('Ibuki-buff-container');
    const debuffIcon = document.createElement('img');
    debuffIcon.src = 'res/img/raid/kokoroa2.jfif'; // Add the appropriate image for the debuff
    debuffIcon.classList.add('buff-icon');
    debuffIcon.style.display = 'inline'; // Show the debuff icon
    buffContainer.appendChild(debuffIcon);
	
	// Show chat bubble
    const kokoroChat = document.getElementById('Kokoro-chat');
    kokoroChat.innerHTML = `<div>Silence!</div>`;
    kokoroChat.style.display = 'flex';
	
	// Play audio
    const audio = new Audio('res/img/raid/sounds/kokoroa2.mp3');
    audio.play();

    setTimeout(() => {
        kokoroChat.style.display = 'none';
        // Proceed to Ibuki's turn
        ibukiTurn();
    }, 700); // Adjust the delay as needed

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: blue;">Kokoro used her ability! Ibuki will deal 50% less damage for 3 turns.</span>`;
    log.appendChild(logEntry);

    // Proceed to Ibuki's turn
    ibukiTurn();
}

function siegfriedAbility3() {
    if (siegfriedAbility3Cooldown > 0) return; // Prevent usage if on cooldown

    siegfriedAbility3Cooldown = 5; // Set cooldown
    siegfriedAbility3Turns = 3; // Set the duration for damage

    const buffContainer = document.getElementById('Ibuki-buff-container');
    const buffIcon = document.createElement('img');
    buffIcon.src = 'res/img/raid/siegfrieda3.jfif';
    buffIcon.classList.add('buff-icon');
    buffIcon.style.display = 'inline'; // Show the buff icon
    buffContainer.appendChild(buffIcon);

    // Show chat bubble
    const siegfriedChat = document.getElementById('Siegfried-chat');
    siegfriedChat.innerHTML = `<div>It's over!.</div>`;
    siegfriedChat.style.display = 'flex';

    // Play audio
    const audio = new Audio('res/img/raid/sounds/siegfrieda3.mp3');
    audio.play();

    setTimeout(() => {
        siegfriedChat.style.display = 'none';
    }, 1000); // Adjust the delay as needed

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: red;">Siegfried activated Spinning Blade! Ibuki will take 450 damage for the next 3 turns.</span>`;
    log.appendChild(logEntry);

    // Proceed to Ibuki's turn
    ibukiTurn();
}

function applyReflectiveDamage() {
    if (siegfriedAbility3Turns > 0) {
        const damage = 450; // Set the damage per turn
        ibukiHp -= damage;
        if (ibukiHp < 0) ibukiHp = 0;
        document.getElementById('Ibuki-status').innerText = `HP: ${ibukiHp}/${maxIbukiHp}`;

        const hpPercentage = (ibukiHp / maxIbukiHp) * 100;
        document.getElementById('Ibuki-hp-bar').style.width = `${hpPercentage}%`;

        const log = document.getElementById('log');
        const logEntry = document.createElement('p');
        logEntry.innerText = `Ibuki took ${damage} damage from Siegfried's Spinning Blade!`;
        log.appendChild(logEntry);

        siegfriedAbility3Turns--; // Decrement the turn counter

        if (siegfriedAbility3Turns === 0) {
            const buffContainer = document.getElementById('Ibuki-buff-container');
            const siegfriedReflectiveShieldIcon = buffContainer.querySelector('img[src="res/img/raid/siegfrieda3.jfif"]');
            if (siegfriedReflectiveShieldIcon) {
                buffContainer.removeChild(siegfriedReflectiveShieldIcon);
            }
        }
    }
}

function ibukiAbility1() {
    const damageType = Math.random() < 0.5;
    let damage = damageType ? 250 : 500;
	
	// Play audio
    const audio = new Audio('res/img/raid/sounds/kunaitoss.mp3');
    audio.play();

    if (ibukiDebuffTurns > 0) {
        damage = Math.floor(damage / 2);
    }

    if (damageType) {
        // Deal 500 damage to both Kokoro and Siegfried
        updateCharacterStatus('Siegfried', damage);
        updateCharacterStatus('Kokoro', damage);

        const log = document.getElementById('log');
        const logEntry = document.createElement('p');
        logEntry.innerText = `Ibuki used Double Kunai on two targets!`;
        log.appendChild(logEntry);
    } else {
        // Deal 1000 damage to either Siegfried or Kokoro
        const target = Math.random() < 0.5 ? 'Siegfried' : 'Kokoro';
        updateCharacterStatus(target, damage);

        const log = document.getElementById('log');
        const logEntry = document.createElement('p');
        logEntry.innerText = `Ibuki used Double Kunai on ${target}!`;
        log.appendChild(logEntry);
    }
}

function ibukiAbility2() {
    const damage = 455;
	
	// Play audio
    const audio = new Audio('res/img/raid/sounds/kunaitoss.mp3');
    audio.play();

    if (ibukiDebuffTurns > 0) {
        damage = Math.floor(damage / 2);
    }

    const target = Math.random() < 0.5 ? 'Siegfried' : 'Kokoro';
    updateCharacterStatus(target, damage);

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerText = `Ibuki used Long Kunai on ${target}!`;
    log.appendChild(logEntry);
}

function ibukiAbility3() {
    let damage = lastDamageReceived * 1.2;
	
	// Play audio
    const audio = new Audio('res/img/raid/sounds/kunaitoss.mp3');
    audio.play();
	
    if (damage < 300) {
        damage = 300;
    }

    if (ibukiDebuffTurns > 0) {
        damage = Math.floor(damage / 2);
    }

    const target = Math.random() < 0.5 ? 'Siegfried' : 'Kokoro';
    updateCharacterStatus(target, damage);

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerText = `Ibuki used Revenge Attack on ${target}!`;
    log.appendChild(logEntry);
}

function ibukiAbility4() {

	// Play audio
    const audio = new Audio('res/img/raid/sounds/smoke.mp3');
    audio.play();
	
    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerText = `Ibuki used Hide in Shadows and is immune to damage for 1 turn!`;
    log.appendChild(logEntry);

    ibukiImmuneTurns = 1;
    document.getElementById('Ibuki').style.filter = 'hue-rotate(180deg)'; // Change image color to blue
}

function ibukiTurn() {
    // Apply reflective damage from Siegfried's third ability
    applyReflectiveDamage();

    // Decrement immunity turns at the start of each turn
    if (ibukiImmuneTurns > 0) {
        ibukiImmuneTurns--;
        if (ibukiImmuneTurns === 0) {
            document.getElementById('Ibuki').style.filter = 'none'; // Revert image color
        }
    }

    // Decrement Kokoro's buff turns
    if (kokoroBuffTurns > 0) {
        kokoroBuffTurns--;
        if (kokoroBuffTurns === 0) {
            document.querySelectorAll('#allies .character').forEach(ally => {
                ally.classList.remove('buffed');
                const buffContainer = ally.querySelector('.buff-container');
                const kokoroBuffIcon = buffContainer.querySelector('img[src="res/img/raid/kokoroa4.jfif"]');
                if (kokoroBuffIcon) {
                    buffContainer.removeChild(kokoroBuffIcon);
                }
            });
            const kokoro = document.getElementById('Kokoro');
            if (kokoro) {
                kokoro.classList.remove('buffed');
                const kokoroBuffContainer = kokoro.querySelector('.buff-container');
                const kokoroBuffIcon = kokoroBuffContainer.querySelector('img[src="res/img/raid/kokoroa4.jfif"]');
                if (kokoroBuffIcon) {
                    kokoroBuffContainer.removeChild(kokoroBuffIcon);
                }
            }
        }
    }

    // Decrement Siegfried's buff turns
    if (siegfriedBuffTurns > 0) {
        siegfriedBuffTurns--;
        if (siegfriedBuffTurns === 0) {
            const buffContainer = document.getElementById('Siegfried-buff-container');
            const siegfriedBuffIcon = buffContainer.querySelector('img[src="res/img/raid/siegfrieda4.jfif"]');
            if (siegfriedBuffIcon) {
                buffContainer.removeChild(siegfriedBuffIcon);
            }
        }
    }

    // Decrement Siegfried's Reflective Shield turns
    if (siegfriedAbility3Turns > 0) {
        siegfriedAbility3Turns--;
        if (siegfriedAbility3Turns === 0) {
            const buffContainer = document.getElementById('Ibuki-buff-container');
            const siegfriedReflectiveShieldIcon = buffContainer.querySelector('img[src="res/img/raid/siegfrieda3.jfif"]');
            if (siegfriedReflectiveShieldIcon) {
                buffContainer.removeChild(siegfriedReflectiveShieldIcon);
            }
        }
    }

    // Decrement Ibuki's debuff turns
    if (ibukiDebuffTurns > 0) {
        ibukiDebuffTurns--;
        if (ibukiDebuffTurns === 0) {
            const buffContainer = document.getElementById('Ibuki-buff-container');
            const ibukiDebuffIcon = buffContainer.querySelector('img[src="res/img/raid/kokoroa2.jfif"]');
            if (ibukiDebuffIcon) {
                buffContainer.removeChild(ibukiDebuffIcon);
            }
        }
    }
	

    // Additional code for Ibuki's turn logic
    switch (turnCounter) {
        case 1:
        case 3:
        case 8:
        case 12:
        case 13:
        case 14:
        case 15:
        case 16:
        case 17:
        case 18:
        case 21:
        case 22:
        case 23:
        case 24:
        case 25:
        case 27:
        case 29:
        case 31:
        case 32:
        case 34:
        case 36:
        case 37:
        case 38:
        case 39:
        case 41:
        case 42:
        case 43:
        case 45:
        case 46:
        case 47:
        case 48:
            useRandomAbility();
            break;
        case 2:
            ibukiAbility3();
            break;
        case 4:
        case 5:
        case 9:
            ibukiAbility1();
            break;
        case 6:
        case 11:
        case 19:
        case 26:
        case 28:
        case 33:
        case 44:
            ibukiAbility4();
            break;
        case 7:
            ibukiAbility2();
            break;
        case 10:
        case 20:
        case 30:
        case 40:
        case 50:
            healIbuki();
            break;
        case 65:
            endGame();
            break;
        default:
            useRandomAbility();
            break;
    }

    // Update turn counter after Ibuki's action
    turnCounter++;
    document.getElementById('turn-counter').innerText = `Turn: ${turnCounter}`;
	
	// Call updateCooldowns at the end of Ibuki's turn
    updateCooldowns();
}

function useRandomAbility() {
    const abilities = [ibukiAbility1, ibukiAbility2, ibukiAbility3];
    const randomAbility = abilities[Math.floor(Math.random() * abilities.length)];
    randomAbility();
}

function healIbuki() {
    ibukiHp += 1300;
    if (ibukiHp > 10550) ibukiHp = 10550;
    document.getElementById('Ibuki-status').innerText = `HP: ${ibukiHp}/10550`;

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerText = `The flames healed Ibuki, restoring 1985 HP to her!`;
    log.appendChild(logEntry);
}

function endGame() {
    alert("The player lost, the page will reload.");
    location.reload();
}

function showHealIcons() {
    const healIcons = document.getElementById('heal-icons');
    healIcons.style.display = 'flex';
    setTimeout(() => {
        healIcons.style.display = 'none'; // Hide the icons after a delay if needed
    }, 5000); // Adjust the time as per requirement
}


function healCharacterDirectly(character, healAmount) {
    const statusElement = document.getElementById(`${character}-status`);
    let currentHp = parseInt(statusElement.innerText.split('/')[0].split(': ')[1]);
    const maxHp = parseInt(statusElement.innerText.split('/')[1]);

    currentHp += healAmount;
    if (currentHp > maxHp) currentHp = maxHp;

    statusElement.innerText = `HP: ${currentHp}/${maxHp}`;

    // Flash green on heal
    const characterImage = document.querySelector(`#${character} img`);
    characterImage.classList.add('flash-green');
    setTimeout(() => {
        characterImage.classList.remove('flash-green');
    }, 500);

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerText = `${character} was healed by ${healAmount} HP!`;
    log.appendChild(logEntry);
    scrollToBottom(); // Scroll to bottom
}

function healCharacter(character) {
    const healAmount = 1350;
    const statusElement = document.getElementById(`${character}-status`);
    let currentHp = parseInt(statusElement.innerText.split('/')[0].split(': ')[1]);
    const maxHp = parseInt(statusElement.innerText.split('/')[1]);

    if (currentHp === 0) {
        const log = document.getElementById('log');
        const logEntry = document.createElement('p');
        logEntry.innerText = `${character} cannot be healed because they are defeated!`;
        log.appendChild(logEntry);
        scrollToBottom(); // Scroll to bottom
        return;
    }

    currentHp += healAmount;
    if (currentHp > maxHp) currentHp = maxHp;

    statusElement.innerText = `HP: ${currentHp}/${maxHp}`;

    // Flash green on heal
    const characterImage = document.querySelector(`#${character} img`);
    characterImage.classList.add('flash-green');
    setTimeout(() => {
        characterImage.classList.remove('flash-green');
    }, 500);

    // Show chat bubble
    const kokoroChat = document.getElementById('Kokoro-chat');
    kokoroChat.innerHTML = `<div>Here's a little help!</div>`;
    kokoroChat.style.display = 'flex';

    // Play audio
    const audio = new Audio('res/img/raid/sounds/kokoroa1.mp3');
    audio.play();
	
	const audio2 = new Audio('res/img/raid/sounds/kokoroa1sfx.mp3');
    audio2.play();

    setTimeout(() => {
        kokoroChat.style.display = 'none';
        // Proceed to Ibuki's turn
        ibukiTurn();
    }, 1000); // Adjust the delay as needed

    document.getElementById('heal-icons').style.display = 'none';

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerText = `${character} was healed by ${healAmount} HP!`;
    log.appendChild(logEntry);

    // Proceed to Ibuki's turn
    ibukiTurn();
}

function siegfriedBuff() {
    if (siegfriedAbility4Cooldown > 0) return; // Prevent usage if on cooldown

    siegfriedAbility4Cooldown = 8; // Set cooldown
    siegfriedBuffTurns = 4;
    const buffContainer = document.getElementById('Siegfried-buff-container');
    const buffIcon = document.createElement('img');
    buffIcon.src = 'res/img/raid/siegfrieda4.jfif';
    buffIcon.classList.add('buff-icon');
    buffIcon.style.display = 'inline'; // Show the buff icon
    buffContainer.appendChild(buffIcon);
	
	// Show chat bubble
    const siegfriedChat = document.getElementById('Siegfried-chat');
    siegfriedChat.innerHTML = `<div>It's time...</div>`;
    siegfriedChat.style.display = 'flex';

    // Play audio
    const audio = new Audio('res/img/raid/sounds/siegfrieda4.mp3');
    audio.play();

    setTimeout(() => {
        siegfriedChat.style.display = 'none';
    }, 1000); // Adjust the delay as needed

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: red;">Siegfried activated Blessed Sword! He will deal 3x damage and heal for 50% of damage dealt for 4 turns.</span>`;
    log.appendChild(logEntry);

    // Proceed to Ibuki's turn
    ibukiTurn();
}

function kokoroBuff() {
    if (kokoroAbility4Cooldown > 0) return; // Prevent usage if on cooldown

    kokoroAbility4Cooldown = 8; // Set cooldown
    kokoroBuffTurns = 4;

    const allies = document.querySelectorAll('#allies .character');
    allies.forEach(ally => {
        ally.classList.add('buffed');
        const buffContainer = ally.querySelector('.buff-container');
        const buffIcon = document.createElement('img');
        buffIcon.src = 'res/img/raid/kokoroa4.jfif';
        buffIcon.classList.add('buff-icon');
        buffIcon.style.display = 'inline'; // Show the buff icon
        buffContainer.appendChild(buffIcon);
    });
	
	// Show chat bubble
    const kokoroChat = document.getElementById('Kokoro-chat');
    kokoroChat.innerHTML = `<div>Keep up!</div>`;
    kokoroChat.style.display = 'flex';
	
	// Play audio
    const audio = new Audio('res/img/raid/sounds/kokoro_keepup.mp3');
    audio.play();

    setTimeout(() => {
        kokoroChat.style.display = 'none';
        // Proceed to Ibuki's turn
        ibukiTurn();
    }, 750); // Adjust the delay as needed

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: red;">Kokoro activated her buff! All allies will take 50% less damage for 4 turns.</span>`;
    log.appendChild(logEntry);

    // Proceed to Ibuki's turn
    ibukiTurn();
}



function Slash(character, ability) {
    let damage = 500;

    // Play audio
    const audio = new Audio('res/img/raid/sounds/siegfrieda1.mp3');
    audio.play();
    const audio2 = new Audio('res/img/raid/sounds/siegfrieda1sfx.mp3');
    audio2.play();

    if (character === 'Siegfried' && siegfriedBuffTurns > 0) {
        damage *= 3;
        const healAmount = damage * 0.5;
        healCharacterDirectly(character, healAmount);
        siegfriedBuffTurns--;
        if (siegfriedBuffTurns === 0) {
            const buffContainer = document.getElementById('Siegfried-buff-container');
            while (buffContainer.firstChild) {
                buffContainer.removeChild(buffContainer.firstChild);
            }
        }
    }

    if (ibukiImmuneTurns > 0) {
        const log = document.getElementById('log');
        const logEntry = document.createElement('p');
        logEntry.innerText = `Ibuki is immune to damage! Slash had no effect.`;
        log.appendChild(logEntry);
    } else {
        ibukiHp -= damage;
        if (ibukiHp < 0) ibukiHp = 0;
        document.getElementById('Ibuki-status').innerText = `HP: ${ibukiHp}/${maxIbukiHp}`;

        const hpPercentage = (ibukiHp / maxIbukiHp) * 100;
        document.getElementById('Ibuki-hp-bar').style.width = `${hpPercentage}%`;

        lastDamageReceived = damage; // Store the damage dealt to Ibuki

        // Flash red on damage
        const ibukiImage = document.querySelector('#Ibuki img');
        ibukiImage.classList.add('flash-red');
        setTimeout(() => {
            ibukiImage.classList.remove('flash-red');
        }, 500);

        const log = document.getElementById('log');
        const logEntry = document.createElement('p');
        logEntry.innerText = `Siegfried used Slash and dealt ${damage} damage to Ibuki!`;
        log.appendChild(logEntry);

        // Check if Ibuki's HP is 0 to call the post defeat function
        if (ibukiHp === 0) {
            postIbukiDefeatConversation();
        }
    }

    // Proceed to Ibuki's turn
    ibukiTurn();
}

function healCharacterDirectly(character, healAmount) {
    const statusElement = document.getElementById(`${character}-status`);
    let currentHp = parseInt(statusElement.innerText.split('/')[0].split(': ')[1]);
    const maxHp = parseInt(statusElement.innerText.split('/')[1]);

    if (currentHp === 0) {
        const log = document.getElementById('log');
        const logEntry = document.createElement('p');
        logEntry.innerText = `${character} cannot be healed because they are defeated!`;
        log.appendChild(logEntry);
        scrollToBottom(); // Scroll to bottom
        return;
    }

    currentHp += healAmount;
    if (currentHp > maxHp) currentHp = maxHp;

    statusElement.innerText = `HP: ${currentHp}/${maxHp}`;

    // Flash green on heal
    const characterImage = document.querySelector(`#${character} img`);
    characterImage.classList.add('flash-green');
    setTimeout(() => {
        characterImage.classList.remove('flash-green');
    }, 500);

    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerText = `${character} healed by ${healAmount} HP!`;
    log.appendChild(logEntry);
    scrollToBottom(); // Scroll to bottom
}

// Function to update the HP status and HP bar
function updateCharacterStatus(character, damage) {
    const statusElement = document.getElementById(`${character}-status`);
    const hpBarElement = document.getElementById(`${character}-hp-bar`);
    let currentHp = parseInt(statusElement.innerText.split('/')[0].split(': ')[1]);
    const maxHp = parseInt(statusElement.innerText.split('/')[1]);

    currentHp -= damage;
    if (currentHp < 0) currentHp = 0;

    statusElement.innerText = `HP: ${currentHp}/${maxHp}`;

    // Update the width of the HP bar
    const hpPercentage = (currentHp / maxHp) * 100;
    hpBarElement.style.width = `${hpPercentage}%`;

    // Check if the character's HP is 0
    if (currentHp === 0 && character === 'Ibuki') {
        postIbukiDefeatConversation();
    }

    // Flash red on damage
    const characterImage = document.querySelector(`#${character} img`);
    characterImage.classList.add('flash-red');
    setTimeout(() => {
        characterImage.classList.remove('flash-red');
    }, 500);

    // Log the actual damage taken
    const log = document.getElementById('log');
    const logEntry = document.createElement('p');
    logEntry.innerHTML = `<span style="color: yellow;">Turn ${turnCounter}:</span> <span style="color: red;">${character} took ${damage} damage!</span>`;
    log.appendChild(logEntry);
    scrollToBottom(); // Scroll to bottom
}

function endGame() {
            alert("The player lost, the page will reload.");
            location.reload();
        }

        function postIbukiDefeatConversation() {
            const siegfriedChat = document.getElementById('Siegfried-chat');
            const kokoroChat = document.getElementById('Kokoro-chat');
            const ibukiChat = document.getElementById('Ibuki-chat');
            const abilityIcons = document.querySelectorAll('.ability-icons img');
            bgAudio.pause();

            // Disable all ability icons
            abilityIcons.forEach(icon => {
                icon.classList.add('disabled');
            });

            const conversation = [
                { character: 'Siegfried', text: 'She is down....', audio: 'res/img/raid/sounds/siegfried_victory.mp3' },
                { character: 'Kokoro', text: 'Do you think she.....I hope she\'ll be okay once she wakes up.', audio: 'res/img/raid/sounds/kokoro_concern.mp3' },
                { character: 'Siegfried', text: 'I\'ll go and look for the others. You should stay with her.', audio: 'res/img/raid/sounds/siegfried_prep.mp3' }
            ];

            let currentStep = 0;

            function showNextChat() {
                if (currentStep < conversation.length) {
                    const { character, text, audio } = conversation[currentStep];
                    let chatBubble;

                    if (character === 'Siegfried') {
                        chatBubble = siegfriedChat;
                        if (audio && userInteracted) {
                            const audioElement = new Audio(audio);
                            audioElement.play();
                        }
                    } else if (character === 'Kokoro') {
                        chatBubble = kokoroChat;
                        if (audio && userInteracted) {
                            const audioElement = new Audio(audio);
                            audioElement.play();
                        }
                    }

                    chatBubble.innerHTML = `<div>${text.replace(/\n/g, '<br>')}</div>`;
                    chatBubble.style.display = 'flex';

                    setTimeout(() => {
                        chatBubble.style.display = 'none';
                        currentStep++;
                        showNextChat();
                    }, 4500); // Adjust the delay as needed
                } else {
                    document.getElementById('stage2-button').style.display = 'block';
                    updateStageCompletion(); // Update the database when the button appears
                }
            }

            showNextChat();
        }

        // HTML updates to add the Stage 2 button
        document.body.innerHTML += '<button id="stage2-button" onclick="location.href=\'Stage_2.html\'">Go to Stage 2</button>';
    </script>

</body>
</html>
