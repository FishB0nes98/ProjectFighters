<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project Fighters - Battle Pass</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00a8ff;
            --secondary-color: #ff9f1a;
            --background-dark: #1a1a1a;
            --text-color: #ffffff;
            --progress-bar-height: 2px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: var(--background-dark);
            color: var(--text-color);
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
        }

        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            filter: brightness(0.4);
        }

        /* Keep existing menu styles */
        .menu {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2;
            position: relative;
        }

        .menu-items {
            display: flex;
            justify-content: center;
            position: relative;
        }

        .menu a {
            color: white;
            text-decoration: none;
            padding: 14px 16px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            transition: all 0.3s;
        }

        .menu a:hover {
            background-color: #111;
            transform: scale(1.1);
        }

        /* Keep existing play button styles */
        .play-button-container {
            display: flex;
            justify-content: flex-start;
            padding: 20px;
            z-index: 2;
            position: fixed;
        }

        .play-button {
            background-color: #ffbb00;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 22px;
            font-weight: bold;
            text-decoration: none;
            padding: 15px 40px;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .play-button:hover {
            background-color: #ff8800;
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* New Battle Pass Styles */
        .battlepass-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .battlepass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .battlepass-progress {
            flex-grow: 1;
            margin: 0 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: var(--progress-bar-height);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
        }

        .progress-info img {
            border: 2px solid var(--secondary-color);
            box-shadow: 0 0 10px rgba(255, 159, 26, 0.3);
        }

        .progress-info span {
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        #battlepass-exp {
            color: var(--secondary-color);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid rgba(255, 159, 26, 0.3);
        }

        .battlepass-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .battlepass-item {
            position: relative;
            background: rgba(30, 30, 30, 0.9);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
            overflow: hidden;
        }

        .battlepass-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .battlepass-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .item-info {
            text-align: center;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-exp {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .locked-item {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .locked-item::after {
            content: 'ðŸ”’';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
        }

        .claimed-item::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
        }

        .currency-icon {
            width: 24px;
            height: 24px;
        }

        .buy-pass-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .buy-pass-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 300px;
        }

        .modal-btn {
            margin: 10px;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--secondary-color);
            color: white;
        }

        .modal-btn.cancel {
            background: #ff4757;
            color: white;
        }

        .modal-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
    </style>
</head>
<body>
    <!-- Keep existing menu -->
    <div class="menu">
        <div class="menu-items">
            <a href="home.html">Home</a>
            <a href="Store.html">Store</a>
            <a href="event.html">Event</a>
            <a href="Team Builder.html">Team Builder</a>
            <a href="statistics.html">Statistics</a>
        </div>
    </div>

    <!-- Keep existing play button -->
    <div class="play-button-container">
        <a href="Game Modes.html" class="play-button">Play</a>
    </div>

    <!-- Video Background -->
    <video id="video-background" autoplay muted loop>
        <source src="Event/Eventvideo.mp4" type="video/mp4">
    </video>

    <!-- New Battle Pass Content -->
    <div class="battlepass-container">
        <div class="battlepass-header">
            <div class="currency-display">
                <img src="res/img/fm.png" alt="FM" class="currency-icon">
                <span id="currency-amount">0</span>
                <img src="res/img/cm.png" alt="CM" class="currency-icon">
                <span id="currency-amount-cm">0</span>
            </div>
            <div class="battlepass-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="bp-progress-bar"></div>
                </div>
                <div class="progress-info">
                    <span id="current-level">Level 1</span>
                    <span id="battlepass-exp">0 / 11500 BP Exp</span>
                </div>
            </div>
            <button class="buy-pass-btn" onclick="buyBattlepass()">Buy Battle Pass</button>
        </div>

        <div class="battlepass-grid" id="battle-pass-container">
            <!-- Items will be dynamically added here -->
        </div>
    </div>

    <!-- Buy Modal -->
    <div id="buy-battlepass-modal" class="modal">
        <div class="modal-content">
            <h2>Buy Battle Pass</h2>
            <p>Choose your payment method:</p>
            <button id="buy-with-fm" class="modal-btn primary">3,000 FM</button>
            <button id="buy-with-cm" class="modal-btn secondary">100,000 CM</button>
            <button id="cancel-purchase" class="modal-btn cancel">Cancel</button>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqhxq6sPDU3EmuvvkBIIDJ-H6PsBc42Jg",
            authDomain: "project-fighters-by-fishb0nes.firebaseapp.com",
            databaseURL: "https://project-fighters-by-fishb0nes-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-fighters-by-fishb0nes",
            storageBucket: "project-fighters-by-fishb0nes.appspot.com",
            messagingSenderId: "867339299995",
            appId: "1:867339299995:web:99c379940014b9c05cea3e",
            measurementId: "G-LNEM6HR842"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        // Battle Pass Items (keep your existing items array)
        const battlePassItems = [
            { id: 'Item1', exp: 0, img: 'Skins/Lunar Festival Kokoro.jpg', skinName: 'Lunar Festival Kokoro', name: 'Lunar Festival Kokoro' },
            { id: 'Item2', exp: 30, img: 'res/img/music.png', songName: 'Moonlight (Lunar Festival Kokoro Theme)', name: 'Moonlight', type: 'Song' },
            { id: 'Item3', exp: 85, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item4', exp: 150, img: 'Icons/Profile/Lunar_Rabbit.jfif', rewardName: 'Lunar Rabbit', type: 'icon', name: 'Lunar Rabbit Icon' },
            { id: 'Item5', exp: 200, img: 'res/img/fm.png', name: '500 FM', type: 'FM' },
            { id: 'Item6', exp: 260, img: 'res/img/basicbox.png', folder: 'freelootbox', name: 'Free Lootbox' },
            { id: 'Item7', exp: 320, img: 'Stickers/lunar_rabbit.png', name: 'Lunar Rabbit Sticker', type: 'Sticker', stickerName: 'Lunar Rabbit' },
            { id: 'Item8', exp: 395, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item9', exp: 480, img: 'res/img/fm.png', name: '500 FM', type: 'FM' },
            { id: 'Item10', exp: 580, img: 'res/img/cm.png', name: '8000 CM', type: 'CM', amount: 8000 },
            { id: 'Item11', exp: 665, img: 'titles/titleimage.jpeg', name: 'Lantern Keeper', type: 'Title', titleName: 'Lantern Keeper' },
            { id: 'Item12', exp: 750, img: 'Skins/Lunar Festival Reptile.jpeg', skinName: 'Lunar Festival Reptile', name: 'Lunar Festival Reptile' },
            { id: 'Item13', exp: 835, img: 'res/img/fm.png', name: '500 FM', type: 'FM' },
            { id: 'Item14', exp: 910, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item15', exp: 1000, img: 'Skins/Lunar Festival Scorpion.jpeg', skinName: 'Lunar Festival Scorpion', name: 'Lunar Festival Scorpion' },
            { id: 'Item16', exp: 1300, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item17', exp: 1600, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item18', exp: 1900, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item19', exp: 2200, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item20', exp: 2500, img: 'Skins/Lunar Festival Kokoro Sweet.jpg', skinName: 'Lunar Festival Kokoro Sweet', name: 'Lunar Festival Kokoro Sweet' },
            { id: 'Item21', exp: 2800, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item22', exp: 3100, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item23', exp: 3400, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item24', exp: 3700, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item25', exp: 4000, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item26', exp: 4300, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item27', exp: 4600, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item28', exp: 4900, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item29', exp: 5200, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item30', exp: 5500, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item31', exp: 5800, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item32', exp: 6100, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item33', exp: 6400, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item34', exp: 6700, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item35', exp: 7000, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item36', exp: 7300, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item37', exp: 7600, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item38', exp: 7900, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item39', exp: 8200, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item40', exp: 8500, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item41', exp: 8800, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item42', exp: 9100, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item43', exp: 9400, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item44', exp: 9700, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item45', exp: 10000, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item46', exp: 10300, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item47', exp: 10600, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item48', exp: 10900, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item49', exp: 11200, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item50', exp: 11500, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item51', exp: 11800, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item52', exp: 12100, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item53', exp: 12400, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item54', exp: 12700, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item55', exp: 13000, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item56', exp: 13300, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item57', exp: 13600, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item58', exp: 13900, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item59', exp: 14200, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item60', exp: 14500, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item61', exp: 14800, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item62', exp: 15100, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item63', exp: 15400, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item64', exp: 15700, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item65', exp: 16000, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item66', exp: 16300, img: 'res/img/lunar_ticket.png', name: 'Lunar Ticket', type: 'LunarTicket', amount: 1 },
            { id: 'Item67', exp: 16600, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item68', exp: 16900, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item69', exp: 17200, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item70', exp: 17500, img: 'res/img/cm.png', name: '3500 CM', type: 'CM' },
            { id: 'Item71', exp: 17800, img: 'res/img/lunar_ticket.png', name: '2 Lunar Tickets', type: 'LunarTicket', amount: 2 }
        ];

        // Update progress bar
        function updateProgressBar(currentExp) {
            // Find the next item to unlock
            let nextItem = battlePassItems[0];
            let previousExp = 0;
            
            for (let item of battlePassItems) {
                if (item.exp > currentExp) {
                    nextItem = item;
                    break;
                }
                previousExp = item.exp;
            }

            // Calculate progress to next item
            const progressToNext = currentExp - previousExp;
            const totalNeededForNext = nextItem.exp - previousExp;
            const progress = (progressToNext / totalNeededForNext) * 100;

            // Update progress bar
            const progressBar = document.getElementById('bp-progress-bar');
            progressBar.style.width = `${Math.min(progress, 100)}%`;
            
            // Update progress info
            document.getElementById('current-level').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${nextItem.img}" alt="${nextItem.name}" style="width: 30px; height: 30px; border-radius: 5px;">
                    <span>Next: ${nextItem.name}</span>
                </div>`;
            document.getElementById('battlepass-exp').textContent = 
                `${progressToNext}/${totalNeededForNext} EXP to unlock`;
        }

        // Display Battle Pass items
        function displayBattlePass(userExp, claimedItems) {
            const container = document.getElementById('battle-pass-container');
            container.innerHTML = ''; // Clear existing items

            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    const userData = snapshot.exists() ? snapshot.val() : {};
                    const hasBattlepass = userData.hasBattlepass || false;

                    battlePassItems.forEach((item) => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'battlepass-item';
                        
                        if (!hasBattlepass || userExp < item.exp) {
                            itemElement.classList.add('locked-item');
                        } else if (claimedItems[item.id]) {
                            itemElement.classList.add('claimed-item');
                        }

                        itemElement.innerHTML = `
                            <img src="${item.img}" alt="${item.name}">
                            <div class="item-info">
                                <div class="item-name">${item.name}</div>
                                <div class="item-exp">${item.exp} BP Exp</div>
                            </div>
                        `;

                        if (hasBattlepass && userExp >= item.exp && !claimedItems[item.id]) {
                            itemElement.onclick = () => claimItem(item.id, item.img, item.exp, item.folder, item.skinName, item.type);
                        }

                        container.appendChild(itemElement);
                    });

                    // Update progress bar
                    updateProgressBar(userExp);
                });
            }
        }

        // Claim item function (keep your existing function)
        function claimItem(itemId, img, exp, folder, skinName, itemType) {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.BattlePassExp >= exp) {
                            const updates = {};
                            updates[`users/${userId}/BPprogress/${itemId}`] = 1;
                            
                            // Handle different reward types
                            if (folder) {
                                const fileName = img.split('/').pop().split('.')[0];
                                updates[`users/${userId}/${folder}/${fileName}`] = 1;
                            }
                            if (skinName) {
                                updates[`users/${userId}/skins/${skinName}`] = 1;
                            }
                            if (itemType === 'CM') {
                                updates[`users/${userId}/CM`] = (userData.CM || 0) + 3500;
                            }
                            if (itemType === 'FM') {
                                updates[`users/${userId}/FM`] = (userData.FM || 0) + 500;
                            }
                            if (itemType === 'Title') {
                                const titleName = battlePassItems.find(item => item.id === itemId)?.titleName;
                                if (titleName) {
                                    updates[`users/${userId}/titles/${titleName}`] = true;
                                }
                            }
                            if (itemType === 'LunarTicket') {
                                const item = battlePassItems.find(item => item.id === itemId);
                                if (item && item.amount) {
                                    updates[`users/${userId}/lunarTickets`] = (userData.lunarTickets || 0) + item.amount;
                                }
                            }
                            if (itemType === 'Song') {
                                const songName = battlePassItems.find(item => item.id === itemId)?.songName;
                                if (songName) {
                                    updates[`users/${userId}/Songs/${songName}`] = 1;
                                }
                            }

                            update(ref(database), updates).then(() => {
                                alert(`Claimed item: ${itemId}`);
                                location.reload();
                            }).catch((error) => {
                                console.error(error);
                            });
                        }
                    }
                }).catch((error) => {
                    console.error(error);
                });
            }
        }

        // Buy Battle Pass function (keep your existing function)
        window.buyBattlepass = function() {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const userFM = userData.FM || 0;
                        const userCM = userData.CM || 0;

                        // Show the modal dialog
                        const modal = document.getElementById('buy-battlepass-modal');
                        modal.style.display = 'block';

                        // Set up event listeners for the buttons
                        document.getElementById('buy-with-fm').onclick = () => {
                            if (userFM >= 3000) {
                                purchaseBattlepass(userId, 'FM', userFM - 3000);
                            } else {
                                alert("You don't have enough FM to purchase the battlepass.");
                            }
                            modal.style.display = 'none';
                        };

                        document.getElementById('buy-with-cm').onclick = () => {
                            if (userCM >= 100000) {
                                purchaseBattlepass(userId, 'CM', userCM - 100000);
                            } else {
                                alert("You don't have enough CM to purchase the battlepass.");
                            }
                            modal.style.display = 'none';
                        };

                        document.getElementById('cancel-purchase').onclick = () => {
                            modal.style.display = 'none';
                        };
                    }
                }).catch((error) => {
                    console.error(error);
                });
            }
        };

        // Add the missing purchaseBattlepass function
        function purchaseBattlepass(userId, currency, newAmount) {
            const updates = {};
            updates[`users/${userId}/${currency}`] = newAmount;
            updates[`users/${userId}/hasBattlepass`] = true;
            
            update(ref(database), updates).then(() => {
                alert('Battle Pass purchased successfully!');
                location.reload();
            }).catch((error) => {
                console.error('Error purchasing battle pass:', error);
                alert('Failed to purchase Battle Pass. Please try again.');
            });
        }

        // Initialize when auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const userExp = userData.BattlePassExp || 0;
                        const claimedItems = userData.BPprogress || {};
                        document.getElementById('currency-amount').textContent = userData.FM || 0;
                        document.getElementById('currency-amount-cm').textContent = userData.CM || 0;
                        
                        displayBattlePass(userExp, claimedItems);
                        
                        if (userData.hasBattlepass) {
                            document.querySelector('.buy-pass-btn').style.display = 'none';
                        }
                    }
                });
            } else {
                displayBattlePass(0, {});
            }
        });
    </script>
</body>
</html>