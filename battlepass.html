<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project Fighters - Monster Trainer Battle Pass</title>
    <link rel="icon" href="Icons/Profile/talim_desert.webp" type="image/webp">
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #e6b800;
            --secondary-color: #d17c06;
            --background-dark: #1a1a1a;
            --text-color: #ffffff;
            --progress-bar-height: 2px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: url('Event/Desert Wars.webp') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-color);
            font-family: 'Rajdhani', sans-serif;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at center, transparent 0%, rgba(0, 0, 0, 0.7) 100%);
            pointer-events: none;
            z-index: -1;
        }

        #video-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: -1;
            filter: brightness(0.4);
        }

        /* Keep existing menu styles */
        .menu {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px 20px;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2;
            position: relative;
        }

        .menu-items {
            display: flex;
            justify-content: center;
            position: relative;
        }

        .menu a {
            color: white;
            text-decoration: none;
            padding: 14px 16px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 16px;
            transition: all 0.3s;
        }

        .menu a:hover {
            background-color: #111;
            transform: scale(1.1);
        }

        /* Keep existing play button styles */
        .play-button-container {
            display: flex;
            justify-content: flex-start;
            padding: 20px;
            z-index: 2;
            position: fixed;
        }

        .play-button {
            background-color: #ffbb00;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 22px;
            font-weight: bold;
            text-decoration: none;
            padding: 15px 40px;
            transition: all 0.3s;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        }

        .play-button:hover {
            background-color: #ff8800;
            transform: scale(1.05);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
        }

        /* New Battle Pass Styles */
        .battlepass-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        .battlepass-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .battlepass-progress {
            flex-grow: 1;
            margin: 0 20px;
        }

        .progress-bar-container {
            width: 100%;
            height: var(--progress-bar-height);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            margin: 15px 0;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            transition: width 0.3s ease;
            position: relative;
            box-shadow: 0 0 10px rgba(0, 168, 255, 0.5);
        }

        .progress-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 14px;
            color: #fff;
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
        }

        .progress-info img {
            border: 2px solid var(--secondary-color);
            box-shadow: 0 0 10px rgba(255, 159, 26, 0.3);
        }

        .progress-info span {
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        #battlepass-exp {
            color: var(--secondary-color);
            font-size: 12px;
            background: rgba(0, 0, 0, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            border: 1px solid rgba(255, 159, 26, 0.3);
        }

        .battlepass-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .battlepass-item {
            position: relative;
            background: rgba(30, 30, 30, 0.9);
            border-radius: 10px;
            padding: 15px;
            transition: all 0.3s;
            cursor: pointer;
            overflow: hidden;
        }

        .battlepass-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .battlepass-item img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .item-info {
            text-align: center;
        }

        .item-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-exp {
            font-size: 14px;
            color: var(--secondary-color);
        }

        .locked-item {
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .locked-item::after {
            content: 'ðŸ”’';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 30px;
        }

        .claimed-item::after {
            content: 'âœ“';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary-color);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .currency-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 20px;
        }

        .currency-icon {
            width: 24px;
            height: 24px;
        }

        .buy-pass-btn {
            background: linear-gradient(45deg, #ff6b6b, #ff8e53);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .buy-pass-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.4);
        }

        .header-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .claim-all-btn {
            background: linear-gradient(45deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .claim-all-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 20, 147, 0.4);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 30, 0.95);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            min-width: 300px;
        }

        .modal-btn {
            margin: 10px;
            padding: 12px 25px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-btn.primary {
            background: var(--primary-color);
            color: white;
        }

        .modal-btn.secondary {
            background: var(--secondary-color);
            color: white;
        }

        .modal-btn.cancel {
            background: #ff4757;
            color: white;
        }

        .modal-btn:hover {
            transform: scale(1.05);
            filter: brightness(1.1);
        }
    </style>
</head>
<body>
    <!-- Keep existing menu -->
    <div class="menu">
        <div class="menu-items">
            <a href="home.html">Home</a>
            <a href="Store.html">Store</a>
            <a href="event.html">Event</a>
            <a href="Team Builder.html">Team Builder</a>
            <a href="statistics.html">Statistics</a>
        </div>
    </div>

    <!-- Keep existing play button -->
    <div class="play-button-container">
        <a href="Game Modes.html" class="play-button">Play</a>
    </div>

    <!-- Video Background -->
    <video id="video-background" autoplay muted loop>
        <source src="Event/Eventvideo.mp4" type="video/mp4">
    </video>

    <!-- New Battle Pass Content -->
    <div class="battlepass-container">
        <div class="battlepass-header">
            <div class="currency-display">
                <img src="res/img/fm.png" alt="FM" class="currency-icon">
                <span id="currency-amount">0</span>
                <img src="res/img/cm.png" alt="CM" class="currency-icon">
                <span id="currency-amount-cm">0</span>
            </div>
            <div class="battlepass-progress">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="bp-progress-bar"></div>
                </div>
                <div class="progress-info">
                    <span id="current-level">Level 1</span>
                    <span id="battlepass-exp">0 / 8500 BP Exp</span>
                </div>
            </div>
            <div class="header-buttons">
                <button class="buy-pass-btn" onclick="buyBattlepass()">Buy Battle Pass</button>
                <button class="claim-all-btn" onclick="claimAllItems()" id="claim-all-button" style="display: none;">Claim All</button>
            </div>
        </div>

        <div class="battlepass-grid" id="battle-pass-container">
            <!-- Items will be dynamically added here -->
        </div>
    </div>

    <!-- Buy Modal -->
    <div id="buy-battlepass-modal" class="modal">
        <div class="modal-content">
            <h2>Buy Battle Pass</h2>
            <p>Choose your payment method:</p>
            <button id="buy-with-fm" class="modal-btn primary">4,000 FM</button>
            <button id="buy-with-cm" class="modal-btn secondary">150,000 CM</button>
            <button id="cancel-purchase" class="modal-btn cancel">Cancel</button>
        </div>
    </div>

    <!-- Claim All Results Modal -->
    <div id="claim-all-modal" class="modal">
        <div class="modal-content">
            <h2>Items Claimed</h2>
            <div id="claimed-items-list" style="max-height: 300px; overflow-y: auto; margin: 15px 0;"></div>
            <button id="close-claim-all" class="modal-btn primary">Close</button>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, get, set, update } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqhxq6sPDU3EmuvvkBIIDJ-H6PsBc42Jg",
            authDomain: "project-fighters-by-fishb0nes.firebaseapp.com",
            databaseURL: "https://project-fighters-by-fishb0nes-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-fighters-by-fishb0nes",
            storageBucket: "project-fighters-by-fishb0nes.appspot.com",
            messagingSenderId: "867339299995",
            appId: "1:867339299995:web:99c379940014b9c05cea3e",
            measurementId: "G-LNEM6HR842"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);
        
        // Recolor data for random recolor rewards
        const recolorData = {
            "Gangster Peacock": {
                base: "Gangster Peacock",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Bandito Shinnok": {
                base: "Bandito Shinnok",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold", "Fel Fire"],
                availability: {
                    "Fel Fire": false // Fel Fire is only available through battlepass
                }
            },
            "Cham Cham": {
                base: "Cham Cham",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Elphelt": {
                base: "Elphelt",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Shao Kahn": {
                base: "Shao Kahn",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Thunderstrike Shao Kahn": {
                base: "Thunderstrike Shao Kahn",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Ayane": {
                base: "Ayane",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Battleborn Ayane": {
                base: "Battleborn Ayane",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Eagle": {
                base: "Eagle",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Battleborn Eagle": {
                base: "Battleborn Eagle",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            },
            "Talim": {
                base: "Talim",
                recolors: ["Red", "Blue", "Green", "Purple", "Gold"],
                availability: {}
            }
        };
        
        // Battle Pass Items
        const battlePassItems = [
            { id: 'Item1', exp: 0, img: 'Skins/Monster Trainer Ayane.jfif', skinName: 'Monster Trainer Ayane', name: 'Monster Trainer Ayane Skin' },
            { id: 'Item2', exp: 70, img: 'Icons/Profile/trainer_ayane.webp', name: 'Trainer Ayane Icon', type: 'icon', rewardName: 'trainer_ayane' },
            { id: 'Item3', exp: 149, img: 'Loading Screen/Monster Trainer Ayane.png', name: 'Unstoppable Ice (Song)', type: 'Song', songName: 'Unstoppable Ice (Monster Trainer Ayane Theme)' },
            { id: 'Item4', exp: 237, img: 'res/img/fm.png', name: '500 FM', type: 'FM', amount: 500 },
            { id: 'Item5', exp: 334, img: 'res/img/basicbox.png', name: 'Free Lootbox', folder: 'freelootbox' },
            { id: 'Item6', exp: 440, img: 'titles/titleimage.jpeg', name: 'Monster Trainer', type: 'Title', titleName: 'Monster Trainer' },
            { id: 'Item7', exp: 555, img: 'res/img/cm.png', name: '8000 CM', type: 'CM', amount: 8000 },
            { id: 'Item8', exp: 679, img: 'Stickers/ayane_confident.png', name: 'Ayane Confident Sticker', type: 'Sticker', stickerName: 'ayane_confident' },
            { id: 'Item9', exp: 812, img: 'res/img/fm.png', name: '500 FM', type: 'FM', amount: 500 },
            { id: 'Item10', exp: 954, img: 'res/img/basicbox.png', name: 'Free Lootbox', folder: 'freelootbox' },
            { id: 'Item11', exp: 1105, img: 'Icons/Profile/trainer_kokoro.png', name: 'Trainer Kokoro Icon', type: 'icon', rewardName: 'trainer_kokoro' },
            { id: 'Item12', exp: 1265, img: 'Loading Screen/Monster Trainer Kokoro.png', name: 'Trainers Pride (Song)', type: 'Song', songName: 'Trainers Pride (Monster Trainer Kokoro Theme)' },
            { id: 'Item13', exp: 1434, img: 'res/img/fm.png', name: '500 FM', type: 'FM', amount: 500 },
            { id: 'Item14', exp: 1612, img: 'Stickers/kokoro_wink.png', name: 'Kokoro Wink Sticker', type: 'Sticker', stickerName: 'kokoro_wink' },
            { id: 'Item15', exp: 1799, img: 'Skins/Monster Trainer Kokoro.jpg', skinName: 'Monster Trainer Kokoro', name: 'Monster Trainer Kokoro Skin' },
            { id: 'Item16', exp: 1995, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item17', exp: 2200, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item18', exp: 2414, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item19', exp: 2637, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item20', exp: 2869, img: 'res/img/fm.png', name: '100 FM', type: 'FM', amount: 100 },
            { id: 'Item21', exp: 3110, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item22', exp: 3360, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item23', exp: 3619, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item24', exp: 3887, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item25', exp: 4164, img: 'titles/titleimage.jpeg', name: 'Gym Leader', type: 'Title', titleName: 'gym_leader' },
            { id: 'Item26', exp: 4450, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item27', exp: 4745, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item28', exp: 5049, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item29', exp: 5362, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item30', exp: 5684, img: 'res/img/fm.png', name: '100 FM', type: 'FM', amount: 100 },
            { id: 'Item31', exp: 6015, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item32', exp: 6355, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item33', exp: 6704, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item34', exp: 7062, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item35', exp: 7429, img: 'res/img/fm.png', name: '100 FM', type: 'FM', amount: 100 },
            { id: 'Item36', exp: 7805, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item37', exp: 8190, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item38', exp: 8584, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item39', exp: 8987, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item40', exp: 9399, img: 'res/img/fm.png', name: '100 FM', type: 'FM', amount: 100 },
            { id: 'Item41', exp: 9820, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item42', exp: 10250, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item43', exp: 10689, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item44', exp: 11137, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item45', exp: 11594, img: 'res/img/fm.png', name: '100 FM', type: 'FM', amount: 100 },
            { id: 'Item46', exp: 12060, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item47', exp: 12535, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item48', exp: 13019, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item49', exp: 13512, img: 'res/img/cm.png', name: '3500 CM', type: 'CM', amount: 3500 },
            { id: 'Item50', exp: 14014, img: 'res/img/fm.png', name: '100 FM', type: 'FM', amount: 100 }
        ];

        // Update progress bar
        function updateProgressBar(currentExp) {
            // Find the next item to unlock
            let nextItem = battlePassItems[0];
            let previousExp = 0;
            
            for (let item of battlePassItems) {
                if (item.exp > currentExp) {
                    nextItem = item;
                    break;
                }
                previousExp = item.exp;
            }

            // Calculate progress to next item
            const progressToNext = currentExp - previousExp;
            const totalNeededForNext = nextItem.exp - previousExp;
            const progress = (progressToNext / totalNeededForNext) * 100;

            // Update progress bar
            const progressBar = document.getElementById('bp-progress-bar');
            progressBar.style.width = `${Math.min(progress, 100)}%`;
            
            // Update progress info
            document.getElementById('current-level').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${nextItem.img}" alt="${nextItem.name}" style="width: 30px; height: 30px; border-radius: 5px;">
                    <span>Next: ${nextItem.name}</span>
                </div>`;
            document.getElementById('battlepass-exp').textContent = 
                `${progressToNext}/${totalNeededForNext} EXP to unlock`;
        }

        // Display Battle Pass items
        function displayBattlePass(userExp, claimedItems) {
            const container = document.getElementById('battle-pass-container');
            container.innerHTML = ''; // Clear existing items

            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    const userData = snapshot.exists() ? snapshot.val() : {};
                    const hasBattlepass = userData.hasBattlepass || false;

                    battlePassItems.forEach((item) => {
                        const itemElement = document.createElement('div');
                        itemElement.className = 'battlepass-item';
                        
                        if (!hasBattlepass || userExp < item.exp) {
                            itemElement.classList.add('locked-item');
                        } else if (claimedItems[item.id]) {
                            itemElement.classList.add('claimed-item');
                        }

                        itemElement.innerHTML = `
                            <img src="${item.img}" alt="${item.name}">
                            <div class="item-info">
                                <div class="item-name">${item.name}</div>
                                <div class="item-exp">${item.exp} BP Exp</div>
                            </div>
                        `;

                        if (hasBattlepass && userExp >= item.exp && !claimedItems[item.id]) {
                            itemElement.onclick = () => claimItem(item.id, item.img, item.exp, item.folder, item.skinName, item.type);
                        }

                        container.appendChild(itemElement);
                    });

                    // Update progress bar
                    updateProgressBar(userExp);
                });
            }
        }

        // Claim item function
        function claimItem(itemId, img, exp, folder, skinName, itemType) {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        if (userData.BattlePassExp >= exp) {
                            const updates = {};
                            updates[`users/${userId}/BPprogress/${itemId}`] = 1;
                            
                            // Handle different reward types
                            if (folder) {
                                const fileName = img.split('/').pop().split('.')[0];
                                updates[`users/${userId}/${folder}/${fileName}`] = 1;
                            }
                            if (skinName) {
                                updates[`users/${userId}/skins/${skinName}`] = 1;
                            }
                            if (itemType === 'CM') {
                                updates[`users/${userId}/CM`] = (userData.CM || 0) + 3500;
                            }
                            if (itemType === 'FM') {
                                const amount = battlePassItems.find(item => item.id === itemId)?.amount || 0;
                                updates[`users/${userId}/FM`] = (userData.FM || 0) + amount;
                            }
                            if (itemType === 'Title') {
                                const titleName = battlePassItems.find(item => item.id === itemId)?.titleName;
                                if (titleName) {
                                    updates[`users/${userId}/titles/${titleName}`] = true;
                                }
                            }
                            if (itemType === 'Song') {
                                const item = battlePassItems.find(item => item.id === itemId);
                                if (item && Array.isArray(item.songName)) {
                                    // Randomly select one song from the array
                                    const randomSong = item.songName[Math.floor(Math.random() * item.songName.length)];
                                    updates[`users/${userId}/Songs/${randomSong}`] = 1;
                                } else if (item && item.songName) {
                                    updates[`users/${userId}/Songs/${item.songName}`] = 1;
                                }
                            }
                            if (itemType === 'RandomRecolor') {
                                // Get all available recolors from recolorData
                                const allRecolors = [];
                                Object.entries(recolorData).forEach(([baseSkin, data]) => {
                                    data.recolors.forEach(recolor => {
                                        // Skip unavailable recolors
                                        if (!data.availability || data.availability[recolor] !== false) {
                                            const fullName = `${data.base} ${recolor}`;
                                            if (!userData.skins || !userData.skins[fullName]) {
                                                allRecolors.push(fullName);
                                            }
                                        }
                                    });
                                });
                                
                                if (allRecolors.length > 0) {
                                    const randomRecolor = allRecolors[Math.floor(Math.random() * allRecolors.length)];
                                    updates[`users/${userId}/skins/${randomRecolor}`] = 1;
                                }
                            }

                            update(ref(database), updates).then(() => {
                                displayBattlePass(userData.BattlePassExp, userData.BPprogress || {});
                                alert('Item claimed successfully!');
                            }).catch((error) => {
                                console.error('Error claiming item:', error);
                                alert('Failed to claim item. Please try again.');
                            });
                        } else {
                            alert('Not enough Battle Pass EXP to claim this item!');
                        }
                    }
                });
            }
        }

        // Buy Battle Pass function
        window.buyBattlepass = function() {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const userFM = userData.FM || 0;
                        const userCM = userData.CM || 0;

                        // Show the modal dialog
                        const modal = document.getElementById('buy-battlepass-modal');
                        modal.style.display = 'block';

                        // Set up event listeners for the buttons
                        document.getElementById('buy-with-fm').onclick = () => {
                            if (userFM >= 4000) {
                                purchaseBattlepass(userId, 'FM', userFM - 4000);
                            } else {
                                alert("You don't have enough FM to purchase the battlepass.");
                            }
                            modal.style.display = 'none';
                        };

                        document.getElementById('buy-with-cm').onclick = () => {
                            if (userCM >= 150000) {
                                purchaseBattlepass(userId, 'CM', userCM - 150000);
                            } else {
                                alert("You don't have enough CM to purchase the battlepass.");
                            }
                            modal.style.display = 'none';
                        };

                        document.getElementById('cancel-purchase').onclick = () => {
                            modal.style.display = 'none';
                        };
                    }
                }).catch((error) => {
                    console.error(error);
                });
            }
        };

        // Add the missing purchaseBattlepass function
        function purchaseBattlepass(userId, currency, newAmount) {
            const updates = {};
            updates[`users/${userId}/${currency}`] = newAmount;
            updates[`users/${userId}/hasBattlepass`] = true;
            
            update(ref(database), updates).then(() => {
                alert('Battle Pass purchased successfully!');
                location.reload();
            }).catch((error) => {
                console.error('Error purchasing battle pass:', error);
                alert('Failed to purchase Battle Pass. Please try again.');
            });
        }

        // Initialize when auth state changes
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const userExp = userData.BattlePassExp || 0;
                        const claimedItems = userData.BPprogress || {};
                        document.getElementById('currency-amount').textContent = userData.FM || 0;
                        document.getElementById('currency-amount-cm').textContent = userData.CM || 0;
                        
                        displayBattlePass(userExp, claimedItems);
                        
                        if (userData.hasBattlepass) {
                            document.querySelector('.buy-pass-btn').style.display = 'none';
                            document.getElementById('claim-all-button').style.display = 'block';
                        }
                    }
                });
            } else {
                displayBattlePass(0, {});
            }
        });

        // Claim All Items function
        window.claimAllItems = function() {
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, 'users/' + userId);

                get(userRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const userData = snapshot.val();
                        const userExp = userData.BattlePassExp || 0;
                        const claimedItems = userData.BPprogress || {};
                        
                        if (!userData.hasBattlepass) {
                            alert('You need to purchase the Battle Pass to claim all items.');
                            return;
                        }
                        
                        // Find all claimable items
                        const claimableItems = battlePassItems.filter(item => 
                            userExp >= item.exp && !claimedItems[item.id]
                        );
                        
                        if (claimableItems.length === 0) {
                            alert('No items available to claim.');
                            return;
                        }
                        
                        // Prepare updates for all items
                        const updates = {};
                        const claimedItemsList = [];
                        let totalFM = 0;
                        let totalCM = 0;
                        
                        claimableItems.forEach(item => {
                            // Mark item as claimed in BP progress
                            updates[`users/${userId}/BPprogress/${item.id}`] = 1;
                            
                            // Handle different reward types
                            if (item.folder) {
                                const fileName = item.img.split('/').pop().split('.')[0];
                                updates[`users/${userId}/${item.folder}/${fileName}`] = 1;
                                claimedItemsList.push(`${item.name} (Lootbox)`);
                            }
                            if (item.skinName) {
                                updates[`users/${userId}/skins/${item.skinName}`] = 1;
                                claimedItemsList.push(`${item.name} (Skin)`);
                            }
                            if (item.type === 'CM') {
                                totalCM += item.amount || 3500;
                                claimedItemsList.push(`${item.name} (Currency)`);
                            }
                            if (item.type === 'FM') {
                                totalFM += item.amount || 0;
                                claimedItemsList.push(`${item.name} (Currency)`);
                            }
                            if (item.type === 'Title') {
                                if (item.titleName) {
                                    updates[`users/${userId}/titles/${item.titleName}`] = true;
                                    claimedItemsList.push(`${item.name} (Title)`);
                                }
                            }
                            if (item.type === 'Song') {
                                if (item && Array.isArray(item.songName)) {
                                    // Randomly select one song from the array
                                    const randomSong = item.songName[Math.floor(Math.random() * item.songName.length)];
                                    updates[`users/${userId}/Songs/${randomSong}`] = 1;
                                    claimedItemsList.push(`${randomSong} (Song)`);
                                } else if (item && item.songName) {
                                    updates[`users/${userId}/Songs/${item.songName}`] = 1;
                                    claimedItemsList.push(`${item.songName} (Song)`);
                                }
                            }
                            if (item.type === 'icon') {
                                if (item.rewardName) {
                                    updates[`users/${userId}/icons/${item.rewardName}`] = 1;
                                    claimedItemsList.push(`${item.name} (Icon)`);
                                }
                            }
                            if (item.type === 'Sticker') {
                                if (item.stickerName) {
                                    updates[`users/${userId}/stickers/${item.stickerName}`] = 1;
                                    claimedItemsList.push(`${item.name} (Sticker)`);
                                }
                            }
                            if (item.type === 'RandomRecolor') {
                                // Get all available recolors from recolorData
                                const allRecolors = [];
                                Object.entries(recolorData).forEach(([baseSkin, data]) => {
                                    data.recolors.forEach(recolor => {
                                        // Skip unavailable recolors
                                        if (!data.availability || data.availability[recolor] !== false) {
                                            const fullName = `${data.base} ${recolor}`;
                                            if (!userData.skins || !userData.skins[fullName]) {
                                                allRecolors.push(fullName);
                                            }
                                        }
                                    });
                                });
                                
                                if (allRecolors.length > 0) {
                                    const randomRecolor = allRecolors[Math.floor(Math.random() * allRecolors.length)];
                                    updates[`users/${userId}/skins/${randomRecolor}`] = 1;
                                    claimedItemsList.push(`${randomRecolor} (Recolor)`);
                                }
                            }
                        });
                        
                        // Update currency totals if needed
                        if (totalFM > 0) {
                            updates[`users/${userId}/FM`] = (userData.FM || 0) + totalFM;
                        }
                        if (totalCM > 0) {
                            updates[`users/${userId}/CM`] = (userData.CM || 0) + totalCM;
                        }
                        
                        // Apply all updates
                        update(ref(database), updates).then(() => {
                            // Show claimed items in modal
                            const claimedItemsListElement = document.getElementById('claimed-items-list');
                            claimedItemsListElement.innerHTML = '';
                            
                            if (claimedItemsList.length > 0) {
                                const itemsHTML = claimedItemsList.map(item => 
                                    `<div style="padding: 8px; background: rgba(30, 30, 30, 0.7); margin-bottom: 5px; border-radius: 5px;">${item}</div>`
                                ).join('');
                                claimedItemsListElement.innerHTML = itemsHTML;
                                
                                // Show summary of currency if applicable
                                if (totalFM > 0 || totalCM > 0) {
                                    let summaryHTML = '<div style="margin-top: 15px; padding: 10px; background: rgba(50, 50, 50, 0.7); border-radius: 5px;"><strong>Total Currency Gained:</strong><br>';
                                    if (totalFM > 0) summaryHTML += `<div>FM: +${totalFM}</div>`;
                                    if (totalCM > 0) summaryHTML += `<div>CM: +${totalCM}</div>`;
                                    summaryHTML += '</div>';
                                    claimedItemsListElement.innerHTML += summaryHTML;
                                }
                            } else {
                                claimedItemsListElement.innerHTML = '<div>No items were claimed.</div>';
                            }
                            
                            // Show the modal
                            const modal = document.getElementById('claim-all-modal');
                            modal.style.display = 'block';
                            
                            // Set up close button
                            document.getElementById('close-claim-all').onclick = () => {
                                modal.style.display = 'none';
                                // Refresh the display
                                displayBattlePass(userExp, {...claimedItems, ...Object.fromEntries(claimableItems.map(item => [item.id, 1]))});
                            };
                            
                        }).catch((error) => {
                            console.error('Error claiming items:', error);
                            alert('Failed to claim items. Please try again.');
                        });
                    }
                });
            }
        };
    </script>
</body>
</html>