<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Champion Selector</title>
    <!-- Include Firebase SDK and configuration as module scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js" type="module"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script type="module" src="music-player.js"></script>
    <script type="module" src="songs.js"></script>
    <script type="module" src="lunar-lantern.js"></script>
    <!-- Music Player Styles -->
    
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, push, set, get, update, runTransaction } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js';
        import { roles } from './roles.js';

        // Global variables for demo player
        window.atlantisDemoPlaying = false;
        window.atlantisDemoTimeout = null;
        
    // Make database functions available globally
    window.ref = ref;
    window.push = push;
    window.set = set;
    window.get = get;
    window.update = update;
    window.runTransaction = runTransaction;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqhxq6sPDU3EmuvvkBIIDJ-H6PsBc42Jg",
            authDomain: "project-fighters-by-fishb0nes.firebaseapp.com",
            databaseURL: "https://project-fighters-by-fishb0nes-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-fighters-by-fishb0nes",
            storageBucket: "project-fighters-by-fishb0nes.appspot.com",
            messagingSenderId: "867339299995",
            appId: "1:867339299995:web:99c379940014b9c05cea3e",
            measurementId: "G-LNEM6HR842"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Export Firebase instances for other modules
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;

        // Helper functions
        function capitalizeTitle(title) {
            if (!title) return '';
            return title.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }


        // Auth state initialization
        function initializeAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();
                        
                        if (userData) {
                            // Update username and title
                            const usernameContainer = document.querySelector('.username-title-container');
                            if (usernameContainer) {
                                const usernameDisplay = usernameContainer.querySelector('#username-display');
                                if (usernameDisplay) {
                                    usernameDisplay.textContent = userData.username || user.email.split('@')[0];
                                }

                                // Update title if it exists
                                let titleDisplay = usernameContainer.querySelector('#title-display');
                                if (userData.activeTitle) {
                                    if (!titleDisplay) {
                                        titleDisplay = document.createElement('div');
                                        titleDisplay.id = 'title-display';
                                        usernameContainer.appendChild(titleDisplay);
                                    }
                                    titleDisplay.textContent = `(${capitalizeTitle(userData.activeTitle)})`;
                                } else if (titleDisplay) {
                                    titleDisplay.remove();
                                }
                            }

                            // Update profile image
                            const profileImage = document.getElementById('profile-image');
                            if (profileImage) {
                                setProfileImage(`Icons/${userData.icon || 'Birdie.png'}`, `Icons/Profile/${userData.icon || 'Birdie.png'}`);
                            }

                            // Update currency displays
                            const currencyAmount = document.getElementById('currency-amount');
                            const cmAmount = document.getElementById('cm-amount');
                            const qpAmount = document.getElementById('qp-amount');
                            if (currencyAmount) currencyAmount.textContent = userData.FM || 0;
                            if (cmAmount) cmAmount.textContent = userData.CM || 0;
                            if (qpAmount) qpAmount.textContent = userData.questPoints || 0;

                            // Initialize quests only if they haven't been initialized yet
                            const questsContainer = document.querySelector('#new-quests-box .content');
                            if (questsContainer && !questsContainer.hasAttribute('data-initialized')) {
                                questsContainer.setAttribute('data-initialized', 'true');
                                const questsRef = ref(database, `users/${userId}/quests`);
                                const questsSnapshot = await get(questsRef);
                                const questsData = questsSnapshot.val() || {};

                                questsContainer.innerHTML = '';
                                quests.forEach(quest => {
                                    const questData = questsData[quest.id] || { progress: 0, completed: false, claimed: false };
                                    if (!questData.claimed) {
                                        displayQuest(quest, questData, userData);
                                    }
                                });
                            }

                            // Initialize friend list only if it hasn't been initialized yet
                            const friendListUL = document.getElementById('friend-list-ul');
                            if (friendListUL && !friendListUL.hasAttribute('data-initialized')) {
                                friendListUL.setAttribute('data-initialized', 'true');
                                loadFriendList(userId);
                            }

                            // Check and show Julia reward
                            checkAndShowJuliaReward();
                        }
                    } catch (error) {
                        console.error('Error initializing user data:', error);
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        // Expose necessary functions to global scope
        window.initializeAuthState = initializeAuthState;
        window.createParticles = createParticles;
        window.capitalizeTitle = capitalizeTitle;

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase auth state
            initializeAuthState();

            // Create particles
            createParticles();

            // Initialize click handlers for profile image and container
            const profileInfo = document.getElementById('profile-info');
            const profileImage = document.getElementById('profile-image');
            const profileMenu = document.getElementById('profile-menu');
            const usernameDisplay = document.getElementById('username-display');

            // Global toggle function for the profile menu
            window.toggleProfileMenu = function(event) {
                if (event) {
                    event.stopPropagation();
                }
                if (profileMenu) {
                    profileMenu.classList.toggle('show');
                }
            }

            // Add click handlers
            if (profileInfo) {
                profileInfo.addEventListener('click', toggleProfileMenu);
            }
            if (profileImage) {
                profileImage.addEventListener('click', toggleProfileMenu);
            }
            if (usernameDisplay) {
                usernameDisplay.addEventListener('click', toggleProfileMenu);
            }

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (profileMenu && profileMenu.classList.contains('show') && 
                    !profileInfo.contains(event.target) &&
                    !profileMenu.contains(event.target)) {
                    profileMenu.classList.remove('show');
                }
            });

            // Initialize quest container
            const questContent = document.querySelector('#new-quests-box .content');
            const questToggleButton = document.getElementById('toggle-quests');
            if (questContent && questToggleButton) {
                questContent.style.display = 'none';
                questToggleButton.innerHTML = '&#9660;';
            }

            // Quest toggle functionality
            const toggleQuestsButton = document.getElementById('toggle-quests');
            if (toggleQuestsButton) {
                toggleQuestsButton.addEventListener('click', function() {
                    const content = document.querySelector('#new-quests-box .content');
                    if (content) {
                        const isHidden = content.style.display === 'none';
                        content.style.display = isHidden ? 'block' : 'none';
                        toggleQuestsButton.innerHTML = isHidden ? '&#9650;' : '&#9660;';
                    }
                });
            }

            // Initialize advent calendar button
            const adventCalendarButton = document.querySelector('.advent-calendar-button');
            if (adventCalendarButton) {
                adventCalendarButton.addEventListener('click', async function() {
                    const { openAdventCalendar } = await import('./advent-calendar.js');
                    openAdventCalendar();
                });
            }
        });

        // Friend list helper functions
        function loadFriendList(userId) {
            const friendRef = ref(database, 'users/' + userId + '/friends');
            get(friendRef).then(snapshot => {
                const friendListUL = document.getElementById('friend-list-ul');
                if (friendListUL) {
                    friendListUL.innerHTML = ''; // Clear existing entries
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const friendData = childSnapshot.val();
                            loadFriendIcon(friendData.id, friendData.name);
                        });
                    }
                }
            }).catch(error => {
                console.error('Error loading friend list:', error);
            });
        }

        function loadFriendIcon(friendId, friendName) {
            const friendIconRef = ref(database, 'users/' + friendId + '/icon');
            get(friendIconRef).then(iconSnapshot => {
                const iconFilename = iconSnapshot.exists() ? iconSnapshot.val() : 'default-icon.jpg';
                const primaryIconUrl = `Icons/${iconFilename}`;
                const fallbackIconUrl = `Icons/Profile/${iconFilename}`;
                displayFriend(friendName, primaryIconUrl, fallbackIconUrl);
            }).catch(error => {
                console.error('Error loading friend icon:', error);
            });
        }

        function displayFriend(friendName, primaryIconUrl, fallbackIconUrl) {
            const friendListUL = document.getElementById('friend-list-ul');
            if (friendListUL) {
                const li = document.createElement('li');
                li.classList.add('friend-item');

                const img = document.createElement('img');
                img.src = primaryIconUrl;
                img.alt = 'Friend Icon';
                img.classList.add('friend-icon');
                img.onerror = () => {
                    img.onerror = null;
                    img.src = fallbackIconUrl;
                };

                const nameLink = document.createElement('a');
                nameLink.href = `ProfileVisitor.html?username=${friendName}`;
                nameLink.textContent = friendName;
                nameLink.classList.add('friend-name');

                li.appendChild(img);
                li.appendChild(nameLink);
                friendListUL.appendChild(li);
            }
        }

        // Initialize event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Video background handling
            const video = document.getElementById('video-background');
            if (video) {
                video.playbackRate = 1.0;
                video.play().catch(function(error) {
                    console.log("Video autoplay was prevented:", error);
                });
            }

            // Initialize Toggle Button State
            const championSelector = document.getElementById('champion-selector-container');
            const toggleButton = document.getElementById('toggle-champion-button');
            if (championSelector && toggleButton) {
                championSelector.style.display = 'flex';
            }

            // Single friend list initialization
            const toggleFriendListButton = document.getElementById("toggle-friend-list");
            const friendList = document.getElementById("friend-list");
            const addFriendButton = document.getElementById("add-friend-button");
            const friendNameInput = document.getElementById("friend-name-input");

            if (toggleFriendListButton && friendList) {
                toggleFriendListButton.addEventListener("click", function() {
                    friendList.style.display = friendList.style.display === "none" ? "block" : "none";
                });
            }

            if (addFriendButton && friendNameInput) {
                addFriendButton.addEventListener("click", async function() {
                    const friendName = friendNameInput.value;
                    if (friendName) {
                        try {
                            const userId = auth.currentUser.uid;
                            const usersRef = ref(database, 'users');
                            const snapshot = await get(usersRef);
                            let friendId = null;

                            snapshot.forEach(childSnapshot => {
                                const userData = childSnapshot.val();
                                if (userData.username === friendName) {
                                    friendId = childSnapshot.key;
                                }
                            });

                            if (friendId) {
                                const friendRef = ref(database, 'users/' + userId + '/friends');
                                const newFriendRef = push(friendRef);
                                await set(newFriendRef, {
                                    id: friendId,
                                    name: friendName
                                });
                                friendNameInput.value = '';
                                loadFriendList(userId);
                            } else {
                                alert('Username not found');
                            }
                        } catch (error) {
                            console.error('Error adding friend:', error);
                        }
                    }
                });
            }
        });
    

    function createParticles() {
        const particleContainer = document.querySelector('.particle-container');
        if (!particleContainer) {
            const newParticleContainer = document.createElement('div');
            newParticleContainer.classList.add('particle-container');
            document.body.appendChild(newParticleContainer);
        }

        for (let i = 0; i < 60; i++) { // Increase number for more particles
            const particle = document.createElement('div');
            particle.classList.add('particle');
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.width = `${Math.random() * 6 + 4}px`; // Size between 4px and 10px
            particle.style.height = particle.style.width;
            particle.style.background = `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`;
            particle.style.animationDuration = `${Math.random() * 5 + 3}s`; // Duration between 3s and 8s
            particle.style.animationDelay = `${Math.random() * 5}s`; // Delay between 0s and 5s
            document.querySelector('.particle-container').appendChild(particle);
        }
    }

    window.openChangeIconModal = async function() {
        const modal = document.getElementById('change-icon-modal');
        modal.style.display = 'block';

        // Load icons dynamically
        const iconList = document.getElementById('icon-list');
        iconList.innerHTML = '';

        const icons = [
            'Julia.png', 'Birdie.png', 'Erron Black.png', 'Cham Cham.png', 'Morrigan.png',
            'Jun.png', 'Reptile.png', 'Akuma.png', 'Elphelt.png', 'Kotal Kahn.png',
            'Scorpion.png', 'Peacock.png', 'Angel.png', 'Astaroth.png', 'Ibuki.png',
            'R.Mika.png', 'Raiden.png', 'Yugo.png', 'Talim.png', 'Noel.png',
            'Blanka.png', 'Nina.png', 'Ayane.png', 'Siegfried.png', 'Shoma.png', 
            'Juri.png', 'Sub Zero.png', 'Christie.png', 'Kokoro.png', 'Eagle.png',
            'Sophitia.png', 'Shizumaru.png', 'Kagome.png', 'Kabal.png', 'Kuma.png',
            'Alice.png', 'Shinnok.png', 'FANG.png', 'Lili.png', 'Mega Man.png', "Mai.png"
        ];

        icons.forEach(icon => {
            const img = document.createElement('img');
            img.src = `Icons/${icon}`;
            img.alt = icon.replace('.png', '');
            img.classList.add('icon-image');
            img.onclick = () => selectIcon(icon);
            iconList.appendChild(img);
        });

        // Fetch user-specific icons from the database
        const user = auth.currentUser;
        if (user) {
            const userRef = ref(database, 'users/' + user.uid + '/Icons');
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                const userIcons = snapshot.val();
                for (const iconName in userIcons) {
                    if (userIcons[iconName] === 1) { // Check if the value is 1
                        const img = document.createElement('img');
                        img.src = `Icons/Profile/${iconName}.png`;
                        img.alt = iconName.replace('.png', '');
                        img.classList.add('icon-image');
                        img.onclick = () => selectIcon(iconName + '.png');
                        iconList.appendChild(img);
                    }
                }
            }
        }
    };

    window.logOut = function() {
        signOut(auth).then(() => {
            console.log('User signed out successfully');
            window.location.href = 'index.html'; // Redirect to login page after sign out
        }).catch((error) => {
            console.error('Error signing out:', error);
        });
    };

    function selectIcon(icon) {
        const user = auth.currentUser;
        if (user) {
            updateIcon(icon)
                .then(() => {
                    setProfileImage(`Icons/${icon}`, `Icons/Profile/${icon}`);
                    closeChangeIconModal();
                })
                .catch(error => {
                    console.error('Error updating icon:', error);
                });
        } else {
            console.error('User not authenticated');
        }
    }

    async function updateIcon(icon) {
        const user = auth.currentUser;
        if (user) {
            const userRef = ref(database, 'users/' + user.uid);
            try {
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    userData.icon = icon; // Update the icon field
                    await set(userRef, userData); // Write back the updated data
                    console.log('Icon updated successfully');
                } else {
                    console.error('No user data found');
                }
            } catch (error) {
                console.error('Error updating icon:', error);
            }
        } else {
            console.error('User not authenticated');
        }
    }

    function setProfileImage(primaryPath, fallbackPath) {
        const img = document.getElementById('profile-image');
        img.onerror = () => {
            img.onerror = null; // Remove error handler to avoid infinite loop
            img.src = fallbackPath;
        };
        img.src = primaryPath;
    }

    window.closeChangeIconModal = function() {
        const modal = document.getElementById('change-icon-modal');
        modal.style.display = 'none';
    };

    

    window.toggleProfileMenu = function() {
        const profileMenu = document.getElementById('profile-menu');
        profileMenu.classList.toggle('show');
    };

    window.searchChampion = function() {
        const input = document.getElementById('search-bar').value.toLowerCase();
        const images = document.getElementsByClassName('champion-image');
        for (let i = 0; i < images.length; i++) {
            const altText = images[i].alt.toLowerCase();
            if (altText.includes(input)) {
                images[i].style.display = '';
            } else {
                images[i].style.display = 'none';
            }
        }
    };


    window.updateQuestProgress = async function() {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

            const userId = user.uid;
        const questsRef = ref(database, `users/${userId}/quests`);
        const userRef = ref(database, `users/${userId}`);

        try {
            // Get quest data
            const questsSnapshot = await get(questsRef);
            const questsData = questsSnapshot.val() || {};

            // Get user data for quest points
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val() || {};

            // Update quest points display
            const questPointsDisplay = document.getElementById('quest-points-amount');
            if (questPointsDisplay) {
                questPointsDisplay.textContent = userData.questPoints || 0;
            }

            // Define quest goals
            const questGoals = {
                'win-games': 2,
                'lose-games': 2,
                'win-against': 1,
                'win-as-atlantean': 1,
                'win-streak': 2
            };

            // Update win games quest
            const winQuestData = questsData['win-games'] || {};
            const winProgress = document.getElementById('win-games-progress');
            if (winProgress) {
                const progressBar = winProgress.parentElement.querySelector('.progress');
                const progressText = winProgress.parentElement.nextElementSibling;
                const claimButton = winProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = winQuestData.progress || 0;
                const completed = winQuestData.completed || false;
                const claimed = winQuestData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['win-games']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['win-games']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            // Update win streak quest
            const winStreakQuestData = questsData['win-streak'] || {};
            const winStreakProgress = document.getElementById('win-streak-progress');
            if (winStreakProgress) {
                const progressBar = winStreakProgress.parentElement.querySelector('.progress');
                const progressText = winStreakProgress.parentElement.nextElementSibling;
                const claimButton = winStreakProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = winStreakQuestData.progress || 0;
                const completed = winStreakQuestData.completed || false;
                const claimed = winStreakQuestData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['win-streak']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['win-streak']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            // Update lose games quest
            const loseQuestData = questsData['lose-games'] || {};
            const loseProgress = document.getElementById('lose-games-progress');
            if (loseProgress) {
                const progressBar = loseProgress.parentElement.querySelector('.progress');
                const progressText = loseProgress.parentElement.nextElementSibling;
                const claimButton = loseProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = loseQuestData.progress || 0;
                const completed = loseQuestData.completed || false;
                const claimed = loseQuestData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['lose-games']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['lose-games']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            // Update win against quest
            const winAgainstData = questsData['win-against'] || {};
            const winAgainstProgress = document.getElementById('win-against-progress');
            if (winAgainstProgress) {
                const progressBar = winAgainstProgress.parentElement.querySelector('.progress');
                const progressText = winAgainstProgress.parentElement.nextElementSibling;
                const claimButton = winAgainstProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = winAgainstData.progress || 0;
                const completed = winAgainstData.completed || false;
                const claimed = winAgainstData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['win-against']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['win-against']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            // Update win as atlantean quest
            const winAsAtlanteanData = questsData['win-as-atlantean'] || {};
            const winAsAtlanteanProgress = document.getElementById('win-as-atlantean-progress');
            if (winAsAtlanteanProgress) {
                const progressBar = winAsAtlanteanProgress.parentElement.querySelector('.progress');
                const progressText = winAsAtlanteanProgress.parentElement.nextElementSibling;
                const claimButton = winAsAtlanteanProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = winAsAtlanteanData.progress || 0;
                const completed = winAsAtlanteanData.completed || false;
                const claimed = winAsAtlanteanData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['win-as-atlantean']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['win-as-atlantean']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            console.log('Quest data updated:', questsData); // Debug log
        } catch (error) {
            console.error('Error updating quest progress:', error);
        }
    }

    function checkCharacterQuestProgress(team) {
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const userRef = ref(database, `users/${userId}`);
            get(userRef).then(snapshot => {
                const userData = snapshot.val();
                quests.forEach(quest => {
                    if (quest.id === 'winAsSpecificCharacter' && quest.requirement(userData)) {
                        updateQuestProgress(quest.id);
                    }
                });
            });
        } else {
            console.error('User not authenticated');
        }
    }

    async function claimQuestReward(questId, reward) {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

        const userId = user.uid;
        const userRef = ref(database, `users/${userId}`);
        const userSnapshot = await get(userRef);
        const userData = userSnapshot.val();

        if (!userData) return;

        // Check if it's a lunar ticket reward
        if (questId === 'lunar-ticket') {
            const currentQP = userData.questPoints || 0;
            
            if (currentQP >= reward) {
                const updates = {};
                
                // Deduct quest points
                updates['questPoints'] = currentQP - reward;
                
                // Add lunar ticket
                updates['lunarTickets'] = (userData.lunarTickets || 0) + 1;
                
                // Apply updates
                await update(userRef, updates);
                
                // Update displays
                document.getElementById('quest-points-amount').textContent = currentQP - reward;
                document.getElementById('lunar-ticket-amount').textContent = (userData.lunarTickets || 0) + 1;
                
                alert('Successfully claimed 1 Lunar Ticket!');
            } else {
                alert('Not enough Quest Points!');
            }
            return;
        }

        // Check if it's the CM reward
        if (questId === 'cm-reward') {
            const currentQP = userData.questPoints || 0;
            const cmRewardClaimed = userData.cmRewardClaimed || false;

            if (cmRewardClaimed) {
                alert('You have already claimed this reward!');
                // Disable the button
                document.getElementById('cm-reward-button').disabled = true;
                return;
            }
            
            if (currentQP >= reward) {
                const updates = {};
                
                // Deduct quest points
                updates['questPoints'] = currentQP - reward;
                
                // Add CM
                updates['CM'] = (userData.CM || 0) + 8000;
                
                // Mark as claimed
                updates['cmRewardClaimed'] = true;
                
                // Apply updates
                await update(userRef, updates);
                
                // Update displays
                document.getElementById('quest-points-amount').textContent = currentQP - reward;
                document.getElementById('cm-amount').textContent = (userData.CM || 0) + 8000;
                document.getElementById('cm-reward-button').disabled = true;
                
                alert('Successfully claimed 8000 Character Money!');
            } else {
                alert('Not enough Quest Points!');
            }
            return;
        }

        // Handle regular quest rewards
        const questRef = ref(database, `users/${userId}/quests/${questId}`);
        const questSnapshot = await get(questRef);
        const questData = questSnapshot.val();

        if (questData && questData.completed && !questData.claimed) {
            const updates = {};
            
            // Reset quest progress and status
            updates[`users/${userId}/quests/${questId}/progress`] = 0;
            updates[`users/${userId}/quests/${questId}/completed`] = false;
            updates[`users/${userId}/quests/${questId}/claimed`] = false;
            
            // Add quest points
            const currentQuestPoints = userData.questPoints || 0;
            updates[`users/${userId}/questPoints`] = currentQuestPoints + reward;

            // Apply all updates
            await update(ref(database), updates);
            
            // Update display
            await updateQuestProgress();
        }

        // Add a new quest reward for lunar_lantern_smile
        if (questId === 'lunar-lantern-smile') {
            const currentQP = userData.questPoints || 0;
            const lanternSmileClaimed = userData.lanternSmileClaimed || false;

            if (lanternSmileClaimed) {
                alert('You have already claimed this reward!');
                // Disable the button
                document.querySelector('button[onclick="claimQuestReward(\'lunar-lantern-smile\', 375)"]').disabled = true;
                return;
            }
            
            if (currentQP >= reward) {
                const updates = {};
                
                // Deduct quest points
                updates['questPoints'] = currentQP - reward;
                
                // Add lunar_lantern_smile to user's inventory (with capital S in Stickers)
                updates['Stickers/lunar_lantern_smile'] = 1;
                
                // Mark as claimed
                updates['lanternSmileClaimed'] = true;
                
                // Apply updates
                await update(userRef, updates);
                
                // Update displays
                document.getElementById('quest-points-amount').textContent = currentQP - reward;
                document.querySelector('button[onclick="claimQuestReward(\'lunar-lantern-smile\', 375)"]').disabled = true;
                alert('Successfully claimed Lunar Lantern Smile!');
            } else {
                alert('Not enough Quest Points!');
            }
            return;
        }
    }

    // Enhanced quest display function with reward images
    function displayQuest(quest, questData, userData) {
        const questContainer = document.querySelector('#new-quests-box .content');
        const questElement = document.createElement('div');
        questElement.classList.add('quest');
        questElement.id = `quest-${quest.id}`;

        const questContent = `
            <div class="quest-header">
                <div class="quest-info">
                    <h3>${quest.title}</h3>
                    <p class="quest-description">${quest.description}</p>
                </div>
                <div class="quest-reward" title="${quest.hoverText}">
                    <div class="reward-item">
                        <img src="${quest.image}" alt="Reward" class="reward-image">
                        <span class="reward-amount">+${Object.values(quest.reward)[0]}</span>
                    </div>
                </div>
            </div>
            <div class="quest-progress-container">
                <div class="quest-progress">
                    <div class="progress-bar" style="width: ${(questData.progress / quest.goal) * 100}%"></div>
                </div>
                <span class="progress-text">${questData.progress}/${quest.goal}</span>
            </div>
            ${questData.completed && !questData.claimed ? 
                '<button class="quest-button claim-button" onclick="claimQuestReward(\'' + quest.id + '\')">Claim Reward</button>' : 
                ''}
        `;

        questElement.innerHTML = questContent;
        questContainer.appendChild(questElement);
    }

    window.acceptQuest = function(questId) {
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const userRef = ref(database, `users/${userId}/quests/${questId}`);
            set(userRef, { progress: 0, completed: false, claimed: false });
            document.getElementById(`accept-quest-button-${questId}`).style.display = 'none';
        } else {
            console.error('User not authenticated');
        }
    };

    // Add event listener for advent calendar button
    document.addEventListener('DOMContentLoaded', function() {
        const adventCalendarButton = document.querySelector('.advent-calendar-button');
        if (adventCalendarButton) {
            adventCalendarButton.addEventListener('click', async function() {
                const { openAdventCalendar } = await import('./advent-calendar.js');
                openAdventCalendar();
            });
        }
    });

    async function openQuestWindow() {
        try {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
        const questWindow = document.getElementById('quest-window');
        if (questWindow) {
            questWindow.style.display = 'block';
                await updateQuestPoints();
                await updateQuestProgress();
                await updateCMRewardButton(); // Add this line
            }
            } catch (error) {
                console.error('Error opening quest window:', error);
            }
    }

    async function updateQuestPoints() {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

        const userId = user.uid;
        const userRef = ref(database, `users/${userId}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();
        const questPointsDisplay = document.getElementById('quest-points-amount');
        if (questPointsDisplay) {
            questPointsDisplay.textContent = userData?.questPoints || 0;
        }
    }

    function closeQuestWindow() {
        const questWindow = document.getElementById('quest-window');
        if (questWindow) {
            questWindow.style.display = 'none';
        }
    }

    async function unlockRecolor(recolorId, cost) {
        // Remove this function
    }

    async function unlockAtlantisReward(rewardId, cost, type) {
        // Remove this function
    }

    function toggleAtlantisSongDemo() {
        // Remove this function
    }

    // Add this function to your existing script
    async function checkAndShowJuliaReward() {
        const user = auth.currentUser;
        if (!user) return;

        try {
            const userSongsRef = ref(database, `users/${user.uid}/Songs`);
            const snapshot = await get(userSongsRef);
            const ownedSongs = snapshot.val() || {};

            if (!ownedSongs['Forest Wanderer (Julia Theme)']) {
                showJuliaReward();
            }
        } catch (error) {
            console.error('Error checking Julia reward:', error);
        }
    }

    function showJuliaReward() {
        const popup = document.createElement('div');
        popup.className = 'reward-popup';
        popup.innerHTML = `
            <div class="reward-popup-header">
                <h3 class="reward-popup-title">New Song Unlocked!</h3>
                <button class="reward-popup-close">×</button>
            </div>
            <div class="reward-popup-content">
                <img src="Loading Screen/Julia.png" alt="Julia Portrait" class="reward-popup-image">
                <p class="reward-popup-text">You've received Julia's Theme:<br>"Forest Wanderer"</p>
                <button class="claim-button">Claim</button>
            </div>
        `;

        document.body.appendChild(popup);

        // Close button handler
        popup.querySelector('.reward-popup-close').addEventListener('click', () => {
            popup.remove();
        });

        // Claim button handler
        popup.querySelector('.claim-button').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const userSongsRef = ref(database, `users/${user.uid}/Songs`);
                const updates = {};
                updates['Forest Wanderer (Julia Theme)'] = 1;
                await update(userSongsRef, updates);
                
                // Close popup after claiming
                popup.remove();
                
                // Refresh music player to include new song
                window.location.reload();
            } catch (error) {
                console.error('Error claiming Julia song:', error);
            }
        });
    }

    // Add this to your auth state change listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // ... existing auth code ...
            checkAndShowJuliaReward();
        }
    });

    // Make the function globally available
    window.toggleAtlantisSongDemo = toggleAtlantisSongDemo;

    // Add function to check CM reward claim status on window open
    async function updateCMRewardButton() {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

        const userId = user.uid;
        const userRef = ref(database, `users/${userId}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();

        if (userData && userData.cmRewardClaimed) {
            const button = document.getElementById('cm-reward-button');
            if (button) {
                button.disabled = true;
                button.innerHTML = '<i class="fas fa-check"></i> Claimed';
            }
        }

        // Check Lunar Lantern Smile reward
        if (userData.lanternSmileClaimed) {
            const lanternButton = document.querySelector('button[onclick="claimQuestReward(\'lunar-lantern-smile\', 375)"]');
            if (lanternButton) {
                lanternButton.disabled = true;
                lanternButton.textContent = 'Claimed';
            }
        }
    }
</script>


    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Music Player Script -->
    <script type="module">
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, update, get } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js';
        import { initMusicPlayer } from './music-player.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            initMusicPlayer();
            
            // Initialize Julia reward check
            const auth = getAuth();
            const database = getDatabase();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const userSongsRef = ref(database, `users/${user.uid}/Songs`);
                        const snapshot = await get(userSongsRef);
                        const ownedSongs = snapshot.val() || {};

                        if (!ownedSongs['Forest Wanderer (Julia Theme)']) {
                            showJuliaReward(auth, database);
                        }
                    } catch (error) {
                        console.error('Error checking Julia reward:', error);
                    }
                }
            });
        });

        function showJuliaReward(auth, database) {
            const popup = document.createElement('div');
            popup.className = 'reward-popup';
            popup.innerHTML = `
                <div class="reward-popup-header">
                    <h3 class="reward-popup-title">New Song Unlocked!</h3>
                    <button class="reward-popup-close">×</button>
                </div>
                <div class="reward-popup-content">
                    <img src="Loading Screen/Julia.png" alt="Julia Portrait" class="reward-popup-image">
                    <p class="reward-popup-text">You've received Julia's Theme:<br>"Forest Wanderer"</p>
                    <button class="claim-button">Claim</button>
                </div>
            `;

            document.body.appendChild(popup);

            // Close button handler
            popup.querySelector('.reward-popup-close').addEventListener('click', () => {
                popup.remove();
            });

            // Claim button handler
            popup.querySelector('.claim-button').addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;

                try {
                    const userSongsRef = ref(database, `users/${user.uid}/Songs`);
                    const updates = {};
                    updates['Forest Wanderer (Julia Theme)'] = 1;
                    await update(userSongsRef, updates);
                    
                    // Close popup after claiming
                    popup.remove();
                    
                    // Refresh music player to include new song
                    window.location.reload();
                } catch (error) {
                    console.error('Error claiming Julia song:', error);
                }
            });
        }
    </script>
    <style>
        /* Add new currency box styles */
        .currency-box {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(145deg, rgba(139, 0, 0, 0.95), rgba(178, 34, 34, 0.95));
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #FF4500;
            box-shadow: 0 0 20px rgba(255, 69, 0, 0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(5px);
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            transition: transform 0.3s ease;
        }

        .currency-item:hover {
            transform: translateX(5px);
        }

        .currency-item img {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.3));
        }

        .currency-item span {
            color: #e0ffff;
            font-size: 1.1em;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Menu styles */
        .menu {
            background-color: rgba(46, 0, 0, 0.9);
            border-bottom: 1px solid #d10000;
        }

        .menu a {
            color: #e0ffff;
            transition: all 0.3s ease;
        }

        .menu a:hover {
            background-color: rgba(209, 0, 0, 0.2);
            color: #ffd700;
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Play button styles */
        .play-button {
            background: linear-gradient(45deg, #d10000, #20b2aa);
            color: #ffffff;
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(209, 0, 0, 0.4);
        }

        .play-button:hover {
            background: linear-gradient(45deg, #ffd700, #daa520);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Quest Window Styles */
        #quest-window .modal-content {
            background: rgba(46, 0, 0, 0.95);
            color: #e0ffff;
            max-width: 1000px;
            width: 95%;
            padding: 30px;
            border: 1px solid #d10000;
            box-shadow: 0 0 30px rgba(209, 0, 0, 0.2);
        }

        .quest-points {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .quest-points .currency-icon {
            width: 24px;
            height: 24px;
        }

        .quest-reward .currency-icon,
        .claim-button .currency-icon {
            width: 16px;
            height: 16px;
        }

        .quest-list {
            margin-bottom: 30px;
        }

        .quest-item {
            background: rgba(209, 0, 0, 0.15);
            border: 1px solid rgba(209, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quest-info {
            flex-grow: 1;
        }

        .progress-bar {
            background: rgba(209, 0, 0, 0.1);
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            background: linear-gradient(90deg, #d10000, #ffd700);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .quest-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0 20px;
        }

        .claim-button {
            background: #d10000;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .claim-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        /* Awards Window Styles */
        #awards-window {
            background: rgba(46, 0, 0, 0.9);
        }

        #awards-window .modal-content {
            background: rgba(46, 0, 0, 0.95);
            color: #e0ffff;
            border: 1px solid #d10000;
            box-shadow: 0 0 30px rgba(209, 0, 0, 0.2);
        }

        .award-item {
            background: rgba(209, 0, 0, 0.15);
            border: 1px solid rgba(209, 0, 0, 0.3);
            box-shadow: 0 0 15px rgba(209, 0, 0, 0.2);
        }

        .award-info h3 {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .skin-name {
            color: #e0ffff;
        }

        .sale-price {
            color: #ffd700;
            font-weight: bold;
        }

        .purchase-button {
            background: #d10000;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .purchase-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .purchase-button.disabled {
            background: #571a1a;
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Profile styles */
        .profile-container {
            background: rgba(46, 0, 0, 0.9);
            border: 1px solid #d10000;
        }

        .profile-menu {
            background: rgba(46, 0, 0, 0.95);
            border: 1px solid #d10000;
            box-shadow: 0 0 20px rgba(209, 0, 0, 0.3);
        }

        .profile-menu li:hover {
            background: rgba(209, 0, 0, 0.2);
            color: #ffd700;
        }

        /* Bottom buttons styles */
        .bottom-button {
            background: rgba(46, 0, 0, 0.9);
            border: 1px solid #d10000;
            box-shadow: 0 0 15px rgba(209, 0, 0, 0.2);
        }

        .bottom-button:hover {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .button-title {
            color: #e0ffff;
            text-shadow: 0 0 10px rgba(209, 0, 0, 0.5);
        }

        /* Music player styles */
        .music-player {
            background: rgba(46, 0, 0, 0.95);
            border: 1px solid #d10000;
            box-shadow: 0 0 20px rgba(209, 0, 0, 0.3);
        }

        .music-player-toggle {
            background: #d10000;
            color: #ffffff;
        }

        .music-player-toggle:hover {
            background: #ffd700;
        }

        .controls button {
            color: #e0ffff;
            background: rgba(209, 0, 0, 0.2);
        }

        .controls button:hover {
            background: rgba(255, 215, 0, 0.3);
            color: #ffffff;
        }

        .playlist {
            background: rgba(46, 0, 0, 0.95);
            border-top: 1px solid #d10000;
        }

        .playlist-items li:hover {
            background: rgba(209, 0, 0, 0.2);
            color: #ffd700;
        }

        .volume-slider {
            background: rgba(209, 0, 0, 0.2);
        }

        .volume-slider::-webkit-slider-thumb {
            background: #ffd700;
        }

        .volume-slider::-moz-range-thumb {
            background: #ffd700;
        }

        /* ... existing styles ... */

        /* Currency Display Styles */
        .currency-display {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding: 10px 20px;
            margin: 52px 20px;
            background: rgba(46, 0, 0, 0.95);
            border: 1px solid #d10000;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(209, 0, 0, 0.3);
            backdrop-filter: blur(5px);
            width: calc(100% - 40px); /* Full width minus margins */
            max-width: 300px; /* Same width as profile container */
            margin-left: auto;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            transition: transform 0.3s ease;
        }

        .currency-item:hover {
            transform: translateY(-2px);
        }

        .currency-item img {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.3));
        }

        .currency-item span {
            color: #e0ffff;
            font-size: 1.1em;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Menu styles */
        .menu {
            background-color: rgba(46, 0, 0, 0.9);
            border-bottom: 1px solid #d10000;
        }

        .menu a {
            color: #e0ffff;
            transition: all 0.3s ease;
        }

        .menu a:hover {
            background-color: rgba(209, 0, 0, 0.2);
            color: #ffd700;
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Play button styles */
        .play-button {
            background: linear-gradient(45deg, #d10000, #b22020);
            color: #ffffff;
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(209, 0, 0, 0.4);
        }

        .play-button:hover {
            background: linear-gradient(45deg, #ffd700, #daa520);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Quest Window Styles */
        #quest-window .modal-content {
            background: rgba(46, 0, 0, 0.95);
            color: #e0ffff;
            max-width: 1000px;
            width: 95%;
            padding: 30px;
            border: 1px solid #d10000;
            box-shadow: 0 0 30px rgba(209, 0, 0, 0.2);
        }

        .quest-points {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            font-size: 1.2em;
        }

        .quest-points .currency-icon {
            width: 24px;
            height: 24px;
        }

        .quest-reward .currency-icon,
        .claim-button .currency-icon {
            width: 16px;
            height: 16px;
        }

        .quest-list {
            margin-bottom: 30px;
        }

        .quest-item {
            background: rgba(209, 0, 0, 0.15);
            border: 1px solid rgba(209, 0, 0, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quest-info {
            flex-grow: 1;
        }

        .progress-bar {
            background: rgba(209, 0, 0, 0.1);
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            background: linear-gradient(90deg, #d10000, #ffd700);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .quest-reward {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0 20px;
        }

        .claim-button {
            background: #d10000;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .claim-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        /* Awards Window Styles */
        #awards-window {
            background: rgba(46, 0, 0, 0.9);
        }

        #awards-window .modal-content {
            background: rgba(46, 0, 0, 0.95);
            color: #e0ffff;
            border: 1px solid #d10000;
            box-shadow: 0 0 30px rgba(209, 0, 0, 0.2);
        }

        .award-item {
            background: rgba(209, 0, 0, 0.15);
            border: 1px solid rgba(209, 0, 0, 0.3);
            box-shadow: 0 0 15px rgba(209, 0, 0, 0.2);
        }

        .award-info h3 {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .skin-name {
            color: #e0ffff;
        }

        .sale-price {
            color: #ffd700;
            font-weight: bold;
        }

        .purchase-button {
            background: #d10000;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .purchase-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .purchase-button.disabled {
            background: #571a1a;
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Profile styles */
        .profile-container {
            background: rgba(46, 0, 0, 0.9);
            border: 1px solid #d10000;
        }

        .profile-menu {
            background: rgba(46, 0, 0, 0.95);
            border: 1px solid #d10000;
            box-shadow: 0 0 20px rgba(209, 0, 0, 0.3);
        }

        .profile-menu li:hover {
            background: rgba(209, 0, 0, 0.2);
            color: #ffd700;
        }

        /* Bottom buttons styles */
        .bottom-button {
            background: rgba(46, 0, 0, 0.9);
            border: 1px solid #d10000;
            box-shadow: 0 0 15px rgba(209, 0, 0, 0.2);
        }

        .bottom-button:hover {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .button-title {
            color: #e0ffff;
            text-shadow: 0 0 10px rgba(209, 0, 0, 0.5);
        }

        /* Music player styles */
        .music-player {
            background: rgba(46, 0, 0, 0.95);
            border: 1px solid #d10000;
            box-shadow: 0 0 20px rgba(209, 0, 0, 0.3);
        }

        .music-player-toggle {
            background: #d10000;
            color: #ffffff;
        }

        .music-player-toggle:hover {
            background: #ffd700;
        }

        .controls button {
            color: #e0ffff;
            background: rgba(209, 0, 0, 0.2);
        }

        .controls button:hover {
            background: rgba(255, 215, 0, 0.3);
            color: #ffffff;
        }

        .playlist {
            background: rgba(46, 0, 0, 0.95);
            border-top: 1px solid #d10000;
        }

        .playlist-items li:hover {
            background: rgba(209, 0, 0, 0.2);
            color: #ffd700;
        }

        .volume-slider {
            background: rgba(209, 0, 0, 0.2);
        }

        .volume-slider::-webkit-slider-thumb {
            background: #ffd700;
        }

        .volume-slider::-moz-range-thumb {
            background: #ffd700;
        }
    </style>
</head>
<body>
    <!-- Add currency box after body tag -->
    <div class="play-button-container">
        <a href="Game Modes.html" class="play-button">
            <div class="play-button-inner">
                <div class="play-icon">
                    <i class="fas fa-play"></i>
                </div>
                <span class="play-text">PLAY</span>
            </div>
            <div class="play-button-glow"></div>
        </a>
    </div>
    <!-- Replace the smoke-container div with this snow container -->
    <div class="snowfall-container"></div>

    <!-- Video Background -->
    <video id="video-background" autoplay muted loop>
        <source src="Event/Eventvideo.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <!-- Menu without play button -->
    <div class="menu">
        <div class="menu-items">
            <a href="home.html" class="menu-link active">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="Store.html" class="menu-link">
                <i class="fas fa-store"></i>
                <span>Store</span>
            </a>
            <a href="event.html" class="menu-link">
                <i class="fas fa-calendar"></i>
                <span>Event</span>
            </a>
            <a href="Team Builder.html" class="menu-link">
                <i class="fas fa-users"></i>
                <span>Team Builder</span>
            </a>
            <a href="statistics.html" class="menu-link">
                <i class="fas fa-chart-bar"></i>
                <span>Statistics</span>
            </a>
        </div>
    </div>

    <!-- Profile Container -->
    <div id="profile-info" class="profile-container">
        <div class="username-title-container" onclick="toggleProfileMenu(event)">
            <h2 id="username-display"></h2>
            <div id="title-display"></div>
        </div>
        <img id="profile-image" src="" alt="Profile Icon" class="profile-icon" onclick="toggleProfileMenu(event)">
    </div>

    <!-- Currency Display -->
    <div class="currency-display">
        <div class="currency-item">
            <img src="res/img/fm.png" alt="FM">
            <span id="currency-amount">0</span>
        </div>
        <div class="currency-item">
            <img src="res/img/cm.png" alt="CM">
            <span id="cm-amount">0</span>
        </div>
        <div class="currency-item">
            <img src="res/img/qp.png" alt="QP">
            <span id="qp-amount">0</span>
        </div>
    </div>

    <!-- Profile Menu Pop-up -->
    <div id="profile-menu" class="profile-menu">
        <ul>
            <li onclick="window.location.href='character-progression.html'">Character Progression</li>
            <li onclick="window.location.href='Profile.html'">Profile</li>
            <li onclick="openChangeIconModal()">Change Icon</li>
            <li onclick="window.location.href='Collection.html'">Collection</li>
            <li onclick="logOut()">Log Out</li>
        </ul>
    </div>

    <!-- Modal for Changing Profile Icon -->
    <div id="change-icon-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangeIconModal()">&times;</span>
            <h2>Select Your Profile Icon</h2>
            <div id="icon-list">
                <!-- Icons will be dynamically loaded here -->
            </div>
        </div>
    </div>
    <!-- Champion Selector -->
    <div id="champion-selector-container">

        <div id="champion-selector">
            <a href="ch/Julia.html" class="champion-link">
                <img src="Icons/Julia.png" alt="Julia" class="champion-image">
                <span class="champion-name">Julia</span>
            </a>
            <a href="ch/Birdie.html" class="champion-link">
                <img src="Icons/Birdie.png" alt="Birdie" class="champion-image">
                <span class="champion-name">Birdie</span>
            </a>
            <a href="ch/Erron Black.html" class="champion-link">
                <img src="Icons/Erron Black.png" alt="Erron Black" class="champion-image">
                <span class="champion-name">Erron Black</span>
            </a>
            <a href="ch/Cham Cham.html" class="champion-link">
                <img src="Icons/Cham Cham.png" alt="Cham Cham" class="champion-image">
                <span class="champion-name">Cham Cham</span>
            </a>
            <a href="ch/Morrigan.html" class="champion-link">
                <img src="Icons/Morrigan.png" alt="Morrigan" class="champion-image">
                <span class="champion-name">Morrigan</span>
            </a>
            <a href="ch/Jun.html" class="champion-link">
                <img src="Icons/Jun.png" alt="Jun" class="champion-image">
                <span class="champion-name">Jun</span>
            </a>
            <a href="ch/Reptile.html" class="champion-link">
                <img src="Icons/Reptile.png" alt="Reptile" class="champion-image">
                <span class="champion-name">Reptile</span>
            </a>
            <a href="ch/Akuma.html" class="champion-link">
                <img src="Icons/Akuma.png" alt="Akuma" class="champion-image">
                <span class="champion-name">Akuma</span>
            </a>
            <a href="ch/Elphelt.html" class="champion-link">
                <img src="Icons/Elphelt.png" alt="Elphelt" class="champion-image">
                <span class="champion-name">Elphelt</span>
            </a>
            <a href="ch/Kotal Kahn.html" class="champion-link">
                <img src="Icons/Kotal Kahn.png" alt="Kotal Kahn" class="champion-image">
                <span class="champion-name">Kotal Kahn</span>
            </a>
            <a href="ch/Scorpion.html" class="champion-link">
                <img src="Icons/Scorpion.png" alt="Scorpion" class="champion-image">
                <span class="champion-name">Scorpion</span>
            </a>
            <a href="ch/Peacock.html" class="champion-link">
                <img src="Icons/Peacock.png" alt="Peacock" class="champion-image">
                <span class="champion-name">Peacock</span>
            </a>
            <a href="ch/Angel.html" class="champion-link">
                <img src="Icons/Angel.png" alt="Angel" class="champion-image">
                <span class="champion-name">Angel</span>
            </a>
            <a href="ch/Astaroth.html" class="champion-link">
                <img src="Icons/Astaroth.png" alt="Astaroth" class="champion-image">
                <span class="champion-name">Astaroth</span>
            </a>
            <a href="ch/Ibuki.html" class="champion-link">
                <img src="Icons/Ibuki.png" alt="Ibuki" class="champion-image">
                <span class="champion-name">Ibuki</span>
            </a>
            <a href="ch/R Mika.html" class="champion-link">
                <img src="Icons/R.Mika.png" alt="R.Mika" class="champion-image">
                <span class="champion-name">R.Mika</span>
            </a>
            <a href="ch/Raiden.html" class="champion-link">
                <img src="Icons/Raiden.png" alt="Raiden" class="champion-image">
                <span class="champion-name">Raiden</span>
            </a>
            <a href="ch/Yugo.html" class="champion-link">
                <img src="Icons/Yugo.png" alt="Yugo" class="champion-image">
                <span class="champion-name">Yugo</span>
            </a>
            <a href="ch/Talim.html" class="champion-link">
                <img src="Icons/Talim.png" alt="Talim" class="champion-image">
                <span class="champion-name">Talim</span>
            </a>
            <a href="ch/Noel.html" class="champion-link">
                <img src="Icons/Noel.png" alt="Noel" class="champion-image">
                <span class="champion-name">Noel</span>
            </a>
            <a href="ch/Blanka.html" class="champion-link">
                <img src="Icons/Blanka.png" alt="Blanka" class="champion-image">
                <span class="champion-name">Blanka</span>
            </a>
            <a href="ch/Nina.html" class="champion-link">
                <img src="Icons/Nina.png" alt="Nina" class="champion-image">
                <span class="champion-name">Nina</span>
            </a>
            <a href="ch/Ayane.html" class="champion-link">
                <img src="Icons/Ayane.png" alt="Ayane" class="champion-image">
                <span class="champion-name">Ayane</span>
            </a>
            <a href="ch/Siegfried.html" class="champion-link">
                <img src="Icons/Siegfried.png" alt="Siegfried" class="champion-image">
                <span class="champion-name">Siegfried</span>
            </a>
            <a href="ch/Shoma.html" class="champion-link">
                <img src="Icons/Shoma.png" alt="Shoma" class="champion-image">
                <span class="champion-name">Shoma</span>
            </a>
            <a href="ch/Juri.html" class="champion-link">
                <img src="Icons/Juri.png" alt="Juri" class="champion-image">
                <span class="champion-name">Juri</span>
            </a>
            <a href="ch/Sub Zero.html" class="champion-link">
                <img src="Icons/Sub Zero.png" alt="Sub Zero" class="champion-image">
                <span class="champion-name">Sub Zero</span>
            </a>
            <a href="ch/Christie.html" class="champion-link">
                <img src="Icons/Christie.png" alt="Christie" class="champion-image">
                <span class="champion-name">Christie</span>
            </a>
            <a href="ch/Kokoro.html" class="champion-link">
                <img src="Icons/Kokoro.png" alt="Kokoro" class="champion-image">
                <span class="champion-name">Kokoro</span>
            </a>
            <a href="ch/Eagle.html" class="champion-link">
                <img src="Icons/Eagle.png" alt="Eagle" class="champion-image">
                <span class="champion-name">Eagle</span>
            </a>
            <a href="ch/Sophitia.html" class="champion-link">
                <img src="Icons/Sophitia.png" alt="Sophitia" class="champion-image">
                <span class="champion-name">Sophitia</span>
            </a>
            <a href="ch/Shizumaru.html" class="champion-link">
                <img src="Icons/Shizumaru.png" alt="Shizumaru" class="champion-image">
                <span class="champion-name">Shizumaru</span>
            </a>
            <a href="ch/Kagome.html" class="champion-link">
                <img src="Icons/Kagome.png" alt="Kagome" class="champion-image">
                <span class="champion-name">Kagome</span>
            </a>
            <a href="ch/Kabal.html" class="champion-link">
                <img src="Icons/Kabal.png" alt="Kabal" class="champion-image">
                <span class="champion-name">Kabal</span>
            </a>
            <a href="ch/Kuma.html" class="champion-link">
                <img src="Icons/Kuma.png" alt="Kuma" class="champion-image">
                <span class="champion-name">Kuma</span>
            </a>
            <a href="ch/Alice.html" class="champion-link">
                <img src="Icons/Alice.png" alt="Alice" class="champion-image">
                <span class="champion-name">Alice</span>
            </a>
            <a href="ch/Shinnok.html" class="champion-link">
                <img src="Icons/Shinnok.png" alt="Shinnok" class="champion-image">
                <span class="champion-name">Shinnok</span>
            </a>
            <a href="ch/FANG.html" class="champion-link">
                <img src="Icons/FANG.png" alt="FANG" class="champion-image">
                <span class="champion-name">FANG</span>
            </a>
            <a href="ch/Lili.html" class="champion-link">
                <img src="Icons/Lili.png" alt="Lili" class="champion-image">
                <span class="champion-name">Lili</span>
            </a>
            <a href="ch/Mega Man.html" class="champion-link">
                <img src="Icons/Mega Man.png" alt="Mega Man" class="champion-image">
                <span class="champion-name">Mega Man</span>
            </a>
            <a href="ch/Mai.html" class="champion-link">
                <img src="Icons/Mai.png" alt="Mai" class="champion-image">
                <span class="champion-name">Mai</span>
            </a>
            <a href="ch/Zasalamel.html" class="champion-link">
                <img src="Icons/Zasalamel.png" alt="Zasalamel" class="champion-image">
                <span class="champion-name">Zasalamel</span>
            </a>
        </div>
    </div>
       <!-- Add these two lines -->
       <script src="recolor-data.js" type="module"></script>
       <script src="advent-calendar.js" type="module"></script>
    <script>
        // Wrap all DOM-dependent code in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase auth state
            initializeAuthState();

            // Create particles
            createParticles();

            // Initialize click handlers for profile image and container
            const profileInfo = document.getElementById('profile-info');
            const profileImage = document.getElementById('profile-image');
            const profileMenu = document.getElementById('profile-menu');
            const usernameDisplay = document.getElementById('username-display');

            // Global toggle function for the profile menu
            window.toggleProfileMenu = function(event) {
                if (event) {
                    event.stopPropagation();
                }
                if (profileMenu) {
                    profileMenu.classList.toggle('show');
                }
            }

            // Add click handlers
            if (profileInfo) {
                profileInfo.addEventListener('click', toggleProfileMenu);
            }
            if (profileImage) {
                profileImage.addEventListener('click', toggleProfileMenu);
            }
            if (usernameDisplay) {
                usernameDisplay.addEventListener('click', toggleProfileMenu);
            }

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (profileMenu && profileMenu.classList.contains('show') && 
                    !profileInfo.contains(event.target) &&
                    !profileMenu.contains(event.target)) {
                    profileMenu.classList.remove('show');
                }
            });

            // Friend list functionality
            const toggleFriendListButton = document.getElementById("toggle-friend-list");
            const friendList = document.getElementById("friend-list");
            const addFriendButton = document.getElementById("add-friend-button");
            const friendNameInput = document.getElementById("friend-name-input");
            const friendListUL = document.getElementById("friend-list-ul");

            if (toggleFriendListButton && friendList) {
                toggleFriendListButton.addEventListener("click", function() {
                    friendList.style.display = friendList.style.display === "none" ? "block" : "none";
                });
            }

            if (addFriendButton && friendNameInput) {
                addFriendButton.addEventListener("click", async function() {
                    const friendName = friendNameInput.value;
                    if (friendName) {
                        try {
                            const userId = auth.currentUser.uid;
                            const usersRef = ref(database, 'users');
                            const snapshot = await get(usersRef);
                            let friendId = null;

                            snapshot.forEach(childSnapshot => {
                                const userData = childSnapshot.val();
                                if (userData.username === friendName) {
                                    friendId = childSnapshot.key;
                                }
                            });

                            if (friendId) {
                                const friendRef = ref(database, 'users/' + userId + '/friends');
                                const newFriendRef = push(friendRef);
                                await set(newFriendRef, {
                                    id: friendId,
                                    name: friendName
                                });
                                friendNameInput.value = '';
                                loadFriendList(userId);
                            } else {
                                alert('Username not found');
                            }
                        } catch (error) {
                            console.error('Error adding friend:', error);
                        }
                    }
                });
            }
        });

        // Functions that don't require immediate DOM access can stay outside
        function profile() {
            window.location.href = 'Profile.html';
        }

        function viewCollection() {
            window.location.href = 'Collection.html';
        }

        function toggleChampionSelector() {
            const championSelector = document.getElementById('champion-selector-container');
            const toggleButton = document.getElementById('toggle-champion-button');
            
            if (championSelector && toggleButton) {
                if (championSelector.style.display === 'none' || championSelector.style.display === '') {
                    championSelector.style.display = 'flex';
                    toggleButton.classList.add('rotated');
                } else {
                    championSelector.style.display = 'none';
                    toggleButton.classList.remove('rotated');
                }
            }
        }

        // Initialize Toggle Button State on Page Load
        document.addEventListener('DOMContentLoaded', function () {
            const championSelector = document.getElementById('champion-selector-container');
            const toggleButton = document.getElementById('toggle-champion-button');

            // Initially show the champion selector
            championSelector.style.display = 'flex';
        });

        // ===================== Particle Effect Initialization =====================
    </script>
    <!-- Advent Calendar Window -->
    <div id="advent-calendar-window" class="modal-window" style="display: none;">
        <div class="advent-calendar-content">
            <span class="close-button" data-action="closeCalendar">&times;</span>
            <h2>December 2024</h2>
            <div class="calendar-grid">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Daily Reward Popup -->
    <div id="daily-reward-popup" style="display: none;">
        <div class="reward-content">
            <span class="close-button" data-action="closeReward">&times;</span>
            <h3>Daily Reward</h3>
            <img id="reward-image" src="" alt="Reward">
            <p id="reward-name"></p>
        </div>
    </div>

    <script type="module">
        import { closeAdventCalendar, closeRewardPopup } from './advent-calendar.js';
        
        // Add click handlers for close buttons
        document.addEventListener('click', (e) => {
            if (e.target.closest('.close-button[data-action="closeCalendar"]')) {
                closeAdventCalendar();
            } else if (e.target.closest('.close-button[data-action="closeReward"]')) {
                closeRewardPopup();
            }
        });
    </script>

    <!-- Add this after the Firebase initialization -->
    <script>
        // Add this after the Firebase initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize profile menu click handler
            document.addEventListener('click', function(event) {
                const profileMenu = document.getElementById('profile-menu');
                const profileInfo = document.getElementById('profile-info');
                
                if (profileMenu && profileInfo) {
                    // Close menu if clicking outside
                    if (!profileInfo.contains(event.target) && !profileMenu.contains(event.target)) {
                        profileMenu.classList.remove('show');
                    }
                }
            });

            // Initialize profile container click handler
            const profileContainer = document.getElementById('profile-info');
            if (profileContainer) {
                profileContainer.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const profileMenu = document.getElementById('profile-menu');
                    if (profileMenu) {
                        profileMenu.classList.toggle('show');
                    }
                });
            }

            // Initialize auth state
            initializeAuthState();
        });
    </script>

    <!-- Bottom Buttons Container -->
    <div class="bottom-buttons-container">
        <!-- Battlepass Button -->
        <div class="bottom-button" onclick="window.location.href='battlepass.html'">
            <img src="Event/Lunar Festival 2024 Event.png" alt="Battlepass">
            <div class="button-content">
                <h3 class="button-title">Battlepass</h3>
            </div>
        </div>

        <!-- Quest Button -->
        <div class="bottom-button" onclick="openQuestWindow()">
            <img src="res/img/questbackground.webp" alt="Quests">
            <div class="button-content">
                <h3 class="button-title">Quests</h3>
            </div>
        </div>

        <!-- Changelog Button -->
        <div class="bottom-button" onclick="window.location.href='changelog.html'">
            <img src="Default Splash/Shoma.png" alt="Changelog">
            <div class="button-content">
                <h3 class="button-title">Changelog</h3>
            </div>
        </div>

        <!-- Lamp of Luck Button -->
        <div class="bottom-button" onclick="openLunarWindow()">
            <img src="res/img/lamp_of_luck.jpeg" alt="Lanterns of Luck">
            <div class="button-content">
                <h3 class="button-title">Lanterns of Luck</h3>
            </div>
        </div>
    </div>

                <!-- Quest Window -->
                <div id="quest-window" class="modal" style="display: none;">
                    <div class="modal-content">
                        <span class="close" onclick="closeQuestWindow()">&times;</span>
                        <h2>Quests</h2>
                        <div class="quest-points">
                            <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                            <span id="quest-points-amount">0</span>
                        </div>
                        
                        <!-- Quest Progress Section -->
                        <div class="quest-progress-section">
                            <h3>Daily Quests</h3>
                            <div class="quest-list">
                                <div class="quest-item">
                                    <div class="quest-info">
                                        <h3>Win 2 Games</h3>
                                        <div class="progress-bar">
                                            <div class="progress" id="win-games-progress"></div>
                                        </div>
                                        <span class="progress-text">0/2</span>
                                    </div>
                                    <div class="quest-reward">
                                        <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                                        <span>75</span>
                                    </div>
                                    <button class="claim-button" onclick="claimQuestReward('win-games', 75)">Claim</button>
                                </div>
                                <div class="quest-item">
                                    <div class="quest-info">
                                        <h3>Win 2 Games in a Row</h3>
                                        <div class="progress-bar">
                                            <div class="progress" id="win-streak-progress"></div>
                                        </div>
                                        <span class="progress-text">0/2</span>
                                    </div>
                                    <div class="quest-reward">
                                        <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                                        <span>70</span>
                                    </div>
                                    <button class="claim-button" onclick="claimQuestReward('win-streak', 70)">Claim</button>
                                </div>
                                <div class="quest-item">
                                    <div class="quest-info">
                                        <h3>Lose 2 Games</h3>
                                        <div class="progress-bar">
                                            <div class="progress" id="lose-games-progress"></div>
                                        </div>
                                        <span class="progress-text">0/2</span>
                                    </div>
                                    <div class="quest-reward">
                                        <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                                        <span>25</span>
                                    </div>
                                    <button class="claim-button" onclick="claimQuestReward('lose-games', 25)">Claim</button>
                                </div>
                            </div>
                        </div>

                        <!-- Quest Rewards Section -->
                        <div class="quest-rewards-section">
                            <h3>Quest Rewards</h3>
                            <div class="rewards-grid">
                                <div class="reward-item">
                                    <img src="res/img/lunar_ticket.png" alt="Lunar Ticket">
                                    <h4>Lunar Ticket</h4>
                                    <div class="reward-cost">
                                        <img src="res/img/qp.png" alt="Quest Points">
                                        <span>1500 QP</span>
                                    </div>
                                    <button class="claim-button" onclick="claimQuestReward('lunar-ticket', 1500)">
                                        <i class="fas fa-ticket-alt"></i>
                                        Claim
                                    </button>
                                </div>
                                <div class="reward-item">
                                    <img src="res/img/cm.png" alt="Character Money">
                                    <h4>8000 Character Money</h4>
                                    <div class="reward-cost">
                                        <img src="res/img/qp.png" alt="Quest Points">
                                        <span>1000 QP</span>
                                    </div>
                                    <button class="claim-button" id="cm-reward-button" onclick="claimQuestReward('cm-reward', 1000)">
                                        <i class="fas fa-coins"></i>
                                        Claim
                                    </button>
                                </div>
                                <div class="reward-item">
                                    <img src="Stickers/lunar_lantern_smile.png" alt="Lunar Lantern Smile">
                                    <h4>Lunar Lantern Smile Sticker</h4>
                                    <div class="reward-cost">
                                        <img src="res/img/qp.png" alt="Quest Points">
                                        <span>375 QP</span>
                                    </div>
                                    <button class="claim-button" onclick="claimQuestReward('lunar-lantern-smile', 375)">
                                        <i class="fas fa-gift"></i>
                                        Claim
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

    <link rel="stylesheet" href="queststyle.css">

    <script>
                    // ... existing script ...

                    // Quest Window Functions
                    async function openQuestWindow() {
    try {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const questWindow = document.getElementById('quest-window');
        if (questWindow) {
            questWindow.style.display = 'block';
            await updateQuestPoints();
            await updateQuestProgress();
            await updateCMRewardButton(); // Add this line
        }
    } catch (error) {
        console.error('Error opening quest window:', error);
    }
}
            
                    async function claimQuestReward(questId, reward) {
                        const auth = window.firebaseAuth;
                        const database = window.firebaseDatabase;
                        const user = auth.currentUser;
                        if (!user) return;

                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const userSnapshot = await get(userRef);
                        const userData = userSnapshot.val();

                        if (!userData) return;

                        // Check if it's a lunar ticket reward
                        if (questId === 'lunar-ticket') {
                            const currentQP = userData.questPoints || 0;
                            
                            if (currentQP >= reward) {
                                const updates = {};
                                
                                // Deduct quest points
                                updates['questPoints'] = currentQP - reward;
                                
                                // Add lunar ticket
                                updates['lunarTickets'] = (userData.lunarTickets || 0) + 1;
                                
                                // Apply updates
                                await update(userRef, updates);
                                
                                // Update displays
                                document.getElementById('quest-points-amount').textContent = currentQP - reward;
                                document.getElementById('lunar-ticket-amount').textContent = (userData.lunarTickets || 0) + 1;
                                
                                alert('Successfully claimed 1 Lunar Ticket!');
                            } else {
                                alert('Not enough Quest Points!');
                            }
                            return;
                        }

                        // Check if it's the CM reward
                        if (questId === 'cm-reward') {
                            const currentQP = userData.questPoints || 0;
                            const cmRewardClaimed = userData.cmRewardClaimed || false;

                            if (cmRewardClaimed) {
                                alert('You have already claimed this reward!');
                                // Disable the button
                                document.getElementById('cm-reward-button').disabled = true;
                                return;
                            }
                            
                            if (currentQP >= reward) {
                                const updates = {};
                                
                                // Deduct quest points
                                updates['questPoints'] = currentQP - reward;
                                
                                // Add CM
                                updates['CM'] = (userData.CM || 0) + 8000;
                                
                                // Mark as claimed
                                updates['cmRewardClaimed'] = true;
                                
                                // Apply updates
                                await update(userRef, updates);
                                
                                // Update displays
                                document.getElementById('quest-points-amount').textContent = currentQP - reward;
                                document.getElementById('cm-amount').textContent = (userData.CM || 0) + 8000;
                                document.getElementById('cm-reward-button').disabled = true;
                                
                                alert('Successfully claimed 8000 Character Money!');
                            } else {
                                alert('Not enough Quest Points!');
                            }
                            return;
                        }

                        // Handle regular quest rewards
                        const questRef = ref(database, `users/${userId}/quests/${questId}`);
                        const questSnapshot = await get(questRef);
                        const questData = questSnapshot.val();

                        if (questData && questData.completed && !questData.claimed) {
                            const updates = {};
                            
                            // Reset quest progress and status
                            updates[`users/${userId}/quests/${questId}/progress`] = 0;
                            updates[`users/${userId}/quests/${questId}/completed`] = false;
                            updates[`users/${userId}/quests/${questId}/claimed`] = false;
                            
                            // Add quest points
                            const currentQuestPoints = userData.questPoints || 0;
                            updates[`users/${userId}/questPoints`] = currentQuestPoints + reward;

                            // Apply all updates
                            await update(ref(database), updates);
                            
                            // Update display
                            await updateQuestProgress();
                        }

                        // Add a new quest reward for lunar_lantern_smile
                        if (questId === 'lunar-lantern-smile') {
                            const currentQP = userData.questPoints || 0;
                            const lanternSmileClaimed = userData.lanternSmileClaimed || false;

                            if (lanternSmileClaimed) {
                                alert('You have already claimed this reward!');
                                // Disable the button
                                document.querySelector('button[onclick="claimQuestReward(\'lunar-lantern-smile\', 375)"]').disabled = true;
                                return;
                            }
                            
                            if (currentQP >= reward) {
                                const updates = {};
                                
                                // Deduct quest points
                                updates['questPoints'] = currentQP - reward;
                                
                                // Add lunar_lantern_smile to user's inventory (with capital S in Stickers)
                                updates['Stickers/lunar_lantern_smile'] = 1;
                                
                                // Mark as claimed
                                updates['lanternSmileClaimed'] = true;
                                
                                // Apply updates
                                await update(userRef, updates);
                                
                                // Update displays
                                document.getElementById('quest-points-amount').textContent = currentQP - reward;
                                document.querySelector('button[onclick="claimQuestReward(\'lunar-lantern-smile\', 375)"]').disabled = true;
                                alert('Successfully claimed Lunar Lantern Smile!');
                            } else {
                                alert('Not enough Quest Points!');
                            }
                            return;
                        }
                    }

                    async function updateQuestPoints() {
                        const auth = window.firebaseAuth;
                        const database = window.firebaseDatabase;
                        const user = auth.currentUser;
                        if (!user) return;

                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();
                        const questPointsDisplay = document.getElementById('quest-points-amount');
                        if (questPointsDisplay) {
                            questPointsDisplay.textContent = userData?.questPoints || 0;
                        }
                    }

                    function closeQuestWindow() {
                        const questWindow = document.getElementById('quest-window');
                        if (questWindow) {
                            questWindow.style.display = 'none';
                        }
                    }

                    async function unlockRecolor(recolorId, cost) {
                        // Remove this function
                    }

                    async function unlockAtlantisReward(rewardId, cost, type) {
                        // Remove this function
                    }

                    function toggleAtlantisSongDemo() {
                        // Remove this function
                    }

                    // Global variables for demo player
                    let atlantisDemoPlaying = false;
                    let atlantisDemoTimeout = null;

                    function toggleAtlantisSongDemo() {
                        // Remove this function
                    }

                    // Add function to check CM reward claim status on window open
                    async function updateCMRewardButton() {
                        const auth = window.firebaseAuth;
                        const database = window.firebaseDatabase;
                        const user = auth.currentUser;
                        if (!user) return;

                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();

                        if (userData && userData.cmRewardClaimed) {
                            const button = document.getElementById('cm-reward-button');
                            if (button) {
                                button.disabled = true;
                                button.innerHTML = '<i class="fas fa-check"></i> Claimed';
                            }
                        }

                        // Check Lunar Lantern Smile reward
                        if (userData.lanternSmileClaimed) {
                            const lanternButton = document.querySelector('button[onclick="claimQuestReward(\'lunar-lantern-smile\', 375)"]');
                            if (lanternButton) {
                                lanternButton.disabled = true;
                                lanternButton.textContent = 'Claimed';
                            }
                        }
                    }
    </script>

                <style>
                    /* ... existing styles ... */

                    /* Quest Window Styles */
                    #quest-window .modal-content {
                        background: rgba(46, 0, 0, 0.95);
                        color: #e0ffff;
                        max-width: 1000px;
                        width: 95%;
                        padding: 30px;
                        border: 1px solid #d10000;
                        box-shadow: 0 0 30px rgba(209, 0, 0, 0.2);
                    }

                    .quest-points {
                    display: flex;
                    align-items: center;
                        gap: 10px;
                        margin-bottom: 20px;
                        font-size: 1.2em;
                    }

                    .quest-points .currency-icon {
                    width: 24px;
                    height: 24px;
                }

                    .quest-reward .currency-icon,
                    .claim-button .currency-icon {
                        width: 16px;
                        height: 16px;
                    }

                    .quest-list {
                        margin-bottom: 30px;
                    }

                    .quest-item {
                        background: rgba(209, 0, 0, 0.15);
                        border: 1px solid rgba(209, 0, 0, 0.3);
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 15px;
                    display: flex;
                        justify-content: space-between;
                    align-items: center;
                    }

                    .quest-info {
                        flex-grow: 1;
                    }

                    .progress-bar {
                        background: rgba(209, 0, 0, 0.1);
                        height: 10px;
                        border-radius: 5px;
                        margin: 10px 0;
                        overflow: hidden;
                    }

                    .progress {
                        background: linear-gradient(90deg, #d10000, #ffd700);
                        height: 100%;
                        width: 0%;
                        transition: width 0.3s ease;
                    }

                    .quest-reward {
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        margin: 0 20px;
                    }

                    .claim-button {
                        background: #d10000;
                        color: #ffffff;
                        border: 1px solid rgba(255, 215, 0, 0.3);
                        padding: 6px 12px;
                        border-radius: 5px;
                    cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 0.9em;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                    }

                    .claim-button:hover {
                        background: #ffd700;
                        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
                        transform: translateY(-2px);
                    }

                    .recolors-section {
                        margin-top: 30px;
                    }

                    .recolors-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }

                    .recolor-item {
                        background: rgba(209, 0, 0, 0.15);
                    padding: 15px;
                        border-radius: 8px;
                        text-align: center;
                }

                    .recolor-item img {
                    width: 100%;
                        height: auto;
                        border-radius: 5px;
                        margin-bottom: 10px;
                    }

                    .unlock-button {
                        background: #d10000;
                        color: #ffffff;
                        border: 1px solid rgba(255, 215, 0, 0.3);
                        padding: 6px 12px;
                        border-radius: 5px;
                    cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        margin: 10px auto;
                    transition: all 0.3s ease;
                }

                    .unlock-button:hover {
                        background: #ffd700;
                        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
                    transform: translateY(-2px);
                    }

                    .currency-icon {
                        width: 20px;
                        height: 20px;
                    }

                    /* Demo Player Styles */
                    .demo-player {
                        margin-top: 10px;
                    }

                    .demo-button {
                        background: linear-gradient(135deg, #4d88b7, #90caf9);
                        border: 2px solid rgba(255, 255, 255, 0.8);
                        border-radius: 20px;
                        padding: 8px 16px;
                        color: white;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin: 0 auto;
                        font-size: 0.9em;
                    }

                    .demo-button:hover {
                        transform: scale(1.05);
                        box-shadow: 0 0 15px rgba(144, 202, 249, 0.6);
                        border-color: white;
                    }

                    .demo-button:active {
                        transform: scale(0.95);
                    }

                    .demo-button i {
                        font-size: 1.1em;
                        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
                    }
                </style>

    <!-- 2024 Award Winners Window -->
    <div id="awards-window" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAwardsWindow()">&times;</span>
            <h2>2024 Award Winners</h2>
            <div class="awards-list">
                <div class="award-item">
                    <div class="award-info">
                        <h3>Highest Winrate: Shizumaru</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Superhero Shizumaru.png" alt="Superhero Shizumaru" class="award-skin-image">
                        </div>
                        <div class="skin-name">Superhero Shizumaru</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">3000</span>
                            <span class="sale-price">1500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Superhero Shizumaru', 1500)">Purchase for 1500 FM</button>
                    </div>
                </div>
                <div class="award-item">
                    <div class="award-info">
                        <h3>Most Picked: Shizumaru</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Desert Demon Shizumaru.png" alt="Desert Demon Shizumaru" class="award-skin-image">
                        </div>
                        <div class="skin-name">Desert Demon Shizumaru</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">3000</span>
                            <span class="sale-price">1500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Desert Demon Shizumaru', 1500)">Purchase for 1500 FM</button>
                    </div>
                </div>
                <div class="award-item">
                    <div class="award-info">
                        <h3>Best E-sport: Noel</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Underworld Demon Noel.png" alt="Underworld Demon Noel" class="award-skin-image">
                        </div>
                        <div class="skin-name">Underworld Demon Noel</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">3000</span>
                            <span class="sale-price">1500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Underworld Demon Noel', 1500)">Purchase for 1500 FM</button>
                    </div>
                </div>
                <div class="award-item">
                    <div class="award-info">
                        <h3>Community Favourite: Shoma</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Skater Shoma.png" alt="Skater Shoma" class="award-skin-image">
                        </div>
                        <div class="skin-name">Skater Shoma</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">1000</span>
                            <span class="sale-price">500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Skater Shoma', 500)">Purchase for 500 FM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Awards Window Styles */
        #awards-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 6000; /* Increased by 5000 */
            background: rgba(46, 0, 0, 0.9);
        }

        #awards-window .modal-content {
            background: rgba(46, 0, 0, 0.95);
            color: #e0ffff;
            max-width: 1400px;
            width: 95%;
            padding: 30px;
            border: 1px solid #d10000;
            position: relative;
        }

        .awards-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px; /* Increased gap for better spacing */
            margin-top: 20px;
            padding: 0 20px; /* Added padding for better edge spacing */
        }

        .award-item {
            background: rgba(209, 0, 0, 0.15);
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            max-width: 300px;
            margin: 0 auto;
            width: 100%;
        }

        .award-info {
            width: 100%;
        }

        .award-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #ffd700;
        }

        .image-container {
            width: 100%;
            padding-top: 171.43%; /* 1800/1050 ≈ 171.43% for correct aspect ratio */
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .award-skin-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .skin-name {
            font-size: 1.1em;
            margin: 10px 0;
            color: #e0ffff;
        }

        .skin-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
            font-size: 1.1em;
        }

        .original-price {
            text-decoration: line-through;
            color: #999;
        }

        .sale-price {
            color: #ffd700;
            font-weight: bold;
        }

        .purchase-button {
            background: #d10000;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 80%;
            font-size: 1em;
        }

        .purchase-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        .purchase-button.disabled {
            background: #571a1a;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 1200px) {
            .awards-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .awards-list {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Add these functions to your existing script
        window.openAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'block';
                updateAwardButtons();
            }
        }

        window.closeAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'none';
            }
        }

        async function updateAwardButtons() {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            const ownedSkins = userData.skins || {};

            const awardSkins = [
                'Superhero Shizumaru',
                'Desert Demon Shizumaru',
                'Underworld Demon Noel',
                'Skater Shoma'
            ];

            awardSkins.forEach(skinName => {
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${getPriceForSkin(skinName)})"]`);
                if (button && ownedSkins[skinName]) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }
            });
        }

        function getPriceForSkin(skinName) {
            const prices = {
                'Superhero Shizumaru': 1500,
                'Desert Demon Shizumaru': 1500,
                'Underworld Demon Noel': 1500,
                'Skater Shoma': 500
            };
            return prices[skinName] || 0;
        }

        async function purchaseAwardSkin(skinName, price) {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            if (!userData) return;

            const currentFM = userData.FM || 0;
            const ownedSkins = userData.skins || {};

            if (ownedSkins[skinName]) {
                alert('You already own this skin!');
                return;
            }

            if (currentFM >= price) {
                const updates = {};
                updates['FM'] = currentFM - price;
                updates[`skins/${skinName}`] = 1;

                await update(userRef, updates);

                // Update FM display
                const fmDisplay = document.getElementById('currency-amount');
                if (fmDisplay) {
                    fmDisplay.textContent = currentFM - price;
                }

                // Update button state
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${price})"]`);
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }

                alert(`You have successfully purchased ${skinName}!`);
            } else {
                alert("You don't have enough FM to purchase this skin.");
            }
        }
    </script>
    
    <!-- Music Player -->
    <button class="music-player-toggle">
        <i class="fas fa-music"></i>
    </button>
    <div class="music-player">
        <div class="music-player-header">
            <button class="playlist-toggle">
                <i class="fas fa-list"></i>
            </button>
        </div>
        <div class="cover-art">
            <img src="" alt="Cover Art">
        </div>
        <div class="music-info">
            <div class="song-title"></div>
            <div class="artist-name"></div>
        </div>
        <div class="progress-container">
            <div class="progress"></div>
            <div class="progress-handle"></div>
        </div>
        <div class="time-info">
            <span class="current-time">0:00</span>
            <span class="duration">0:00</span>
        </div>
        <div class="controls">
            <button class="shuffle-btn">
                <i class="fas fa-random"></i>
            </button>
            <button class="prev-btn">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="play-btn">
                <i class="fas fa-play"></i>
            </button>
            <button class="next-btn">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
        <div class="volume-control">
            <i class="fas fa-volume-up"></i>
            <input type="range" class="volume-slider" min="0" max="100" value="50">
        </div>
        <div class="playlist">
            <div class="playlist-header">
                <h3>Playlist</h3>
            </div>
            <ul class="playlist-items">
                <!-- Songs will be added here dynamically -->
            </ul>
        </div>
    </div>

    <button class="skin-highlight-toggle">
        <i class="fas fa-star"></i>
    </button>
    <div class="skin-highlight">
        <div class="skin-highlight-header">
            <h3>Featured Skins</h3>
        </div>
        <div class="skin-highlight-content">
            <!-- Skins will be loaded here dynamically -->
        </div>
    </div>

    <!-- Add Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="Skin Image">
            <button id="purchase-button" class="purchase-button" onclick="purchaseSkin()"></button>
            <button class="close-button" onclick="closeLightbox()">x</button>
        </div>
    </div>

    <style>
        /* Common styles */
        :root {
            --primary-color: #d10000;
            --secondary-color: #ffd700;
            --bg-dark: rgba(46, 0, 0, 0.95);
            --text-light: #e0ffff;
            --text-white: #ffffff;
            --shadow-primary: rgba(209, 0, 0, 0.3);
            --shadow-secondary: rgba(255, 215, 0, 0.3);
        }

        /* Base styles with shared properties */
        .currency-box,
        .music-player {
            background: var(--bg-dark);
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 20px var(--shadow-primary);
            backdrop-filter: blur(5px);
        }

        /* Text styles */
        .button-title,
        .currency-item span {
            color: var(--text-light);
            text-shadow: 0 0 10px var(--shadow-primary);
        }

        /* Hover effects */
        .currency-item:hover,
        .menu a:hover {
            transform: translateX(5px);
            color: var(--secondary-color);
        }

        .music-player-toggle:hover,
        .controls button:hover {
            background: rgba(255, 215, 0, 0.3);
            color: var(--text-white);
        }

        /* Button styles */
        .music-player-toggle,
        .controls button {
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .music-player-toggle {
            background: var(--primary-color);
        }

        .controls button {
            background: rgba(209, 0, 0, 0.2);
        }

        /* Menu styles */
        .menu {
            background-color: var(--bg-dark);
            border-bottom: 1px solid var(--primary-color);
        }

        .menu a {
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        /* Play button styles */
        .play-button {
            background: linear-gradient(45deg, var(--primary-color), #20b2aa);
            color: var(--text-white);
            border: 2px solid var(--secondary-color);
            box-shadow: 0 0 15px var(--shadow-primary);
            transition: all 0.3s ease;
        }

        .play-button:hover {
            background: linear-gradient(45deg, var(--secondary-color), #daa520);
            transform: scale(1.05);
        }

        /* Currency box specific styles */
        .currency-box {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            transition: transform 0.3s ease;
        }

        .currency-item img {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 2px var(--shadow-secondary));
        }

        /* Skin Highlight Styles */
        .skin-highlight-toggle {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: var(--bg-dark);
            color: var(--text-light);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--primary-color);
            box-shadow: 0 0 20px var(--shadow-primary);
            transition: all 0.3s ease;
        }

        .skin-highlight-toggle:hover {
            background: rgba(209, 0, 0, 0.2);
            transform: translateY(-50%) scale(1.1);
        }

        .skin-highlight {
            position: fixed;
            left: -300px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background: var(--bg-dark);
            border: 1px solid var(--primary-color);
            border-radius: 10px;
            box-shadow: 0 0 20px var(--shadow-primary);
            z-index: 999;
            transition: left 0.3s ease;
            backdrop-filter: blur(5px);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .skin-highlight.show {
            left: 70px;
        }

        .skin-highlight-header {
            padding: 15px;
            border-bottom: 1px solid var(--primary-color);
            text-align: center;
        }

        .skin-highlight-header h3 {
            margin: 0;
            color: var(--text-light);
            font-size: 1.2em;
        }

        .skin-highlight-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .featured-skin {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            cursor: pointer;
            background: #000; /* Add dark background */
            transform: translate3d(0, 0, 0); /* Force GPU acceleration */
        }

        .featured-skin:hover {
            transform: none; /* Remove container scale */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .featured-skin img {
            width: 100%;
            height: 152px; /* 16:9 aspect ratio for 270px width */
            object-fit: cover;
            display: block;
            image-rendering: -webkit-optimize-contrast; /* Improve image quality in Chrome/Safari */
            image-rendering: crisp-edges; /* Improve image quality in Firefox */
            backface-visibility: hidden; /* Prevent blurry text on transform */
            transform: translateZ(0); /* Force GPU acceleration */
            will-change: transform; /* Optimize for animations */
        }

        .featured-skin:hover img {
            transform: scale(1.05); /* Move scale to img instead of container */
            transition: transform 0.3s ease;
        }

        .featured-skin-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: var(--text-white);
        }

        .featured-skin-name {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .featured-skin-price {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .featured-skin-price img {
            width: 16px;
            height: 16px;
        }

        /* Lightbox Styles */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .lightbox-content {
            position: relative;
            max-width: 80%;
            max-height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .lightbox .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: var(--secondary-color);
            color: var(--text-white);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .purchase-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: grey;
            color: var(--text-white);
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .purchase-button.enabled {
            background-color: var(--secondary-color);
        }

        .purchase-button.disabled {
            background-color: grey;
        }
    </style>

    <script>
        // Make functions globally available
        window.openLightbox = function(src, name, price) {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'flex';
            const img = document.getElementById('lightbox-image');
            img.src = src;
            const purchaseButton = document.getElementById('purchase-button');
            purchaseButton.dataset.skinName = name;
            purchaseButton.dataset.skinPrice = price;
            purchaseButton.textContent = `Purchase for ${price} FM`;
            purchaseButton.className = window.userFM >= price ? 'purchase-button enabled' : 'purchase-button disabled';
            if (window.userSkins && window.userSkins[name]) {
                purchaseButton.classList.add('disabled');
                purchaseButton.textContent = 'Owned';
            }
        };

        window.closeLightbox = function(event) {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'none';
            if (event) {
                event.stopPropagation(); // Prevent the click from bubbling up
            }
        };

        window.purchaseSkin = async function() {
            const purchaseButton = document.getElementById('purchase-button');
            const skinName = purchaseButton.dataset.skinName;
            const skinPrice = parseInt(purchaseButton.dataset.skinPrice, 10);

            if (window.userFM >= skinPrice) {
                const newFM = window.userFM - skinPrice;
                const updates = {};
                updates['FM'] = newFM;
                updates[`skins/${skinName}`] = 1;
                await update(window.userRef, updates);
                document.getElementById('currency-amount').textContent = newFM;
                window.userFM = newFM;
                window.userSkins[skinName] = 1;
                closeLightbox();
                alert(`You have successfully purchased ${skinName}!`);
                
                // Update any matching skins in the highlight panel
                const skinElements = document.querySelectorAll('.featured-skin');
                skinElements.forEach(element => {
                    const nameElement = element.querySelector('.featured-skin-name');
                    if (nameElement && nameElement.textContent === skinName) {
                        element.classList.add('owned');
                    }
                });
            } else {
                alert("You don't have enough FM to purchase this skin.");
            }
        };

        // Initialize skin highlight functionality
        document.addEventListener('DOMContentLoaded', function() {
            const skinHighlightToggle = document.querySelector('.skin-highlight-toggle');
            const skinHighlight = document.querySelector('.skin-highlight');
            const musicPlayerToggle = document.querySelector('.music-player-toggle');
            const musicPlayer = document.querySelector('.music-player');
            
            if (skinHighlightToggle && skinHighlight) {
                skinHighlightToggle.addEventListener('click', function(event) {
                    event.stopPropagation();
                    skinHighlight.classList.toggle('show');
                });

                // Close skin highlight when clicking outside, but ignore music player clicks
                document.addEventListener('click', function(event) {
                    // Ignore clicks on music player elements
                    if (musicPlayer && (musicPlayer.contains(event.target) || musicPlayerToggle.contains(event.target))) {
                        return;
                    }
                    
                    // Handle skin highlight panel
                    if (!skinHighlight.contains(event.target) && 
                        !skinHighlightToggle.contains(event.target) && 
                        skinHighlight.classList.contains('show')) {
                        skinHighlight.classList.remove('show');
                    }
                });

                // Prevent skin highlight panel from closing when clicking inside it
                skinHighlight.addEventListener('click', function(event) {
                    event.stopPropagation();
                });

                // Load featured skins from Firebase
                const auth = window.firebaseAuth;
                const database = window.firebaseDatabase;
                
                const featuredSkinsRef = ref(database, 'Server/skinhighlight');
                get(featuredSkinsRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const featuredSkins = snapshot.val();
                        const skinHighlightContent = document.querySelector('.skin-highlight-content');
                        skinHighlightContent.innerHTML = ''; // Clear existing content

                        Object.values(featuredSkins).forEach(skin => {
                            const skinElement = document.createElement('div');
                            skinElement.className = 'featured-skin';
                            if (window.userSkins && window.userSkins[skin.name]) {
                                skinElement.classList.add('owned');
                            }
                            skinElement.innerHTML = `
                                <img src="${skin.image}" alt="${skin.name}">
                                <div class="featured-skin-info">
                                    <div class="featured-skin-name">${skin.name}</div>
                                    <div class="featured-skin-price">
                                        <img src="res/img/fm.png" alt="FM">
                                        <span>${skin.price}</span>
                                    </div>
                                </div>
                            `;
                            
                            // Add click handler to open lightbox
                            skinElement.addEventListener('click', (event) => {
                                event.stopPropagation();
                                openLightbox(skin.image, skin.name, skin.price);
                            });
                            
                            skinHighlightContent.appendChild(skinElement);
                        });
                    }
                }).catch((error) => {
                    console.error("Error loading featured skins:", error);
                });
            }
        });
    </script>

    <!-- Add before the closing body tag -->
    <!-- Lunar Lantern Window -->
    <div id="lunar-lantern-window" class="modal">
        <div class="modal-content lunar-content">
            <span class="close" onclick="window.closeLunarWindow()">&times;</span>
            <div class="lunar-header">
                <h2>Lunar Lantern</h2>
                <div class="header-info">
                    <div class="refresh-timer">
                        <i class="fas fa-sync-alt"></i>
                        <span id="refresh-countdown">00:00:00</span>
                    </div>
                    <div class="ticket-display">
                        <img src="res/img/lunar_ticket.png" alt="Lunar Ticket">
                        <span id="lunar-ticket-amount">0</span>
                    </div>
                </div>
            </div>
            <div class="lantern-grid">
                <!-- 3x3 grid of lanterns -->
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(0)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(1)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(2)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(3)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(4)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(5)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(6)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(7)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <div class="lantern-container">
                    <div class="reward-preview"></div>
                    <div class="lantern" onclick="window.openLantern(8)">
                        <img src="res/img/lunar_lantern.png" alt="Lunar Lantern">
                    </div>
                </div>
                <button class="loot-table-button" onclick="showLootTable()">Show Loot Table</button>
            </div>
        </div>
    </div>

    <style>
        /* ... existing styles ... */

        .header-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .refresh-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 215, 0, 0.1);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--secondary-color);
        }

        .refresh-timer i {
            color: var(--secondary-color);
            font-size: 1.2em;
        }

        .refresh-timer span {
            color: var(--secondary-color);
            font-size: 1.2em;
            font-family: monospace;
        }

        #refresh-countdown {
            color: var(--secondary-color);
            font-size: 1.4em;
            font-weight: bold;
            font-family: monospace;
            text-shadow: 0 0 10px var(--shadow-secondary);
        }

        .lantern-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .reward-preview {
            position: absolute;
            top: -50px; /* Changed from -65px to -50px for an even lower position */
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            opacity: 0;
            transition: all 0.5s ease;
            z-index: 1;
        }

        .reward-preview img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px var(--shadow-secondary));
            animation: rewardFloat 2s infinite ease-in-out;
        }

        @keyframes rewardFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        .lantern-container.opened .reward-preview {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        .lantern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            padding: 20px;
            padding-top: 50px; /* Adjusted padding to match new reward position */
            perspective: 1000px;
        }

        .lantern-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            min-height: 150px; /* Adjusted minimum height */
        }
    </style>

    <script>
        // Add refresh timer functionality
        function updateRefreshTimer() {
            const now = new Date();
            const nextRefresh = new Date();
            nextRefresh.setUTCHours(24, 0, 0, 0); // Reset at midnight UTC

            if (now >= nextRefresh) {
                nextRefresh.setDate(nextRefresh.getDate() + 1);
            }

            const timeLeft = nextRefresh - now;
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);

            document.getElementById('refresh-countdown').textContent = 
                `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Update timer every second
        setInterval(updateRefreshTimer, 1000);

        // Modify showReward function to also show preview above lantern
        function showReward(imageSrc, text, lanternIndex) {
            // Show reward popup
            const popup = document.getElementById('reward-popup');
            const image = document.getElementById('reward-image');
            const textElement = document.getElementById('reward-text');
            
            image.src = imageSrc;
            textElement.textContent = text;
            popup.style.display = 'flex';

            // Show reward preview above lantern
            const lanternContainer = document.querySelectorAll('.lantern-container')[lanternIndex];
            const rewardPreview = lanternContainer.querySelector('.reward-preview');
            
            // Create and add reward image
            const previewImg = document.createElement('img');
            previewImg.src = imageSrc;
            previewImg.alt = text;
            
            // Clear previous reward if any
            rewardPreview.innerHTML = '';
            rewardPreview.appendChild(previewImg);
            
            // Add opened class to container for animation
            lanternContainer.classList.add('opened');
            lanternContainer.querySelector('.lantern').classList.add('opened');
        }

        // Initialize refresh timer on window load
        window.addEventListener('load', updateRefreshTimer);
    </script>

    <!-- Reward Popup -->
    <div id="reward-popup" class="modal">
        <div class="modal-content reward-content">
            <div class="reward-header">
                <h3>Gratulálunk!</h3>
                <span class="close" onclick="window.closeRewardPopup()">&times;</span>
            </div>
            <div class="reward-body">
                <img id="reward-image" src="" alt="Reward">
                <p id="reward-text"></p>
            </div>
        </div>
    </div>

    <style>
        /* ... existing styles ... */

        /* Lunar Lantern Window Styles */
        #lunar-lantern-window {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
        }

        .lunar-content {
            background: linear-gradient(135deg, #1a0f30, #2a1b4a);
            border: 2px solid var(--secondary-color);
            border-radius: 15px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            position: relative;
            animation: glow 2s infinite alternate;
        }

        @keyframes glow {
            from {
                box-shadow: 0 0 10px var(--secondary-color), 0 0 20px var(--secondary-color), 0 0 30px var(--secondary-color);
            }
            to {
                box-shadow: 0 0 20px var(--secondary-color), 0 0 30px var(--secondary-color), 0 0 40px var(--secondary-color);
            }
        }

        .lunar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .lunar-header h2 {
            color: var(--secondary-color);
            font-size: 2em;
            text-shadow: 0 0 10px var(--secondary-color);
        }

        .ticket-display {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 215, 0, 0.1);
            padding: 10px 20px;
            border-radius: 20px;
            border: 1px solid var(--secondary-color);
        }

        .ticket-display img {
            width: 30px;
            height: 30px;
        }

        .ticket-display span {
            color: var(--secondary-color);
            font-size: 1.5em;
            font-weight: bold;
        }

        .lantern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            padding: 20px;
        }

        .lantern {
            position: relative;
            aspect-ratio: 1;
            cursor: pointer;
            transition: transform 0.3s ease;
            animation: float 3s infinite ease-in-out;
        }

        .lantern:hover {
            transform: scale(1.1);
        }

        .lantern img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 10px var(--shadow-secondary));
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0);
            }
            50% {
                transform: translateY(-10px);
            }
        }

        /* Reward Popup Styles */
        #reward-popup {
            display: none;
            z-index: 2100;
        }

        .reward-content {
            background: linear-gradient(135deg, #2a1b4a, #1a0f30);
            border: 2px solid var(--secondary-color);
            border-radius: 15px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }

        .reward-header {
            margin-bottom: 20px;
        }

        .reward-header h3 {
            color: var(--secondary-color);
            font-size: 1.8em;
            text-shadow: 0 0 10px var(--secondary-color);
        }

        .reward-body img {
            max-width: 200px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 0 20px var(--shadow-secondary);
        }

        .reward-body p {
            color: var(--text-white);
            font-size: 1.2em;
            margin-top: 20px;
        }

        .close {
            position: absolute;
            top: 10px;
            right: 10px;
            color: var(--secondary-color);
            font-size: 30px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .close:hover {
            transform: scale(1.2);
        }
    </style>

    <script>
        // Add these functions to your existing script
        window.openAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'block';
                updateAwardButtons();
            }
        }

        window.closeAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'none';
            }
        }

        async function updateAwardButtons() {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            const ownedSkins = userData.skins || {};

            const awardSkins = [
                'Superhero Shizumaru',
                'Desert Demon Shizumaru',
                'Underworld Demon Noel',
                'Skater Shoma'
            ];

            awardSkins.forEach(skinName => {
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${getPriceForSkin(skinName)})"]`);
                if (button && ownedSkins[skinName]) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }
            });
        }

        function getPriceForSkin(skinName) {
            const prices = {
                'Superhero Shizumaru': 1500,
                'Desert Demon Shizumaru': 1500,
                'Underworld Demon Noel': 1500,
                'Skater Shoma': 500
            };
            return prices[skinName] || 0;
        }

        async function purchaseAwardSkin(skinName, price) {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            if (!userData) return;

            const currentFM = userData.FM || 0;
            const ownedSkins = userData.skins || {};

            if (ownedSkins[skinName]) {
                alert('You already own this skin!');
                return;
            }

            if (currentFM >= price) {
                const updates = {};
                updates['FM'] = currentFM - price;
                updates[`skins/${skinName}`] = 1;

                await update(userRef, updates);

                // Update FM display
                const fmDisplay = document.getElementById('currency-amount');
                if (fmDisplay) {
                    fmDisplay.textContent = currentFM - price;
                }

                // Update button state
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${price})"]`);
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }

                alert(`You have successfully purchased ${skinName}!`);
            } else {
                alert("You don't have enough FM to purchase this skin.");
            }
        }
    </script>

    <script>
        // Add these functions to your existing script
        window.openAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'block';
                updateAwardButtons();
            }
        }

        window.closeAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'none';
            }
        }

        async function updateAwardButtons() {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            const ownedSkins = userData.skins || {};

            const awardSkins = [
                'Superhero Shizumaru',
                'Desert Demon Shizumaru',
                'Underworld Demon Noel',
                'Skater Shoma'
            ];

            awardSkins.forEach(skinName => {
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${getPriceForSkin(skinName)})"]`);
                if (button && ownedSkins[skinName]) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }
            });
        }

        function getPriceForSkin(skinName) {
            const prices = {
                'Superhero Shizumaru': 1500,
                'Desert Demon Shizumaru': 1500,
                'Underworld Demon Noel': 1500,
                'Skater Shoma': 500
            };
            return prices[skinName] || 0;
        }

        async function purchaseAwardSkin(skinName, price) {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            if (!userData) return;

            const currentFM = userData.FM || 0;
            const ownedSkins = userData.skins || {};

            if (ownedSkins[skinName]) {
                alert('You already own this skin!');
                return;
            }

            if (currentFM >= price) {
                const updates = {};
                updates['FM'] = currentFM - price;
                updates[`skins/${skinName}`] = 1;

                await update(userRef, updates);

                // Update FM display
                const fmDisplay = document.getElementById('currency-amount');
                if (fmDisplay) {
                    fmDisplay.textContent = currentFM - price;
                }

                // Update button state
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${price})"]`);
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }

                alert(`You have successfully purchased ${skinName}!`);
            } else {
                alert("You don't have enough FM to purchase this skin.");
            }
        }
    </script>

    <style>
        /* ... existing styles ... */

        /* Enhanced Lunar Lantern Window Styles */
        #lunar-lantern-window {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            backdrop-filter: blur(10px);
            justify-content: center;
            align-items: center;
        }

        .lunar-content {
            background: linear-gradient(135deg, #1a0f30, #2a1b4a);
            border: 2px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 90%;
            position: relative;
            animation: contentAppear 0.5s ease-out;
            transform-style: preserve-3d;
            perspective: 1000px;
        }

        @keyframes contentAppear {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .lunar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid rgba(255, 215, 0, 0.2);
        }

        .lunar-header h2 {
            color: #ffd700;
            font-size: 2.5em;
            text-shadow: 0 0 15px #ffd700;
            margin: 0;
            font-weight: 700;
            letter-spacing: 2px;
            animation: titleGlow 2s infinite alternate;
        }

        @keyframes titleGlow {
            from { text-shadow: 0 0 15px #ffd700; }
            to { text-shadow: 0 0 25px #ffd700, 0 0 35px #ffd700; }
        }

        .ticket-display {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 215, 0, 0.15);
            padding: 12px 25px;
            border-radius: 30px;
            border: 2px solid rgba(255, 215, 0, 0.3);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
            transition: all 0.3s ease;
        }

        .ticket-display:hover {
            transform: translateY(-2px);
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        }

        .ticket-display img {
            width: 35px;
            height: 35px;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
            animation: ticketFloat 3s infinite ease-in-out;
        }

        @keyframes ticketFloat {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            50% { transform: translateY(-5px) rotate(5deg); }
        }

        .ticket-display span {
            color: #ffd700;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .lantern-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 30px;
            padding: 20px;
            perspective: 1000px;
        }

        .lantern {
            position: relative;
            aspect-ratio: 1;
            cursor: pointer;
            transition: all 0.4s ease;
            transform-style: preserve-3d;
            animation: float 3s infinite ease-in-out;
        }

        .lantern::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.2) 0%, transparent 70%);
            transform: translate(-50%, -50%);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            z-index: -1;
        }

        .lantern:hover {
            transform: scale(1.1) translateY(-10px) rotateY(10deg);
        }

        .lantern:hover::before {
            opacity: 1;
        }

        .lantern img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            filter: drop-shadow(0 0 15px rgba(255, 215, 0, 0.6));
            transition: all 0.3s ease;
        }

        .lantern:hover img {
            filter: drop-shadow(0 0 25px rgba(255, 215, 0, 0.8));
        }

        .lantern.opened {
            opacity: 0.5;
            transform: scale(0.95);
            pointer-events: none;
            animation: none;
        }

        .lantern.opened img {
            filter: grayscale(1) brightness(0.7);
        }

        /* Enhanced Reward Popup Styles */
        #reward-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.98);
            z-index: 2100;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }

        .reward-content {
            background: linear-gradient(135deg, #2a1b4a, #1a0f30);
            border: 3px solid #ffd700;
            border-radius: 20px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            animation: rewardAppear 0.5s cubic-bezier(0.26, 0.53, 0.74, 1.48);
            box-shadow: 0 0 50px rgba(255, 215, 0, 0.3);
        }

        @keyframes rewardAppear {
            0% {
                opacity: 0;
                transform: scale(0.8) translateY(30px);
            }
            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .reward-header {
            margin-bottom: 30px;
        }

        .reward-header h3 {
            color: #ffd700;
            font-size: 2.2em;
            font-weight: 700;
            text-shadow: 0 0 15px #ffd700;
            animation: congratsGlow 2s infinite alternate;
        }

        @keyframes congratsGlow {
            from { text-shadow: 0 0 15px #ffd700; }
            to { text-shadow: 0 0 30px #ffd700, 0 0 40px #ffd700; }
        }

        .reward-body {
            position: relative;
        }

        .reward-body img {
            max-width: 250px;
            margin: 30px 0;
            border-radius: 15px;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.4);
            animation: rewardImageGlow 3s infinite alternate;
            transform: perspective(1000px) rotateY(5deg);
            transition: transform 0.3s ease;
        }

        .reward-body img:hover {
            transform: perspective(1000px) rotateY(-5deg) scale(1.05);
        }

        @keyframes rewardImageGlow {
            from { box-shadow: 0 0 30px rgba(255, 215, 0, 0.4); }
            to { box-shadow: 0 0 50px rgba(255, 215, 0, 0.6); }
        }

        .reward-body p {
            color: #fff;
            font-size: 1.4em;
            margin-top: 25px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            animation: textFadeIn 0.5s ease-out 0.3s both;
        }

        @keyframes textFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .close {
            position: absolute;
            top: 15px;
            right: 15px;
            color: #ffd700;
            font-size: 35px;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: rgba(255, 215, 0, 0.1);
        }

        .close:hover {
            transform: rotate(90deg);
            background: rgba(255, 215, 0, 0.2);
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
        }

        /* Particle Effects */
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            animation: particleFade 1s ease-out forwards;
        }

        @keyframes particleFade {
            0% {
                opacity: 1;
                transform: scale(1);
            }
            100% {
                opacity: 0;
                transform: scale(0);
            }
        }
    </style>

    <script>
        // Add particle effect when opening lanterns
        function createParticles(x, y) {
            const particles = document.createElement('div');
            particles.className = 'particles';
            document.body.appendChild(particles);

            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.width = Math.random() * 8 + 2 + 'px';
                particle.style.height = particle.style.width;
                
                const angle = Math.random() * Math.PI * 2;
                const velocity = Math.random() * 100 + 50;
                const vx = Math.cos(angle) * velocity;
                const vy = Math.sin(angle) * velocity;
                
                particle.style.transform = `translate(${vx}px, ${vy}px)`;
                particles.appendChild(particle);
            }

            setTimeout(() => particles.remove(), 1000);
        }

        // Add click handler for lanterns
        document.querySelectorAll('.lantern').forEach(lantern => {
            lantern.addEventListener('click', (e) => {
                const rect = lantern.getBoundingClientRect();
                const x = rect.left + rect.width / 2;
                const y = rect.top + rect.height / 2;
                createParticles(x, y);
            });
        });
    </script>

    <!-- Loot Table Modal -->
    <div id="loot-table-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeLootTable()">&times;</span>
            <h2>Lunar Lantern Loot Table</h2>
            <div class="loot-table">
                <div class="loot-category">
                    <h3>Special Skins</h3>
                    <p>Phoenix R Mika (8%)</p>
                    <p>Blanka Red (10%)</p>
                    <p>Samurai Shizumaru (8%)</p>
                    <p>Feather Dancer Mai (8%)</p>
                </div>
                <div class="loot-category">
                    <h3>Lunar Festival Skins</h3>
                    <p>Lunar Festival Lili (0.5%)</p>
                    <p>Lunar Festival Scorpion (0.5%)</p>
                    <p>Lunar Festival Reptile (0.5%)</p>
                    <p>Lunar Festival Noel (0.5%)</p>
                    <p>Lunar Festival Siegfried (0.5%)</p>
                    <p>Lunar Festival Kokoro (0.5%)</p>
                </div>
                <div class="loot-category">
                    <h3>Currency & Items</h3>
                    <p>100 FM (10%)</p>
                    <p>1000 FM (2%)</p>
                    <p>2000 FM (1.5%)</p>
                    <p>5000 CM (15%)</p>
                    <p>25000 CM (12.5%)</p>
                    <p>2 Lunar Tickets (5%)</p>
                    <p>Free Lootbox (5%)</p>
                </div>
                <div class="loot-category">
                    <h3>Other Rewards</h3>
                    <p>Lunar Festival 2024 Theme Song (20%)</p>
                    <p>Random Sticker (15%)</p>
                    <p>Random Recolor (15%)</p>
                    <p>Random Lunar Skin (3.5%)</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ... existing styles ... */
        .loot-table-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .loot-table-button:hover {
            background-color: var(--accent-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
        }

        .modal-content {
            background-color: var(--background-color);
            margin: 5% auto;
            padding: 20px;
            border: 1px solid var(--secondary-color);
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            color: var(--text-color);
        }

        .close {
            color: var(--text-color);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: var(--accent-color);
        }

        .loot-table {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .loot-category {
            background-color: rgba(255, 255, 255, 0.05);
            padding: 15px;
            border-radius: 8px;
        }

        .loot-category h3 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 5px;
        }

        .loot-category p {
            margin: 5px 0;
            color: var(--text-color);
        }
    </style>

    <script>
        // ... existing scripts ...
        function showLootTable() {
            document.getElementById('loot-table-modal').style.display = 'block';
        }

        function closeLootTable() {
            document.getElementById('loot-table-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('loot-table-modal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>
</body>
</html>