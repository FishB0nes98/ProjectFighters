<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Project Fighters</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js" type="module"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Custom styles -->
    <link rel="stylesheet" href="styles_new.css">
</head>
<body>
    <!-- Video Background -->
    <video id="video-background" autoplay muted loop playsinline>
        <source src="Event/Eventvideo.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Navigation Menu -->
        <nav class="main-nav">
            <div class="nav-content">
                <a href="Game Modes.html" class="play-button">
                    <i class="fas fa-play play-icon"></i>
                    <span class="play-text">Play</span>
                </a>
                <a href="home.html" class="nav-link active">
                    <div class="nav-icon">
                        <i class="fas fa-home"></i>
                    </div>
                    <span class="nav-text">Home</span>
                    <div class="nav-indicator"></div>
                </a>
                <a href="Store.html" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-store"></i>
                    </div>
                    <span class="nav-text">Store</span>
                    <div class="nav-indicator"></div>
                </a>
                <a href="event.html" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-calendar"></i>
                    </div>
                    <span class="nav-text">Event</span>
                    <div class="nav-indicator"></div>
                </a>
                <a href="Team Builder.html" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <span class="nav-text">Team Builder</span>
                    <div class="nav-indicator"></div>
                </a>
                <a href="statistics.html" class="nav-link">
                    <div class="nav-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <span class="nav-text">Statistics</span>
                    <div class="nav-indicator"></div>
                </a>
            </div>
        </nav>

        <!-- Currency Display -->
        <div class="currency-display">
            <div class="currency-item">
                <img src="res/img/fm.png" alt="FM">
                <span id="currency-amount">0</span>
            </div>
            <div class="currency-item">
                <img src="res/img/cm.png" alt="CM">
                <span id="cm-amount">0</span>
            </div>
            <div class="currency-item">
                <img src="res/img/qp.png" alt="QP">
                <span id="qp-amount">0</span>
            </div>
        </div>

        <!-- Side Buttons -->
        <div class="side-buttons">
            <!-- Changelog Button -->
            <div class="side-button" onclick="window.location.href='changelog.html'">
                <img src="Default Splash/Sophitia.jpeg" alt="Changelog">
                <div class="button-content">
                    <h3 class="button-title">Changelog</h3>
                </div>
            </div>
            <!-- Quests Button -->
            <div class="side-button" onclick="toggleQuestWindow(event)">
                <img src="res/img/questbackground.webp" alt="Quests">
                <div class="button-content">
                    <h3 class="button-title">Quests</h3>
                </div>
            </div>
            <!-- Quest Points Store Button -->
            <div class="side-button" onclick="toggleQPStoreWindow(event)">
                <img src="res/img/qp.png" alt="Quest Points Store">
                <div class="button-content">
                    <h3 class="button-title">Quest Points Store</h3>
                </div>
            </div>
            <!-- Battlepass Button -->
            <div class="side-button" onclick="window.location.href='battlepass.html'">
                <img src="Event/Love Day Event.webp" alt="Battlepass">
                <div class="button-content">
                    <h3 class="button-title">Battlepass</h3>
                </div>
            </div>
        </div>

        <!-- Profile Container -->
        <div id="profile-info" class="profile-container">
            <div class="username-title-container">
                <h2 id="username-display"></h2>
                <div id="title-display"></div>
            </div>
            <img id="profile-image" src="" alt="Profile Icon" class="profile-icon">
        </div>

        <!-- Profile Menu -->
        <div id="profile-menu" class="profile-menu">
            <ul>
                <li onclick="window.location.href='character-progression.html'">Character Progression</li>
                <li onclick="window.location.href='Profile.html'">Profile</li>
                <li onclick="openChangeIconModal()">Change Icon</li>
                <li onclick="window.location.href='Collection.html'">Collection</li>
                <li onclick="logOut()">Log Out</li>
            </ul>
        </div>

        <!-- Icon Selector Modal -->
        <div id="icon-selector-modal" class="icon-selector-modal">
            <div class="icon-selector-content">
                <div class="icon-selector-header">
                    <h2 class="icon-selector-title">
                        <i class="fas fa-user-circle"></i>
                        Choose Your Icon
                    </h2>
                    <button class="icon-selector-close" onclick="closeIconSelector()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="icon-selector-controls">
                    <button class="icon-category-btn active" onclick="switchIconCategory('default')">
                        <i class="fas fa-th"></i>
                        Default Icons
                    </button>
                    <button class="icon-category-btn" onclick="switchIconCategory('owned')">
                        <i class="fas fa-star"></i>
                        Special Icons
                    </button>
                    <div class="icon-search-container">
                        <i class="fas fa-search icon-search-icon"></i>
                        <input type="text" class="icon-search" placeholder="Search icons..." oninput="filterIcons()">
                    </div>
                </div>

                <div class="icon-grid-container">
                    <div id="icon-grid" class="icon-grid">
                        <!-- Icons will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Music Player Toggle Button -->
        <button class="music-player-toggle">
            <i class="fas fa-music"></i>
        </button>

        <!-- Music Player -->
        <div class="music-player">
            <div class="music-player-content">
                <div class="music-player-header">
                    <button class="playlist-toggle">
                        <i class="fas fa-list"></i>
                    </button>
                    <div class="music-controls">
                        <button class="shuffle-btn">
                            <i class="fas fa-random"></i>
                        </button>
                        <button class="prev-btn">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="play-btn">
                            <i class="fas fa-play"></i>
                        </button>
                        <button class="next-btn">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>
                </div>

                <div class="music-player-main">
                    <div class="cover-art-container">
                        <img src="res/img/default-cover.png" alt="Cover Art" class="cover-art">
                        <div class="cover-art-overlay"></div>
                    </div>

                    <div class="music-info">
                        <div class="song-title">No song selected</div>
                        <div class="artist-name">-</div>
                    </div>

                    <div class="progress-container">
                        <span class="current-time">0:00</span>
                        <div class="progress-bar">
                            <div class="progress"></div>
                            <div class="progress-handle"></div>
                        </div>
                        <span class="duration">0:00</span>
                    </div>

                    <div class="volume-control">
                        <i class="fas fa-volume-up"></i>
                        <div class="volume-slider-container">
                            <input type="range" class="volume-slider" min="0" max="100" value="50">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Playlist -->
            <div class="playlist">
                <div class="playlist-header">
                    <h3>Playlist</h3>
                    <button class="close-playlist">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <ul class="playlist-items">
                    <!-- Songs will be added here dynamically -->
                </ul>
            </div>
        </div>

        <!-- Character Container -->
        <div class="character-container">
            <div class="character-header">
                <div class="search-filter-section">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="character-search" placeholder="Search champions...">
                    </div>
                    <div class="role-filters">
                        <button class="role-filter active" data-role="all">
                            <i class="fas fa-th"></i>
                            <span>All</span>
                        </button>
                        <button class="role-filter" data-role="top">
                            <i class="fas fa-chevron-up"></i>
                            <span>Top</span>
                        </button>
                        <button class="role-filter" data-role="jungle">
                            <i class="fas fa-tree"></i>
                            <span>Jungle</span>
                        </button>
                        <button class="role-filter" data-role="mid">
                            <i class="fas fa-star"></i>
                            <span>Mid</span>
                        </button>
                        <button class="role-filter" data-role="adc">
                            <i class="fas fa-crosshairs"></i>
                            <span>ADC</span>
                        </button>
                        <button class="role-filter" data-role="support">
                            <i class="fas fa-heart"></i>
                            <span>Support</span>
                        </button>
                    </div>
                </div>
            </div>

            <div class="character-grid">
                <!-- Characters will be dynamically added here -->
            </div>
        </div>

        <!-- Quest Window -->
        <div id="quest-window" class="quest-modal">
            <div class="quest-modal-content">
                <div class="quest-header">
                    <h2>
                        <i class="fas fa-tasks"></i>
                        Daily Quests
                    </h2>
                    <div class="quest-tabs">
                        <button class="quest-tab active" onclick="switchQuestTab('daily')">Daily</button>
                        <button class="quest-tab" onclick="switchQuestTab('special')">Special</button>
                    </div>
                </div>
                
                <div class="quest-content">
                    <div class="quest-list">
                        <!-- Quest items will be dynamically added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- QP Store Modal -->
        <div id="qp-store-window" class="qp-store-modal">
            <div class="qp-store-content">
                <div class="qp-store-header">
                    <div class="qp-store-title">
                        <h2>
                            <i class="fas fa-store"></i>
                            Quest Points Store
                        </h2>
                        <p class="qp-store-subtitle">Exchange your hard-earned Quest Points for exclusive rewards</p>
                    </div>
                    <div class="qp-store-controls">
                        <div class="qp-store-balance">
                            <img src="res/img/qp.png" alt="QP">
                            <span id="store-qp-amount">0</span>
                        </div>
                        <button class="qp-store-close" onclick="closeQPStoreWindow()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div class="qp-store-grid">
                    <!-- Heart Sticker -->
                    <div class="qp-store-item" data-item-name="heart" data-item-type="sticker">
                        <div class="item-preview">
                            <img src="stickers/heart.png" alt="Heart Sticker">
                        </div>
                        <div class="item-details">
                            <h3 class="item-name">Heart Sticker</h3>
                            <div class="item-price">
                                <img src="res/img/qp.png" alt="QP">
                                <span>750</span>
                            </div>
                            <button class="purchase-btn" onclick="purchaseItem(this)">
                                <span>Purchase</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Ribbon Icon -->
                    <div class="qp-store-item" data-item-name="ribbon" data-item-type="sticker">
                        <div class="item-preview">
                            <img src="Icons/Profile/ribbon.png" alt="Ribbon Icon">
                        </div>
                        <div class="item-details">
                            <h3 class="item-name">Ribbon Icon</h3>
                            <div class="item-price">
                                <img src="res/img/qp.png" alt="QP">
                                <span>500</span>
                            </div>
                            <button class="purchase-btn" onclick="purchaseItem(this)">
                                <span>Purchase</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Single Title -->
                    <div class="qp-store-item" data-item-name="single" data-item-type="title">
                        <div class="item-preview">
                            <img src="titles/titleimage.jpeg" alt="Single Title">
                        </div>
                        <div class="item-details">
                            <h3 class="item-name">Single Title</h3>
                            <div class="item-price">
                                <img src="res/img/qp.png" alt="QP">
                                <span>500</span>
                            </div>
                            <button class="purchase-btn" onclick="purchaseItem(this)">
                                <span>Purchase</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Lovely Sophitia Skin -->
                    <div class="qp-store-item" data-item-name="lovely_sophitia" data-item-type="skin">
                        <div class="item-preview">
                            <img src="Skins/Lovely Sophitia.jpeg" alt="Lovely Sophitia Skin">
                        </div>
                        <div class="item-details">
                            <h3 class="item-name">Lovely Sophitia</h3>
                            <div class="item-price">
                                <img src="res/img/qp.png" alt="QP">
                                <span>6000</span>
                            </div>
                            <button class="purchase-btn" onclick="purchaseItem(this)">
                                <span>Purchase</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>

                    <!-- CM Reward -->
                    <div class="qp-store-item" data-item-name="cm_reward" data-item-type="cm" data-repeatable="true">
                        <div class="item-badge repeatable">
                            <i class="fas fa-sync-alt"></i>
                            Repeatable
                        </div>
                        <div class="item-preview">
                            <img src="res/img/cm.png" alt="Champion Money">
                        </div>
                        <div class="item-details">
                            <h3 class="item-name">1000 CM</h3>
                            <div class="item-price">
                                <img src="res/img/qp.png" alt="QP">
                                <span>250</span>
                            </div>
                            <button class="purchase-btn" onclick="purchaseItem(this)">
                                <span>Purchase</span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            /* QP Store Styles */
            .store-modal-content {
                background: linear-gradient(135deg, rgba(28, 28, 36, 0.95) 0%, rgba(20, 20, 26, 0.98) 100%);
                border-radius: 24px;
                padding: 32px;
                width: 90%;
                max-width: 1200px;
                max-height: 90vh;
                position: relative;
                overflow-y: auto;
                box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .store-header {
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
                padding-bottom: 24px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                margin-bottom: 32px;
            }

            .store-title h2 {
                font-size: 2.2em;
                font-weight: 700;
                color: #fff;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 12px;
            }

            .store-subtitle {
                color: rgba(255, 255, 255, 0.6);
                font-size: 1em;
            }

            .store-controls {
                display: flex;
                align-items: center;
                gap: 24px;
            }

            .currency-display {
                display: flex;
                align-items: center;
                gap: 8px;
                background: rgba(255, 255, 255, 0.1);
                padding: 12px 20px;
                border-radius: 16px;
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            .currency-display img {
                width: 24px;
                height: 24px;
            }

            .currency-display span {
                font-size: 1.2em;
                font-weight: 600;
                color: #fff;
            }

            .close-button {
                background: rgba(255, 255, 255, 0.1);
                border: none;
                color: #fff;
                width: 40px;
                height: 40px;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .close-button:hover {
                background: rgba(255, 255, 255, 0.2);
                transform: scale(1.05);
            }

            .store-items {
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
                gap: 24px;
                padding: 8px;
            }

            .store-item {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 20px;
                padding: 24px;
                position: relative;
                overflow: hidden;
                transition: all 0.3s ease;
                border: 1px solid rgba(255, 255, 255, 0.05);
            }

            .store-item:hover {
                transform: translateY(-4px);
                background: rgba(255, 255, 255, 0.08);
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            }

            .item-preview {
                background: rgba(255, 255, 255, 0.03);
                border-radius: 16px;
                padding: 24px;
                margin-bottom: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
                aspect-ratio: 16/9;
            }

            .item-preview img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
                transition: transform 0.3s ease;
            }

            .store-item:hover .item-preview img {
                transform: scale(1.05);
            }

            .item-details {
                display: flex;
                justify-content: space-between;
                align-items: flex-end;
            }

            .item-info {
                flex-grow: 1;
            }

            .item-name {
                font-size: 1.4em;
                font-weight: 600;
                color: #fff;
                margin-bottom: 8px;
            }

            .item-price {
                display: flex;
                align-items: center;
                gap: 6px;
                color: rgba(255, 255, 255, 0.8);
            }

            .item-price img {
                width: 20px;
                height: 20px;
            }

            .purchase-btn {
                background: linear-gradient(135deg, #ff416c 0%, #ff4b2b 100%);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 12px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 8px;
            }

            .purchase-btn:hover:not(:disabled) {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(255, 75, 43, 0.4);
            }

            .purchase-btn:disabled {
                background: rgba(255, 255, 255, 0.1);
                cursor: not-allowed;
            }

            .purchase-btn .btn-text {
                font-size: 0.9em;
            }

            .repeatable-badge {
                position: absolute;
                top: 16px;
                right: 16px;
                background: linear-gradient(135deg, #00b894 0%, #00cec9 100%);
                color: white;
                padding: 8px 16px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 6px;
                box-shadow: 0 4px 12px rgba(0, 184, 148, 0.3);
            }

            .claimed-badge {
                position: absolute;
                top: 16px;
                right: 16px;
                background: rgba(255, 255, 255, 0.1);
                color: white;
                padding: 8px 16px;
                border-radius: 12px;
                font-size: 0.85em;
                font-weight: 600;
                display: flex;
                align-items: center;
                gap: 6px;
            }

            /* Scrollbar Styles */
            .store-modal-content::-webkit-scrollbar {
                width: 8px;
            }

            .store-modal-content::-webkit-scrollbar-track {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 4px;
            }

            .store-modal-content::-webkit-scrollbar-thumb {
                background: rgba(255, 255, 255, 0.2);
                border-radius: 4px;
            }

            .store-modal-content::-webkit-scrollbar-thumb:hover {
                background: rgba(255, 255, 255, 0.3);
            }

            @media (max-width: 768px) {
                .store-header {
                    flex-direction: column;
                    gap: 16px;
                }

                .store-controls {
                    width: 100%;
                    justify-content: space-between;
                }

                .store-items {
                    grid-template-columns: 1fr;
                }
            }
        </style>

    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, get, update, set } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js';
        import { roles } from './roles.js';

            // Make toggleQPStoreWindow globally available
            window.toggleQPStoreWindow = function(event) {
                event.stopPropagation();
                const storeWindow = document.getElementById('qp-store-window');
                if (!storeWindow.classList.contains('show')) {
                    storeWindow.style.display = 'block';
                    // Trigger reflow
                    storeWindow.offsetHeight;
                    storeWindow.classList.add('show');
                    updateStoreDisplay();
                } else {
                    closeQPStoreWindow();
                }
            };

            window.closeQPStoreWindow = function() {
                const storeWindow = document.getElementById('qp-store-window');
                storeWindow.classList.remove('show');
                // Wait for animation to complete before hiding
                setTimeout(() => {
                    storeWindow.style.display = 'none';
                }, 300);
            };

            async function updateStoreDisplay() {
                const user = auth.currentUser;
                if (!user) return;

                try {
                    const userRef = ref(database, `users/${user.uid}`);
                    const snapshot = await get(userRef);
                    const userData = snapshot.val();

                    // Update QP display
                    document.getElementById('store-qp-amount').textContent = userData.questPoints || 0;

                    // Update item states
                    const items = document.querySelectorAll('.qp-store-item');
                    items.forEach(async item => {
                        const button = item.querySelector('.purchase-btn');
                        const itemName = item.dataset.itemName;
                        const itemType = item.dataset.itemType;
                        const isRepeatable = item.dataset.repeatable === 'true';

                        if (!isRepeatable) {
                            let isOwned = false;
                            if (itemType === 'sticker' && userData.Stickers && userData.Stickers[itemName]) {
                                isOwned = true;
                            } else if (itemType === 'title' && userData.titles && userData.titles[itemName]) {
                                isOwned = true;
                            } else if (itemType === 'skin' && userData.skins && userData.skins[itemName]) {
                                isOwned = true;
                            }

                            if (isOwned) {
                                button.disabled = true;
                                button.innerHTML = '<i class="fas fa-check"></i> Owned';
                                if (!item.querySelector('.item-badge.owned')) {
                                    const badge = document.createElement('div');
                                    badge.className = 'item-badge owned';
                                    badge.innerHTML = '<i class="fas fa-check"></i> Owned';
                                    item.appendChild(badge);
                                }
                            }
                        }

                        // Check if user has enough QP
                        const price = parseInt(item.querySelector('.item-price span').textContent);
                        if ((userData.questPoints || 0) < price) {
                            button.disabled = true;
                            button.innerHTML = '<i class="fas fa-lock"></i> Insufficient QP';
                        }
                    });
                } catch (error) {
                    console.error('Error updating store display:', error);
                }
            }

            window.purchaseItem = async function(button) {
                const user = auth.currentUser;
                if (!user) return;

                const item = button.closest('.qp-store-item');
                const itemName = item.dataset.itemName;
                const itemType = item.dataset.itemType;
                const isRepeatable = item.dataset.repeatable === 'true';
                
                try {
                    const userRef = ref(database, `users/${user.uid}`);
                    const snapshot = await get(userRef);
                    const userData = snapshot.val() || {};
                    
                    let price;
                    let updates = {};

                    switch(itemType) {
                        case 'sticker':
                            price = 750;
                            if (!isRepeatable && userData.Stickers && userData.Stickers[itemName]) {
                                alert('You already own this sticker!');
                                return;
                            }
                            break;
                        case 'title':
                            price = 500;
                            if (userData.titles && userData.titles[itemName]) {
                                alert('You already own this title!');
                                return;
                            }
                            break;
                        case 'skin':
                            price = 6000;
                            if (userData.skins && userData.skins[itemName]) {
                                alert('You already own this skin!');
                                return;
                            }
                            break;
                        case 'cm':
                            price = 250;
                            break;
                        default:
                            return;
                    }

                    if ((userData.questPoints || 0) < price) {
                        alert('Not enough Quest Points!');
                        return;
                    }

                    // Update quest points
                    updates['questPoints'] = (userData.questPoints || 0) - price;

                    // Add rewards based on item type
                    switch(itemType) {
                        case 'sticker':
                            updates[`Stickers/${itemName}`] = 1;
                            break;
                        case 'title':
                            updates[`titles/${itemName}`] = true;
                            break;
                        case 'skin':
                            updates[`skins/${itemName}`] = true;
                            break;
                        case 'cm':
                            updates['CM'] = (userData.CM || 0) + 1000;
                            break;
                    }

                    await update(userRef, updates);
                    
                    // Update displays
                    document.getElementById('store-qp-amount').textContent = updates['questPoints'];
                    document.getElementById('qp-amount').textContent = updates['questPoints'];
                    if (itemType === 'cm') {
                        document.getElementById('cm-amount').textContent = updates['CM'];
                    }
                    
                    if (!isRepeatable) {
                        button.disabled = true;
                        button.innerHTML = '<i class="fas fa-check"></i> Owned';
                        const badge = document.createElement('div');
                        badge.className = 'item-badge owned';
                        badge.innerHTML = '<i class="fas fa-check"></i> Owned';
                        if (!item.querySelector('.item-badge.owned')) {
                            item.appendChild(badge);
                        }
                    }
                    
                    // Show success message with animation
                    const successMsg = document.createElement('div');
                    successMsg.className = 'purchase-success';
                    successMsg.innerHTML = `
                        <i class="fas fa-check-circle"></i>
                        Purchase successful!
                    `;
                    document.body.appendChild(successMsg);
                    
                    setTimeout(() => {
                        successMsg.remove();
                    }, 2000);
                    
                } catch (error) {
                    console.error('Error making purchase:', error);
                    alert('Failed to make purchase. Please try again.');
                }
            };

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqhxq6sPDU3EmuvvkBIIDJ-H6PsBc42Jg",
            authDomain: "project-fighters-by-fishb0nes.firebaseapp.com",
            databaseURL: "https://project-fighters-by-fishb0nes-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-fighters-by-fishb0nes",
            storageBucket: "project-fighters-by-fishb0nes.appspot.com",
            messagingSenderId: "867339299995",
            appId: "1:867339299995:web:99c379940014b9c05cea3e",
            measurementId: "G-LNEM6HR842"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Make Firebase instances globally available
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;

        // Helper function to capitalize titles
        function capitalizeTitle(title) {
            if (!title) return '';
            return title.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }

        // Initialize auth state
        function initializeAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();
                        
                        if (userData) {
                            // Update username and title
                            const usernameContainer = document.querySelector('.username-title-container');
                            if (usernameContainer) {
                                const usernameDisplay = usernameContainer.querySelector('#username-display');
                                if (usernameDisplay) {
                                    usernameDisplay.textContent = userData.username || user.email.split('@')[0];
                                }

                                // Update title if it exists
                                let titleDisplay = usernameContainer.querySelector('#title-display');
                                if (userData.activeTitle) {
                                    if (!titleDisplay) {
                                        titleDisplay = document.createElement('div');
                                        titleDisplay.id = 'title-display';
                                        usernameContainer.appendChild(titleDisplay);
                                    }
                                    titleDisplay.textContent = `(${capitalizeTitle(userData.activeTitle)})`;
                                } else if (titleDisplay) {
                                    titleDisplay.remove();
                                }
                            }

                            // Update profile image
                            const profileImage = document.getElementById('profile-image');
                            if (profileImage) {
                                setProfileImage(`Icons/${userData.icon || 'Birdie.png'}`, `Icons/Profile/${userData.icon || 'Birdie.png'}`);
                            }

                            // Update currency displays
                            const currencyAmount = document.getElementById('currency-amount');
                            const cmAmount = document.getElementById('cm-amount');
                            const qpAmount = document.getElementById('qp-amount');
                            if (currencyAmount) currencyAmount.textContent = userData.FM || 0;
                            if (cmAmount) cmAmount.textContent = userData.CM || 0;
                            if (qpAmount) qpAmount.textContent = userData.questPoints || 0;

                            // Store currency values globally for other functions
                            window.userFM = userData.FM || 0;
                            window.userCM = userData.CM || 0;
                            window.userQP = userData.questPoints || 0;
                        }
                    } catch (error) {
                        console.error('Error initializing user data:', error);
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        // Profile image helper function
        function setProfileImage(primaryPath, fallbackPath) {
            const img = document.getElementById('profile-image');
            if (img) {
                img.onerror = () => {
                    img.onerror = null;
                    img.src = fallbackPath;
                };
                img.src = primaryPath;
            }
        }

        // Logout function
        window.logOut = function() {
            signOut(auth).then(() => {
                console.log('User signed out successfully');
                window.location.href = 'index.html';
            }).catch((error) => {
                console.error('Error signing out:', error);
            });
        };

        // Profile menu toggle
        window.toggleProfileMenu = function(event) {
            if (event) {
                event.stopPropagation();
            }
            const profileMenu = document.getElementById('profile-menu');
            if (profileMenu) {
                profileMenu.classList.toggle('show');
            }
        };

        // Icon Selector Modal Functions
        window.openChangeIconModal = async function() {
            const modal = document.getElementById('icon-selector-modal');
            modal.style.display = 'block';
            // Add show class after a small delay to trigger animation
            setTimeout(() => {
                modal.classList.add('show');
            }, 10);
            await loadIcons('default'); // Load default icons first
        };

        window.closeIconSelector = function() {
            const modal = document.getElementById('icon-selector-modal');
            modal.classList.remove('show');
            // Remove display none after animation completes
            setTimeout(() => {
                modal.style.display = 'none';
            }, 300);
        };

        window.switchIconCategory = function(category) {
            const buttons = document.querySelectorAll('.icon-category-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.closest('.icon-category-btn').classList.add('active');
            loadIcons(category);
        };

        async function loadIcons(category) {
            const iconGrid = document.getElementById('icon-grid');
            iconGrid.innerHTML = '';

            const defaultIcons = [
                'Julia.png', 'Birdie.png', 'Erron Black.png', 'Cham Cham.png', 'Morrigan.png',
                'Jun.png', 'Reptile.png', 'Akuma.png', 'Elphelt.png', 'Kotal Kahn.png',
                'Scorpion.png', 'Peacock.png', 'Angel.png', 'Astaroth.png', 'Ibuki.png',
                'R.Mika.png', 'Raiden.png', 'Yugo.png', 'Talim.png', 'Noel.png',
                'Blanka.png', 'Nina.png', 'Ayane.png', 'Siegfried.png', 'Shoma.png', 
                'Juri.png', 'Sub Zero.png', 'Christie.png', 'Kokoro.png', 'Eagle.png',
                'Sophitia.png', 'Shizumaru.png', 'Kagome.png', 'Kabal.png', 'Kuma.png',
                'Alice.png', 'Shinnok.png', 'FANG.png', 'Lili.png', 'Mega Man.png', 'Mai.png'
            ];

            const user = auth.currentUser;
            const userRef = ref(database, `users/${user.uid}`);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            const currentIcon = userData.icon;

            if (category === 'default') {
                defaultIcons.forEach(icon => {
                    createIconElement(icon, icon === currentIcon, false);
                });
            } else if (category === 'owned' && user) {
                const userIconsRef = ref(database, `users/${user.uid}/Icons`);
                const iconSnapshot = await get(userIconsRef);
                if (iconSnapshot.exists()) {
                    const userIcons = iconSnapshot.val();
                    Object.entries(userIcons).forEach(([iconName, owned]) => {
                        if (owned === 1) {
                            const iconFileName = `${iconName}.png`;
                            createIconElement(iconFileName, iconFileName === currentIcon, true);
                        }
                    });
                }
            }
        }

        function createIconElement(icon, isSelected, isSpecial) {
            const iconGrid = document.getElementById('icon-grid');
            const iconItem = document.createElement('div');
            iconItem.className = `icon-item${isSelected ? ' selected' : ''}`;
            iconItem.dataset.name = icon.toLowerCase();

            const iconPreview = document.createElement('div');
            iconPreview.className = 'icon-preview';

            const img = document.createElement('img');
            img.src = isSpecial ? `Icons/Profile/${icon}` : `Icons/${icon}`;
            img.alt = icon.replace('.png', '');
            img.onerror = () => {
                img.src = isSpecial ? `Icons/${icon}` : `Icons/Profile/${icon}`;
            };

            const name = document.createElement('div');
            name.className = 'icon-name';
            name.textContent = icon.replace('.png', '');

            if (isSpecial) {
                const specialBadge = document.createElement('div');
                specialBadge.className = 'icon-special-badge';
                specialBadge.innerHTML = '<i class="fas fa-star"></i>';
                iconItem.appendChild(specialBadge);
            }

            iconPreview.appendChild(img);
            iconItem.appendChild(iconPreview);
            iconItem.appendChild(name);
            
            iconItem.onclick = () => selectIcon(icon, iconItem);
            iconGrid.appendChild(iconItem);
        }

        async function selectIcon(icon, selectedItem) {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const userRef = ref(database, `users/${user.uid}`);
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    userData.icon = icon;
                    await set(userRef, userData);

                    // Update selected state in grid
                    document.querySelectorAll('.icon-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    selectedItem.classList.add('selected');

                    // Update profile image
                    setProfileImage(`Icons/${icon}`, `Icons/Profile/${icon}`);
                    closeIconSelector();
                    console.log('Icon updated successfully');
                }
            } catch (error) {
                console.error('Error updating icon:', error);
            }
        }

        window.filterIcons = function() {
            const searchText = document.querySelector('.icon-search').value.toLowerCase();
            const items = document.querySelectorAll('.icon-item');
            
            items.forEach(item => {
                const name = item.dataset.name;
                if (name.includes(searchText)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        };

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('icon-selector-modal');
            if (event.target === modal) {
                closeIconSelector();
            }
        };

        // Music Player Script
        import { initMusicPlayer } from './music-player.js';

        document.addEventListener('DOMContentLoaded', () => {
            initializeAuthState();
            initMusicPlayer();
            initializeQuestSystem(); // Initialize quest system

            // Initialize profile menu click handlers
            const profileInfo = document.getElementById('profile-info');
            const profileMenu = document.getElementById('profile-menu');

            if (profileInfo) {
                profileInfo.addEventListener('click', toggleProfileMenu);
            }

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (profileMenu && profileMenu.classList.contains('show') && 
                    !profileInfo.contains(event.target) &&
                    !profileMenu.contains(event.target)) {
                    profileMenu.classList.remove('show');
                }
            });

            // Close modal when clicking outside
            window.onclick = function(event) {
                const modal = document.getElementById('icon-selector-modal');
                if (event.target === modal) {
                    closeIconSelector();
                }
            };

            // Add progress bar click handling
            const progressContainer = document.querySelector('.progress-bar');
            progressContainer.addEventListener('click', (e) => {
                const width = progressContainer.clientWidth;
                const clickX = e.offsetX;
                const duration = audio.duration;
                audio.currentTime = (clickX / width) * duration;
            });

            // Add volume slider handling
            const volumeSlider = document.querySelector('.volume-slider');
            volumeSlider.addEventListener('input', (e) => {
                audio.volume = e.target.value / 100;
            });

            // Initialize character grid with roles
            function initializeCharacterGrid() {
                const grid = document.querySelector('.character-grid');
                const searchInput = document.getElementById('character-search');
                const roleFilters = document.querySelectorAll('.role-filter');
                let currentFilter = 'all';

                // Get all unique characters with their roles
                const characters = new Set();
                Object.entries(roles).forEach(([role, chars]) => {
                    chars.forEach(char => {
                        characters.add(char);
                    });
                });

                // Create character array with roles and sort alphabetically
                const characterData = Array.from(characters).sort().map(name => {
                    const characterRoles = [];
                    Object.entries(roles).forEach(([role, chars]) => {
                        if (chars.includes(name)) {
                            characterRoles.push(role.toLowerCase());
                        }
                    });
                    return {
                        name,
                        roles: characterRoles,
                        image: `Icons/${name}.png`
                    };
                });

                // Function to create character card
                function createCharacterCard(character) {
                    const card = document.createElement('a');
                    card.href = `ch/${character.name}.html`;
                    card.className = `character-card ${character.roles.join(' ')}`;
                    card.dataset.roles = character.roles.join(',');
                    
                    card.innerHTML = `
                        <div class="character-image-container">
                            <img src="${character.image}" alt="${character.name}">
                            <div class="character-overlay">
                                <div class="character-roles">
                                    ${character.roles.map(role => `
                                        <span class="role-icon">
                                            <i class="fas ${getRoleIcon(role)}"></i>
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="character-info">
                            <h3>${character.name}</h3>
                        </div>
                    `;
                    
                    return card;
                }

                // Function to get role icon
                function getRoleIcon(role) {
                    const icons = {
                        top: 'fa-chevron-up',
                        jungle: 'fa-tree',
                        mid: 'fa-star',
                        adc: 'fa-crosshairs',
                        support: 'fa-heart'
                    };
                    return icons[role] || 'fa-user';
                }

                // Initial render
                function renderCharacters() {
                    grid.innerHTML = '';
                    const searchTerm = searchInput.value.toLowerCase();
                    
                    characterData.forEach(character => {
                        if ((currentFilter === 'all' || character.roles.includes(currentFilter)) &&
                            character.name.toLowerCase().includes(searchTerm)) {
                            grid.appendChild(createCharacterCard(character));
                        }
                    });
                }

                // Event listeners
                searchInput.addEventListener('input', renderCharacters);

                roleFilters.forEach(button => {
                    button.addEventListener('click', () => {
                        roleFilters.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        currentFilter = button.dataset.role;
                        renderCharacters();
                    });
                });

                // Initial render
                renderCharacters();
            }

            // Initialize when DOM is loaded
            initializeCharacterGrid();
        });

        // Quest System Functions
        window.toggleQuestWindow = function(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            const questWindow = document.getElementById('quest-window');
            if (!questWindow.classList.contains('show')) {
                questWindow.style.display = 'block';
                // Trigger reflow
                questWindow.offsetHeight;
                questWindow.classList.add('show');
                loadQuestData('daily'); // Load daily quests by default
            } else {
                closeQuestWindow();
            }
        };

        window.closeQuestWindow = function() {
            const questWindow = document.getElementById('quest-window');
            questWindow.classList.remove('show');
            // Wait for animation to complete before hiding
            setTimeout(() => {
                questWindow.style.display = 'none';
            }, 300);
        };

        window.switchQuestTab = function(tabName) {
            // Update active tab
            const tabs = document.querySelectorAll('.quest-tab');
            tabs.forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // Update header text
            const header = document.querySelector('.quest-header h2');
            header.innerHTML = `
                <i class="fas fa-tasks"></i>
                ${tabName === 'daily' ? 'Daily' : 'Special'} Quests
            `;

            // Load quests for the selected tab
            loadQuestData(tabName);
        };

        function initializeQuestSystem() {
            // Close quest window when clicking outside
            window.addEventListener('click', function(event) {
                const questWindow = document.getElementById('quest-window');
                if (event.target === questWindow) {
                    closeQuestWindow();
                }
            });

            // Initialize with sample quest data
            loadQuestData('daily');
        }

        async function loadQuestData(questType) {
            const questList = document.querySelector('.quest-list');
            questList.innerHTML = ''; // Clear existing quests

            const user = auth.currentUser;
            if (!user) return;

            try {
                // Get user's quests and games played from database
                const [userQuestsSnapshot, gamesPlayedSnapshot, lastRoleSnapshot] = await Promise.all([
                    get(ref(database, `users/${user.uid}/quests`)),
                    get(ref(database, `users/${user.uid}/gamesPlayed`)),
                    get(ref(database, `users/${user.uid}/lastPlayedRole`))
                ]);
                
                const userQuests = userQuestsSnapshot.val() || {};
                const gamesPlayed = gamesPlayedSnapshot.val() || 0;
                const lastPlayedRole = lastRoleSnapshot.val();

                // Import quest templates
                const { questTemplates } = await import('./quests.js');
                const templates = questTemplates[questType] || [];

                // Process each quest template
                for (const template of templates) {
                    let userQuestData = userQuests[template.id] || {
                        progress: 0,
                        completed: false,
                        claimed: false,
                        lastReset: Date.now()
                    };

                    // Check if quest needs reset (for daily quests)
                    if (questType === 'daily' && template.resetInterval) {
                        const currentTime = Date.now();
                        const timeSinceReset = currentTime - (userQuestData.lastReset || 0);
                        
                        if (timeSinceReset >= template.resetInterval) {
                            console.log('Resetting daily quest - 18 hours passed');
                            userQuestData = {
                                progress: template.id === 'daily_games' ? 0 : 0,
                                completed: false,
                                claimed: false,
                                lastReset: currentTime
                            };
                            await set(ref(database, `users/${user.uid}/quests/${template.id}`), userQuestData);
                        }
                    }

                    // Update progress based on games played for daily_games quest
                    if (template.id === 'daily_games' && !userQuestData.claimed) {
                        userQuestData.progress = gamesPlayed - (userQuestData.lastGameCount || 0);
                        userQuestData.completed = userQuestData.progress >= template.requirements.count;
                        userQuestData.lastGameCount = gamesPlayed;
                        await set(ref(database, `users/${user.uid}/quests/${template.id}`), userQuestData);
                    }

                    // Update progress for character-specific quests
                    if (template.requirements.type === 'play_character' && !userQuestData.claimed) {
                        const lastPlayedRef = ref(database, `users/${user.uid}/lastPlayedCharacter`);
                        const lastPlayedSnapshot = await get(lastPlayedRef);
                        const lastPlayedCharacter = lastPlayedSnapshot.val();

                        if (lastPlayedCharacter && template.requirements.characters.includes(lastPlayedCharacter)) {
                            userQuestData.progress = 1;
                            userQuestData.completed = true;
                            await set(ref(database, `users/${user.uid}/quests/${template.id}`), userQuestData);
                        }
                    }

                    // Update progress for role-specific quests
                    if (template.requirements.type === 'play_role' && !userQuestData.claimed) {
                        if (lastPlayedRole && template.requirements.roles.includes(lastPlayedRole.toLowerCase())) {
                            userQuestData.progress = (userQuestData.progress || 0) + 1;
                            userQuestData.completed = userQuestData.progress >= template.requirements.count;
                            await set(ref(database, `users/${user.uid}/quests/${template.id}`), userQuestData);
                        }
                    }

                    // Create quest element
                    const questElement = createQuestElement({
                        ...template,
                        progress: userQuestData.progress,
                        total: template.requirements.count,
                        lastReset: userQuestData.lastReset,
                        status: userQuestData.claimed ? 'completed' : 
                                userQuestData.completed ? 'claim-ready' : 
                                userQuestData.progress > 0 ? 'in-progress' : 'not-started'
                    });

                    questList.appendChild(questElement);
                }
            } catch (error) {
                console.error('Error loading quests:', error);
            }
        }

        function createQuestElement(quest) {
            const questElement = document.createElement('div');
            questElement.classList.add('quest-item');
            
            const progressPercentage = (quest.progress / quest.total) * 100;

            // Determine time display text
            let timeDisplay = '';
            if (quest.id === 'win_streak' || quest.id === 'bot_lane_games' || quest.id === 'love_day_win') {
                timeDisplay = 'Repeatable Quest';
            } else if (quest.lastReset) {
                const resetTime = quest.lastReset + 64800000; // 18 hours in milliseconds
                const currentTime = Date.now();
                const remainingTime = resetTime - currentTime;
                
                if (remainingTime <= 0) {
                    timeDisplay = 'Ready to reset';
                } else {
                    const hours = Math.floor(remainingTime / (1000 * 60 * 60));
                    const minutes = Math.floor((remainingTime % (1000 * 60 * 60)) / (1000 * 60));
                    timeDisplay = `Resets in ${hours}h ${minutes}m`;
                }
            }
            
            questElement.innerHTML = `
                <div class="quest-icon">
                    <i class="fas ${quest.icon}"></i>
                </div>
                <div class="quest-info">
                    <div class="quest-header">
                        <div class="quest-title">${quest.title}</div>
                        <div class="quest-reset-time">${timeDisplay}</div>
                    </div>
                    <div class="quest-description">${quest.description}</div>
                    <div class="quest-progress">
                        <div class="progress-text">${quest.progress}/${quest.total}</div>
                        <div class="quest-progress-bar" style="width: ${progressPercentage}%"></div>
                    </div>
                    <div class="quest-rewards">
                        ${quest.rewards.map(reward => `
                            <div class="quest-reward">
                                ${reward.icon.startsWith('res/') ? 
                                    `<img src="${reward.icon}" alt="QP" class="reward-icon">` :
                                    `<i class="fas ${reward.icon}"></i>`}
                                <span>${reward.amount || reward.amounts?.[0]}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                <div class="quest-status ${quest.status}" onclick="claimReward(event, '${quest.id}')">
                    ${quest.status === 'claim-ready' ? 'Claim' : quest.status === 'completed' ? 'Completed' : 
                      quest.status === 'in-progress' ? 'In Progress' : 'Not Started'}
                </div>
            `;
            
            // Only start timer for daily quests
            if (quest.lastReset) {
                const resetTimeElement = questElement.querySelector('.quest-reset-time');
                const resetTime = quest.lastReset + 64800000;
                const updateTimer = setInterval(() => {
                    const now = Date.now();
                    const timeRemaining = resetTime - now;
                    
                    if (timeRemaining > 0) {
                        const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
                        const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                        resetTimeElement.textContent = `Resets in ${hours}h ${minutes}m`;
                    } else {
                        clearInterval(updateTimer);
                        resetTimeElement.textContent = 'Ready to reset';
                        // Reload quest data when timer reaches zero
                        loadQuestData('daily');
                    }
                }, 60000); // Update every minute
            }
            
            return questElement;
        }

        async function claimReward(event, questId) {
            event.stopPropagation();
            const user = auth.currentUser;
            if (!user) return;

            const userId = user.uid;
            const questRef = ref(database, `users/${userId}/quests/${questId}`);
            const userRef = ref(database, `users/${userId}`);
            
            try {
                const [questSnap, userSnap] = await Promise.all([
                    get(questRef),
                    get(userRef)
                ]);
                
                const questData = questSnap.val();
                const userData = userSnap.val();
                
                if (!questData || !questData.completed || questData.claimed) return;
                
                // Find quest template
                const questTemplate = findQuestTemplate(questId);
                if (!questTemplate) return;
                
                const updates = {};
                
                // Process each reward
                for (const reward of questTemplate.rewards) {
                    if (reward.type === 'questPoints') {
                        const currentQP = userData.questPoints || 0;
                        updates['questPoints'] = currentQP + reward.amount;
                    } else if (reward.type === 'championMoney') {
                        const currentCM = userData.CM || 0;
                        updates['CM'] = currentCM + reward.amount;
                    }
                }
                
                // Mark quest as claimed
                updates[`quests/${questId}/claimed`] = true;
                
                // If this is a repeatable quest, reset progress
                if (questId === 'win_streak' || questId === 'love_day_win' || questId === 'bot_lane_games') {
                    updates[`quests/${questId}/progress`] = 0;
                    updates[`quests/${questId}/completed`] = false;
                    if (questId === 'win_streak') {
                        updates[`quests/${questId}/streak`] = 0;
                    }
                }
                
                // Apply all updates
                await update(userRef, updates);
                
                // Refresh quest display
                await loadQuestData();
                
            } catch (error) {
                console.error('Error claiming quest reward:', error);
            }
        }
    </script>
    </div>
</body>
</html> 