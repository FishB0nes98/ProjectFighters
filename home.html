<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Champion Selector</title>
    <!-- Include Firebase SDK and configuration as module scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js" type="module"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <script type="module" src="music-player.js"></script>
    <script type="module" src="songs.js"></script>
    <!-- Music Player Styles -->
    
    <script type="module">
        // Firebase imports
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.10.0/firebase-analytics.js";
        import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, push, set, get, update, runTransaction } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js';
        import { roles } from './roles.js';

        // Global variables for demo player
        window.atlantisDemoPlaying = false;
        window.atlantisDemoTimeout = null;
        
    // Make database functions available globally
    window.ref = ref;
    window.push = push;
    window.set = set;
    window.get = get;
    window.update = update;
    window.runTransaction = runTransaction;

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqhxq6sPDU3EmuvvkBIIDJ-H6PsBc42Jg",
            authDomain: "project-fighters-by-fishb0nes.firebaseapp.com",
            databaseURL: "https://project-fighters-by-fishb0nes-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-fighters-by-fishb0nes",
            storageBucket: "project-fighters-by-fishb0nes.appspot.com",
            messagingSenderId: "867339299995",
            appId: "1:867339299995:web:99c379940014b9c05cea3e",
            measurementId: "G-LNEM6HR842"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Export Firebase instances for other modules
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDatabase = database;

        // Helper functions
        function capitalizeTitle(title) {
            if (!title) return '';
            return title.split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                .join(' ');
        }


        // Auth state initialization
        function initializeAuthState() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();
                        
                        if (userData) {
                            // Update username and title
                            const usernameContainer = document.querySelector('.username-title-container');
                            if (usernameContainer) {
                                const usernameDisplay = usernameContainer.querySelector('#username-display');
                                if (usernameDisplay) {
                                    usernameDisplay.textContent = userData.username || user.email.split('@')[0];
                                }

                                // Update title if it exists
                                let titleDisplay = usernameContainer.querySelector('#title-display');
                                if (userData.activeTitle) {
                                    if (!titleDisplay) {
                                        titleDisplay = document.createElement('div');
                                        titleDisplay.id = 'title-display';
                                        usernameContainer.appendChild(titleDisplay);
                                    }
                                    titleDisplay.textContent = `(${capitalizeTitle(userData.activeTitle)})`;
                                } else if (titleDisplay) {
                                    titleDisplay.remove();
                                }
                            }

                            // Update profile image
                            const profileImage = document.getElementById('profile-image');
                            if (profileImage) {
                                setProfileImage(`Icons/${userData.icon || 'Birdie.png'}`, `Icons/Profile/${userData.icon || 'Birdie.png'}`);
                            }

                            // Update currency displays
                            const currencyAmount = document.getElementById('currency-amount');
                            const cmAmount = document.getElementById('cm-amount');
                            const qpAmount = document.getElementById('qp-amount');
                            if (currencyAmount) currencyAmount.textContent = userData.FM || 0;
                            if (cmAmount) cmAmount.textContent = userData.CM || 0;
                            if (qpAmount) qpAmount.textContent = userData.questPoints || 0;

                            // Initialize quests only if they haven't been initialized yet
                            const questsContainer = document.querySelector('#new-quests-box .content');
                            if (questsContainer && !questsContainer.hasAttribute('data-initialized')) {
                                questsContainer.setAttribute('data-initialized', 'true');
                                const questsRef = ref(database, `users/${userId}/quests`);
                                const questsSnapshot = await get(questsRef);
                                const questsData = questsSnapshot.val() || {};

                                questsContainer.innerHTML = '';
                                quests.forEach(quest => {
                                    const questData = questsData[quest.id] || { progress: 0, completed: false, claimed: false };
                                    if (!questData.claimed) {
                                        displayQuest(quest, questData, userData);
                                    }
                                });
                            }

                            // Initialize friend list only if it hasn't been initialized yet
                            const friendListUL = document.getElementById('friend-list-ul');
                            if (friendListUL && !friendListUL.hasAttribute('data-initialized')) {
                                friendListUL.setAttribute('data-initialized', 'true');
                                loadFriendList(userId);
                            }

                            // Check and show Julia reward
                            checkAndShowJuliaReward();
                        }
                    } catch (error) {
                        console.error('Error initializing user data:', error);
                    }
                } else {
                    window.location.href = 'index.html';
                }
            });
        }

        // Expose necessary functions to global scope
        window.initializeAuthState = initializeAuthState;
        window.createParticles = createParticles;
        window.capitalizeTitle = capitalizeTitle;

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Firebase auth state
            initializeAuthState();

            // Create particles
            createParticles();

            // Initialize click handlers for profile image and container
            const profileInfo = document.getElementById('profile-info');
            const profileImage = document.getElementById('profile-image');
            const profileMenu = document.getElementById('profile-menu');
            const usernameDisplay = document.getElementById('username-display');

            // Global toggle function for the profile menu
            window.toggleProfileMenu = function(event) {
                if (event) {
                    event.stopPropagation();
                }
                if (profileMenu) {
                    profileMenu.classList.toggle('show');
                }
            }

            // Add click handlers
            if (profileInfo) {
                profileInfo.addEventListener('click', toggleProfileMenu);
            }
            if (profileImage) {
                profileImage.addEventListener('click', toggleProfileMenu);
            }
            if (usernameDisplay) {
                usernameDisplay.addEventListener('click', toggleProfileMenu);
            }

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (profileMenu && profileMenu.classList.contains('show') && 
                    !profileInfo.contains(event.target) &&
                    !profileMenu.contains(event.target)) {
                    profileMenu.classList.remove('show');
                }
            });

            // Initialize quest container
            const questContent = document.querySelector('#new-quests-box .content');
            const questToggleButton = document.getElementById('toggle-quests');
            if (questContent && questToggleButton) {
                questContent.style.display = 'none';
                questToggleButton.innerHTML = '&#9660;';
            }

            // Quest toggle functionality
            const toggleQuestsButton = document.getElementById('toggle-quests');
            if (toggleQuestsButton) {
                toggleQuestsButton.addEventListener('click', function() {
                    const content = document.querySelector('#new-quests-box .content');
                    if (content) {
                        const isHidden = content.style.display === 'none';
                        content.style.display = isHidden ? 'block' : 'none';
                        toggleQuestsButton.innerHTML = isHidden ? '&#9650;' : '&#9660;';
                    }
                });
            }

            // Initialize advent calendar button
            const adventCalendarButton = document.querySelector('.advent-calendar-button');
            if (adventCalendarButton) {
                adventCalendarButton.addEventListener('click', async function() {
                    const { openAdventCalendar } = await import('./advent-calendar.js');
                    openAdventCalendar();
                });
            }
        });

        // Friend list helper functions
        function loadFriendList(userId) {
            const friendRef = ref(database, 'users/' + userId + '/friends');
            get(friendRef).then(snapshot => {
                const friendListUL = document.getElementById('friend-list-ul');
                if (friendListUL) {
                    friendListUL.innerHTML = ''; // Clear existing entries
                    if (snapshot.exists()) {
                        snapshot.forEach(childSnapshot => {
                            const friendData = childSnapshot.val();
                            loadFriendIcon(friendData.id, friendData.name);
                        });
                    }
                }
            }).catch(error => {
                console.error('Error loading friend list:', error);
            });
        }

        function loadFriendIcon(friendId, friendName) {
            const friendIconRef = ref(database, 'users/' + friendId + '/icon');
            get(friendIconRef).then(iconSnapshot => {
                const iconFilename = iconSnapshot.exists() ? iconSnapshot.val() : 'default-icon.jpg';
                const primaryIconUrl = `Icons/${iconFilename}`;
                const fallbackIconUrl = `Icons/Profile/${iconFilename}`;
                displayFriend(friendName, primaryIconUrl, fallbackIconUrl);
            }).catch(error => {
                console.error('Error loading friend icon:', error);
            });
        }

        function displayFriend(friendName, primaryIconUrl, fallbackIconUrl) {
            const friendListUL = document.getElementById('friend-list-ul');
            if (friendListUL) {
                const li = document.createElement('li');
                li.classList.add('friend-item');

                const img = document.createElement('img');
                img.src = primaryIconUrl;
                img.alt = 'Friend Icon';
                img.classList.add('friend-icon');
                img.onerror = () => {
                    img.onerror = null;
                    img.src = fallbackIconUrl;
                };

                const nameLink = document.createElement('a');
                nameLink.href = `ProfileVisitor.html?username=${friendName}`;
                nameLink.textContent = friendName;
                nameLink.classList.add('friend-name');

                li.appendChild(img);
                li.appendChild(nameLink);
                friendListUL.appendChild(li);
            }
        }

        // Initialize event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Video background handling
            const video = document.getElementById('video-background');
            if (video) {
                video.playbackRate = 1.0;
                video.play().catch(function(error) {
                    console.log("Video autoplay was prevented:", error);
                });
            }

            // Initialize Toggle Button State
            const championSelector = document.getElementById('champion-selector-container');
            const toggleButton = document.getElementById('toggle-champion-button');
            if (championSelector && toggleButton) {
                championSelector.style.display = 'flex';
            }

            // Single friend list initialization
            const toggleFriendListButton = document.getElementById("toggle-friend-list");
            const friendList = document.getElementById("friend-list");
            const addFriendButton = document.getElementById("add-friend-button");
            const friendNameInput = document.getElementById("friend-name-input");

            if (toggleFriendListButton && friendList) {
                toggleFriendListButton.addEventListener("click", function() {
                    friendList.style.display = friendList.style.display === "none" ? "block" : "none";
                });
            }

            if (addFriendButton && friendNameInput) {
                addFriendButton.addEventListener("click", async function() {
                    const friendName = friendNameInput.value;
                    if (friendName) {
                        try {
                            const userId = auth.currentUser.uid;
                            const usersRef = ref(database, 'users');
                            const snapshot = await get(usersRef);
                            let friendId = null;

                            snapshot.forEach(childSnapshot => {
                                const userData = childSnapshot.val();
                                if (userData.username === friendName) {
                                    friendId = childSnapshot.key;
                                }
                            });

                            if (friendId) {
                                const friendRef = ref(database, 'users/' + userId + '/friends');
                                const newFriendRef = push(friendRef);
                                await set(newFriendRef, {
                                    id: friendId,
                                    name: friendName
                                });
                                friendNameInput.value = '';
                                loadFriendList(userId);
                            } else {
                                alert('Username not found');
                            }
                        } catch (error) {
                            console.error('Error adding friend:', error);
                        }
                    }
                });
            }
        });
    

    function createParticles() {
        const particleContainer = document.querySelector('.particle-container');
        if (!particleContainer) {
            const newParticleContainer = document.createElement('div');
            newParticleContainer.classList.add('particle-container');
            document.body.appendChild(newParticleContainer);
        }

        for (let i = 0; i < 60; i++) { // Increase number for more particles
            const particle = document.createElement('div');
            particle.classList.add('particle');
            particle.style.left = `${Math.random() * 100}%`;
            particle.style.top = `${Math.random() * 100}%`;
            particle.style.width = `${Math.random() * 6 + 4}px`; // Size between 4px and 10px
            particle.style.height = particle.style.width;
            particle.style.background = `rgba(${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, ${Math.floor(Math.random() * 255)}, 0.7)`;
            particle.style.animationDuration = `${Math.random() * 5 + 3}s`; // Duration between 3s and 8s
            particle.style.animationDelay = `${Math.random() * 5}s`; // Delay between 0s and 5s
            document.querySelector('.particle-container').appendChild(particle);
        }
    }

    window.openChangeIconModal = async function() {
        const modal = document.getElementById('change-icon-modal');
        modal.style.display = 'block';

        // Load icons dynamically
        const iconList = document.getElementById('icon-list');
        iconList.innerHTML = '';

        const icons = [
            'Julia.png', 'Birdie.png', 'Erron Black.png', 'Cham Cham.png', 'Morrigan.png',
            'Jun.png', 'Reptile.png', 'Akuma.png', 'Elphelt.png', 'Kotal Kahn.png',
            'Scorpion.png', 'Peacock.png', 'Angel.png', 'Astaroth.png', 'Ibuki.png',
            'R.Mika.png', 'Raiden.png', 'Yugo.png', 'Talim.png', 'Noel.png',
            'Blanka.png', 'Nina.png', 'Ayane.png', 'Siegfried.png', 'Shoma.png', 
            'Juri.png', 'Sub Zero.png', 'Christie.png', 'Kokoro.png', 'Eagle.png',
            'Sophitia.png', 'Shizumaru.png', 'Kagome.png', 'Kabal.png', 'Kuma.png',
            'Alice.png', 'Shinnok.png', 'FANG.png', 'Lili.png', 'Mega Man.png', "Mai.png"
        ];

        icons.forEach(icon => {
            const img = document.createElement('img');
            img.src = `Icons/${icon}`;
            img.alt = icon.replace('.png', '');
            img.classList.add('icon-image');
            img.onclick = () => selectIcon(icon);
            iconList.appendChild(img);
        });

        // Fetch user-specific icons from the database
        const user = auth.currentUser;
        if (user) {
            const userRef = ref(database, 'users/' + user.uid + '/Icons');
            const snapshot = await get(userRef);
            if (snapshot.exists()) {
                const userIcons = snapshot.val();
                for (const iconName in userIcons) {
                    if (userIcons[iconName] === 1) { // Check if the value is 1
                        const img = document.createElement('img');
                        img.src = `Icons/Profile/${iconName}.png`;
                        img.alt = iconName.replace('.png', '');
                        img.classList.add('icon-image');
                        img.onclick = () => selectIcon(iconName + '.png');
                        iconList.appendChild(img);
                    }
                }
            }
        }
    };

    window.logOut = function() {
        signOut(auth).then(() => {
            console.log('User signed out successfully');
            window.location.href = 'index.html'; // Redirect to login page after sign out
        }).catch((error) => {
            console.error('Error signing out:', error);
        });
    };

    function selectIcon(icon) {
        const user = auth.currentUser;
        if (user) {
            updateIcon(icon)
                .then(() => {
                    setProfileImage(`Icons/${icon}`, `Icons/Profile/${icon}`);
                    closeChangeIconModal();
                })
                .catch(error => {
                    console.error('Error updating icon:', error);
                });
        } else {
            console.error('User not authenticated');
        }
    }

    async function updateIcon(icon) {
        const user = auth.currentUser;
        if (user) {
            const userRef = ref(database, 'users/' + user.uid);
            try {
                const snapshot = await get(userRef);
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    userData.icon = icon; // Update the icon field
                    await set(userRef, userData); // Write back the updated data
                    console.log('Icon updated successfully');
                } else {
                    console.error('No user data found');
                }
            } catch (error) {
                console.error('Error updating icon:', error);
            }
        } else {
            console.error('User not authenticated');
        }
    }

    function setProfileImage(primaryPath, fallbackPath) {
        const img = document.getElementById('profile-image');
        img.onerror = () => {
            img.onerror = null; // Remove error handler to avoid infinite loop
            img.src = fallbackPath;
        };
        img.src = primaryPath;
    }

    window.closeChangeIconModal = function() {
        const modal = document.getElementById('change-icon-modal');
        modal.style.display = 'none';
    };

    

    window.toggleProfileMenu = function() {
        const profileMenu = document.getElementById('profile-menu');
        profileMenu.classList.toggle('show');
    };

    window.searchChampion = function() {
        const input = document.getElementById('search-bar').value.toLowerCase();
        const images = document.getElementsByClassName('champion-image');
        for (let i = 0; i < images.length; i++) {
            const altText = images[i].alt.toLowerCase();
            if (altText.includes(input)) {
                images[i].style.display = '';
            } else {
                images[i].style.display = 'none';
            }
        }
    };


    window.updateQuestProgress = async function() {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

            const userId = user.uid;
        const questsRef = ref(database, `users/${userId}/quests`);
        const userRef = ref(database, `users/${userId}`);

        try {
            // Get quest data
            const questsSnapshot = await get(questsRef);
            const questsData = questsSnapshot.val() || {};

            // Get user data for quest points
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val() || {};

            // Update quest points display
            const questPointsDisplay = document.getElementById('quest-points-amount');
            if (questPointsDisplay) {
                questPointsDisplay.textContent = userData.questPoints || 0;
            }

            // Define quest goals
            const questGoals = {
                'win-games': 2,
                'lose-games': 2,
                'win-against': 1,
                'win-as-atlantean': 1
            };

            // Update win games quest
            const winQuestData = questsData['win-games'] || {};
            const winProgress = document.getElementById('win-games-progress');
            if (winProgress) {
                const progressBar = winProgress.parentElement.querySelector('.progress');
                const progressText = winProgress.parentElement.nextElementSibling;
                const claimButton = winProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = winQuestData.progress || 0;
                const completed = winQuestData.completed || false;
                const claimed = winQuestData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['win-games']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['win-games']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            // Update lose games quest
            const loseQuestData = questsData['lose-games'] || {};
            const loseProgress = document.getElementById('lose-games-progress');
            if (loseProgress) {
                const progressBar = loseProgress.parentElement.querySelector('.progress');
                const progressText = loseProgress.parentElement.nextElementSibling;
                const claimButton = loseProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = loseQuestData.progress || 0;
                const completed = loseQuestData.completed || false;
                const claimed = loseQuestData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['lose-games']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['lose-games']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            // Update win against quest
            const winAgainstData = questsData['win-against'] || {};
            const winAgainstProgress = document.getElementById('win-against-progress');
            if (winAgainstProgress) {
                const progressBar = winAgainstProgress.parentElement.querySelector('.progress');
                const progressText = winAgainstProgress.parentElement.nextElementSibling;
                const claimButton = winAgainstProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = winAgainstData.progress || 0;
                const completed = winAgainstData.completed || false;
                const claimed = winAgainstData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['win-against']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['win-against']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            // Update win as atlantean quest
            const winAsAtlanteanData = questsData['win-as-atlantean'] || {};
            const winAsAtlanteanProgress = document.getElementById('win-as-atlantean-progress');
            if (winAsAtlanteanProgress) {
                const progressBar = winAsAtlanteanProgress.parentElement.querySelector('.progress');
                const progressText = winAsAtlanteanProgress.parentElement.nextElementSibling;
                const claimButton = winAsAtlanteanProgress.closest('.quest-item').querySelector('.claim-button');
                
                const progress = winAsAtlanteanData.progress || 0;
                const completed = winAsAtlanteanData.completed || false;
                const claimed = winAsAtlanteanData.claimed || false;

                progressBar.style.width = `${(progress / questGoals['win-as-atlantean']) * 100}%`;
                progressText.textContent = `${progress}/${questGoals['win-as-atlantean']}`;
                claimButton.style.display = completed && !claimed ? 'block' : 'none';
            }

            console.log('Quest data updated:', questsData); // Debug log
        } catch (error) {
            console.error('Error updating quest progress:', error);
        }
    }

    function checkCharacterQuestProgress(team) {
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const userRef = ref(database, `users/${userId}`);
            get(userRef).then(snapshot => {
                const userData = snapshot.val();
                quests.forEach(quest => {
                    if (quest.id === 'winAsSpecificCharacter' && quest.requirement(userData)) {
                        updateQuestProgress(quest.id);
                    }
                });
            });
        } else {
            console.error('User not authenticated');
        }
    }

    async function claimQuestReward(questId, reward) {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

            const userId = user.uid;
            const questRef = ref(database, `users/${userId}/quests/${questId}`);
        const questSnapshot = await get(questRef);
        const questData = questSnapshot.val();

        if (questData && questData.completed && !questData.claimed) {
            const updates = {};
            
            // Reset quest progress and status
            updates[`users/${userId}/quests/${questId}/progress`] = 0;
            updates[`users/${userId}/quests/${questId}/completed`] = false;
            updates[`users/${userId}/quests/${questId}/claimed`] = false;
            
            // Add quest points
            const userRef = ref(database, `users/${userId}`);
            const userSnapshot = await get(userRef);
            const currentQuestPoints = userSnapshot.val()?.questPoints || 0;
            updates[`users/${userId}/questPoints`] = currentQuestPoints + reward;

            // Apply all updates
            await update(ref(database), updates);
            
            // Update display
            await updateQuestProgress();
        }
    }

    // Enhanced quest display function with reward images
    function displayQuest(quest, questData, userData) {
        const questContainer = document.querySelector('#new-quests-box .content');
        const questElement = document.createElement('div');
        questElement.classList.add('quest');
        questElement.id = `quest-${quest.id}`;

        const questContent = `
            <div class="quest-header">
                <div class="quest-info">
                    <h3>${quest.title}</h3>
                    <p class="quest-description">${quest.description}</p>
                </div>
                <div class="quest-reward" title="${quest.hoverText}">
                    <div class="reward-item">
                        <img src="${quest.image}" alt="Reward" class="reward-image">
                        <span class="reward-amount">+${Object.values(quest.reward)[0]}</span>
                    </div>
                </div>
            </div>
            <div class="quest-progress-container">
                <div class="quest-progress">
                    <div class="progress-bar" style="width: ${(questData.progress / quest.goal) * 100}%"></div>
                </div>
                <span class="progress-text">${questData.progress}/${quest.goal}</span>
            </div>
            ${questData.completed && !questData.claimed ? 
                '<button class="quest-button claim-button" onclick="claimQuestReward(\'' + quest.id + '\')">Claim Reward</button>' : 
                ''}
        `;

        questElement.innerHTML = questContent;
        questContainer.appendChild(questElement);
    }

    window.acceptQuest = function(questId) {
        const user = auth.currentUser;
        if (user) {
            const userId = user.uid;
            const userRef = ref(database, `users/${userId}/quests/${questId}`);
            set(userRef, { progress: 0, completed: false, claimed: false });
            document.getElementById(`accept-quest-button-${questId}`).style.display = 'none';
        } else {
            console.error('User not authenticated');
        }
    };

    // Add event listener for advent calendar button
    document.addEventListener('DOMContentLoaded', function() {
        const adventCalendarButton = document.querySelector('.advent-calendar-button');
        if (adventCalendarButton) {
            adventCalendarButton.addEventListener('click', async function() {
                const { openAdventCalendar } = await import('./advent-calendar.js');
                openAdventCalendar();
            });
        }
    });

    async function openQuestWindow() {
        try {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
        const questWindow = document.getElementById('quest-window');
        if (questWindow) {
            questWindow.style.display = 'block';
                await updateQuestPoints();
                await updateQuestProgress();

                // Check owned skins and update recolor buttons
                const user = auth.currentUser;
                if (user) {
                    const userId = user.uid;
                    const userRef = ref(database, `users/${userId}`);
                    const snapshot = await get(userRef);
                    const userData = snapshot.val() || {};
                    const ownedSkins = userData.skins || {};
                    const ownedSongs = userData.Songs || {};

                    // Update Lili recolor buttons
                    const recolorMap = {
                        'holiday': 'Winter Festival Lili Holiday',
                        'snowy-blush': 'Winter Festival Lili Snowy Blush',
                        'golden': 'Winter Festival Lili Golden',
                        'snowflake': 'Winter Festival Lili Snowflake'
                    };

                    // Update all recolor buttons
                    for (const [recolorId, skinName] of Object.entries(recolorMap)) {
                        const claimButton = document.querySelector(`button[onclick="unlockRecolor('${recolorId}', 1000)"]`);
                        if (claimButton) {
                            if (ownedSkins[skinName]) {
                                claimButton.disabled = true;
                                claimButton.textContent = 'Claimed';
                                claimButton.style.backgroundColor = '#666';
                            } else {
                                claimButton.disabled = false;
                                claimButton.innerHTML = `Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 1000`;
                                claimButton.style.backgroundColor = '#4682B4';
                            }
                        }
                    }

                    // Update Atlantis reward buttons
                    // Check Atlantean Kagome skin
                    const kagomeButton = document.querySelector(`button[onclick="unlockAtlantisReward('atlantean-kagome', 2000, 'skin')"]`);
                    if (kagomeButton && ownedSkins['Atlantean Kagome']) {
                        kagomeButton.disabled = true;
                        kagomeButton.textContent = 'Claimed';
                        kagomeButton.style.backgroundColor = '#666';
                    }

                    // Check Welcome To Atlantis song
                    const songButton = document.querySelector(`button[onclick="unlockAtlantisReward('welcome-to-atlantis', 450, 'song')"]`);
                    if (songButton && ownedSongs['Welcome To Atlantis']) {
                        songButton.disabled = true;
                        songButton.textContent = 'Claimed';
                        songButton.style.backgroundColor = '#666';
                    }

                    // Check Free Lootbox
                    const lootboxButton = document.querySelector(`button[onclick="unlockAtlantisReward('free-lootbox', 1000, 'lootbox')"]`);
                    if (lootboxButton && userData.claimedQuestLootbox) {
                        lootboxButton.disabled = true;
                        lootboxButton.textContent = 'Claimed';
                        lootboxButton.style.backgroundColor = '#666';
                    }
                }
            }
            } catch (error) {
                console.error('Error opening quest window:', error);
            }
    }

    async function updateQuestPoints() {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

        const userId = user.uid;
        const userRef = ref(database, `users/${userId}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();
        const questPointsDisplay = document.getElementById('quest-points-amount');
        if (questPointsDisplay) {
            questPointsDisplay.textContent = userData?.questPoints || 0;
        }
    }

    function closeQuestWindow() {
        const questWindow = document.getElementById('quest-window');
        if (questWindow) {
            questWindow.style.display = 'none';
        }
    }

    async function unlockRecolor(recolorId, cost) {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const user = auth.currentUser;
        if (!user) return;

        const userId = user.uid;
        const userRef = ref(database, `users/${userId}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();

        if (!userData) return;

        const questPoints = userData.questPoints || 0;
        const ownedSkins = userData.skins || {};

        // Check if user already owns the skin
        const recolorMap = {
            'holiday': 'Winter Festival Lili Holiday',
            'snowy-blush': 'Winter Festival Lili Snowy Blush',
            'golden': 'Winter Festival Lili Golden',
            'snowflake': 'Winter Festival Lili Snowflake'
        };

        const skinName = recolorMap[recolorId];
        if (ownedSkins[skinName]) {
            alert('You already own this skin!');
            return;
        }

        if (questPoints >= cost) {
            // Deduct quest points
            const updates = {};
            updates[`users/${userId}/questPoints`] = questPoints - cost;

            // Add the recolor to user's skins
            if (skinName) {
                updates[`users/${userId}/skins/${skinName}`] = 1;
            }

            // Apply updates
            await update(ref(database), updates);

            // Update the quest window display
            await updateQuestProgress();

            // Disable the claim button
            const claimButton = document.querySelector(`button[onclick="unlockRecolor('${recolorId}', ${cost})"]`);
            if (claimButton) {
                claimButton.disabled = true;
                claimButton.textContent = 'Claimed';
                claimButton.style.backgroundColor = '#666'; // Grayed out color
            }

            alert('Recolor unlocked successfully!');
        } else {
            alert('Not enough quest points!');
        }
    }

    async function unlockAtlantisReward(rewardId, cost, type) {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
                const user = auth.currentUser;
        if (!user) return;

                    const userId = user.uid;
        const userRef = ref(database, `users/${userId}`);
        const snapshot = await get(userRef);
        const userData = snapshot.val();

        if (!userData) return;

        const questPoints = userData.questPoints || 0;

        // Check if user has enough quest points
        if (questPoints < cost) {
            alert('Not enough quest points!');
            return;
        }

        // Check if user already owns the reward
        if (type === 'skin') {
            const ownedSkins = userData.skins || {};
            if (ownedSkins['Atlantean Kagome']) {
                alert('You already own this skin!');
                return;
            }
        } else if (type === 'song') {
            const ownedSongs = userData.Songs || {};
            if (ownedSongs['Welcome To Atlantis']) {
                alert('You already own this song!');
                return;
            }
        } else if (type === 'lootbox') {
            const claimedLootbox = userData.claimedQuestLootbox;
            if (claimedLootbox) {
                alert('You have already claimed the free lootbox!');
                return;
            }
        }

        // Prepare updates
        const updates = {};
        updates[`users/${userId}/questPoints`] = questPoints - cost;

        // Add the reward based on type
        if (type === 'skin') {
            updates[`users/${userId}/skins/Atlantean Kagome`] = 1;
        } else if (type === 'song') {
            updates[`users/${userId}/Songs/Welcome To Atlantis`] = 1;
        } else if (type === 'lootbox') {
            updates[`users/${userId}/claimedQuestLootbox`] = true;
            // Add lootbox to inventory
            const currentLootboxes = userData.lootboxes || 0;
            updates[`users/${userId}/lootboxes`] = currentLootboxes + 1;
        }

        // Apply updates
        await update(ref(database), updates);

        // Update the quest window display
        await updateQuestProgress();

        // Disable the claim button
        const claimButton = document.querySelector(`button[onclick="unlockAtlantisReward('${rewardId}', ${cost}, '${type}')"]`);
        if (claimButton) {
            claimButton.disabled = true;
            claimButton.textContent = 'Claimed';
            claimButton.style.backgroundColor = '#666';
        }

        alert('Reward claimed successfully!');
    }

    // Add this function to your existing script
    async function checkAndShowJuliaReward() {
        const user = auth.currentUser;
        if (!user) return;

        try {
            const userSongsRef = ref(database, `users/${user.uid}/Songs`);
            const snapshot = await get(userSongsRef);
            const ownedSongs = snapshot.val() || {};

            if (!ownedSongs['Forest Wanderer (Julia Theme)']) {
                showJuliaReward();
            }
        } catch (error) {
            console.error('Error checking Julia reward:', error);
        }
    }

    function showJuliaReward() {
        const popup = document.createElement('div');
        popup.className = 'reward-popup';
        popup.innerHTML = `
            <div class="reward-popup-header">
                <h3 class="reward-popup-title">New Song Unlocked!</h3>
                <button class="reward-popup-close">×</button>
            </div>
            <div class="reward-popup-content">
                <img src="Loading Screen/Julia.png" alt="Julia Portrait" class="reward-popup-image">
                <p class="reward-popup-text">You've received Julia's Theme:<br>"Forest Wanderer"</p>
                <button class="claim-button">Claim</button>
            </div>
        `;

        document.body.appendChild(popup);

        // Close button handler
        popup.querySelector('.reward-popup-close').addEventListener('click', () => {
            popup.remove();
        });

        // Claim button handler
        popup.querySelector('.claim-button').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            try {
                const userSongsRef = ref(database, `users/${user.uid}/Songs`);
                const updates = {};
                updates['Forest Wanderer (Julia Theme)'] = 1;
                await update(userSongsRef, updates);
                
                // Close popup after claiming
                popup.remove();
                
                // Refresh music player to include new song
                window.location.reload();
            } catch (error) {
                console.error('Error claiming Julia song:', error);
            }
        });
    }

    // Add this to your auth state change listener
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // ... existing auth code ...
            checkAndShowJuliaReward();
        }
    });

    function toggleAtlantisSongDemo() {
        const audio = document.getElementById('atlantis-demo');
        const button = document.querySelector('.demo-button i');
        
        if (window.atlantisDemoPlaying) {
            audio.pause();
            button.className = 'fas fa-play';
            window.atlantisDemoPlaying = false;
            if (window.atlantisDemoTimeout) {
                clearTimeout(window.atlantisDemoTimeout);
                window.atlantisDemoTimeout = null;
            }
        } else {
            // Load the audio if not loaded
            if (!audio.src) {
                audio.src = 'Songs/Welcome To Atlantis.mp3';
            }

            // Wait for metadata to load before playing
            const playAudio = () => {
                if (audio.duration) {
                    audio.currentTime = audio.duration * 0.4;
                    audio.play()
                        .then(() => {
                            button.className = 'fas fa-pause';
                            window.atlantisDemoPlaying = true;

                            // Stop preview after 15 seconds
                            window.atlantisDemoTimeout = setTimeout(() => {
                                if (audio.duration) {
                                    audio.pause();
                                    audio.currentTime = audio.duration * 0.4;
                                }
                                button.className = 'fas fa-play';
                                window.atlantisDemoPlaying = false;
                            }, 15000);
                        })
                        .catch(error => {
                            console.error('Error playing audio:', error);
                            button.className = 'fas fa-play';
                            window.atlantisDemoPlaying = false;
                        });
                }
            };

            if (audio.readyState >= 2) { // HAVE_CURRENT_DATA or higher
                playAudio();
            } else {
                audio.addEventListener('loadedmetadata', playAudio, { once: true });
            }

            // When the preview ends naturally
            audio.onended = () => {
                button.className = 'fas fa-play';
                window.atlantisDemoPlaying = false;
                if (window.atlantisDemoTimeout) {
                    clearTimeout(window.atlantisDemoTimeout);
                    window.atlantisDemoTimeout = null;
                }
            };
        }
    }

    // Make the function globally available
    window.toggleAtlantisSongDemo = toggleAtlantisSongDemo;
</script>


    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Music Player Script -->
    <script type="module">
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, update, get } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js';
        import { initMusicPlayer } from './music-player.js';
        
        document.addEventListener('DOMContentLoaded', () => {
            initMusicPlayer();
            
            // Initialize Julia reward check
            const auth = getAuth();
            const database = getDatabase();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    try {
                        const userSongsRef = ref(database, `users/${user.uid}/Songs`);
                        const snapshot = await get(userSongsRef);
                        const ownedSongs = snapshot.val() || {};

                        if (!ownedSongs['Forest Wanderer (Julia Theme)']) {
                            showJuliaReward(auth, database);
                        }
                    } catch (error) {
                        console.error('Error checking Julia reward:', error);
                    }
                }
            });
        });

        function showJuliaReward(auth, database) {
            const popup = document.createElement('div');
            popup.className = 'reward-popup';
            popup.innerHTML = `
                <div class="reward-popup-header">
                    <h3 class="reward-popup-title">New Song Unlocked!</h3>
                    <button class="reward-popup-close">×</button>
                </div>
                <div class="reward-popup-content">
                    <img src="Loading Screen/Julia.png" alt="Julia Portrait" class="reward-popup-image">
                    <p class="reward-popup-text">You've received Julia's Theme:<br>"Forest Wanderer"</p>
                    <button class="claim-button">Claim</button>
                </div>
            `;

            document.body.appendChild(popup);

            // Close button handler
            popup.querySelector('.reward-popup-close').addEventListener('click', () => {
                popup.remove();
            });

            // Claim button handler
            popup.querySelector('.claim-button').addEventListener('click', async () => {
                const user = auth.currentUser;
                if (!user) return;

                try {
                    const userSongsRef = ref(database, `users/${user.uid}/Songs`);
                    const updates = {};
                    updates['Forest Wanderer (Julia Theme)'] = 1;
                    await update(userSongsRef, updates);
                    
                    // Close popup after claiming
                    popup.remove();
                    
                    // Refresh music player to include new song
                    window.location.reload();
                } catch (error) {
                    console.error('Error claiming Julia song:', error);
                }
            });
        }
    </script>
    <style>
        /* Add new currency box styles */
        .currency-box {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 30, 46, 0.95);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #00ced1;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            backdrop-filter: blur(5px);
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            transition: transform 0.3s ease;
        }

        .currency-item:hover {
            transform: translateX(5px);
        }

        .currency-item img {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.3));
        }

        .currency-item span {
            color: #e0ffff;
            font-size: 1.1em;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Menu styles */
        .menu {
            background-color: rgba(0, 30, 46, 0.9);
            border-bottom: 1px solid #00ced1;
        }

        .menu a {
            color: #e0ffff;
            transition: all 0.3s ease;
        }

        .menu a:hover {
            background-color: rgba(0, 206, 209, 0.2);
            color: #ffd700;
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Play button styles */
        .play-button {
            background: linear-gradient(45deg, #00ced1, #20b2aa);
            color: #ffffff;
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.4);
        }

        .play-button:hover {
            background: linear-gradient(45deg, #ffd700, #daa520);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Quest Window Styles */
        #quest-window .modal-content {
            background: rgba(0, 30, 46, 0.95);
            color: #e0ffff;
            max-width: 1000px;
            width: 95%;
            padding: 30px;
            border: 1px solid #00ced1;
            box-shadow: 0 0 30px rgba(0, 206, 209, 0.2);
        }

        .quest-item {
            background: rgba(0, 206, 209, 0.15);
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            background: rgba(0, 206, 209, 0.1);
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            background: linear-gradient(90deg, #00ced1, #ffd700);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .claim-button {
            background: #00ced1;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .claim-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        /* Awards Window Styles */
        #awards-window {
            background: rgba(0, 30, 46, 0.9);
        }

        #awards-window .modal-content {
            background: rgba(0, 30, 46, 0.95);
            color: #e0ffff;
            border: 1px solid #00ced1;
            box-shadow: 0 0 30px rgba(0, 206, 209, 0.2);
        }

        .award-item {
            background: rgba(0, 206, 209, 0.15);
            border: 1px solid rgba(0, 206, 209, 0.3);
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.2);
        }

        .award-info h3 {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .skin-name {
            color: #e0ffff;
        }

        .sale-price {
            color: #ffd700;
            font-weight: bold;
        }

        .purchase-button {
            background: #00ced1;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .purchase-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .purchase-button.disabled {
            background: #1a4657;
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Profile styles */
        .profile-container {
            background: rgba(0, 30, 46, 0.9);
            border: 1px solid #00ced1;
        }

        .profile-menu {
            background: rgba(0, 30, 46, 0.95);
            border: 1px solid #00ced1;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
        }

        .profile-menu li:hover {
            background: rgba(0, 206, 209, 0.2);
            color: #ffd700;
        }

        /* Bottom buttons styles */
        .bottom-button {
            background: rgba(0, 30, 46, 0.9);
            border: 1px solid #00ced1;
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.2);
        }

        .bottom-button:hover {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .button-title {
            color: #e0ffff;
            text-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        }

        /* Music player styles */
        .music-player {
            background: rgba(0, 30, 46, 0.95);
            border: 1px solid #00ced1;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
        }

        .music-player-toggle {
            background: #00ced1;
            color: #ffffff;
        }

        .music-player-toggle:hover {
            background: #ffd700;
        }

        .controls button {
            color: #e0ffff;
            background: rgba(0, 206, 209, 0.2);
        }

        .controls button:hover {
            background: rgba(255, 215, 0, 0.3);
            color: #ffffff;
        }

        .playlist {
            background: rgba(0, 30, 46, 0.95);
            border-top: 1px solid #00ced1;
        }

        .playlist-items li:hover {
            background: rgba(0, 206, 209, 0.2);
            color: #ffd700;
        }

        .volume-slider {
            background: rgba(0, 206, 209, 0.2);
        }

        .volume-slider::-webkit-slider-thumb {
            background: #ffd700;
        }

        .volume-slider::-moz-range-thumb {
            background: #ffd700;
        }

        /* ... existing styles ... */

        /* Currency Display Styles */
        .currency-display {
            display: flex;
            justify-content: space-between;
            gap: 20px;
            padding: 10px 20px;
            margin: 52px 20px;
            background: rgba(0, 30, 46, 0.95);
            border: 1px solid #00ced1;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
            backdrop-filter: blur(5px);
            width: calc(100% - 40px); /* Full width minus margins */
            max-width: 300px; /* Same width as profile container */
            margin-left: auto;
        }

        .currency-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px;
            transition: transform 0.3s ease;
        }

        .currency-item:hover {
            transform: translateY(-2px);
        }

        .currency-item img {
            width: 24px;
            height: 24px;
            filter: drop-shadow(0 0 2px rgba(255, 215, 0, 0.3));
        }

        .currency-item span {
            color: #e0ffff;
            font-size: 1.1em;
            font-weight: 500;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        /* Menu styles */
        .menu {
            background-color: rgba(0, 30, 46, 0.9);
            border-bottom: 1px solid #00ced1;
        }

        .menu a {
            color: #e0ffff;
            transition: all 0.3s ease;
        }

        .menu a:hover {
            background-color: rgba(0, 206, 209, 0.2);
            color: #ffd700;
            transform: scale(1.1);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        /* Play button styles */
        .play-button {
            background: linear-gradient(45deg, #00ced1, #20b2aa);
            color: #ffffff;
            border: 2px solid #ffd700;
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.4);
        }

        .play-button:hover {
            background: linear-gradient(45deg, #ffd700, #daa520);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
        }

        /* Quest Window Styles */
        #quest-window .modal-content {
            background: rgba(0, 30, 46, 0.95);
            color: #e0ffff;
            max-width: 1000px;
            width: 95%;
            padding: 30px;
            border: 1px solid #00ced1;
            box-shadow: 0 0 30px rgba(0, 206, 209, 0.2);
        }

        .quest-item {
            background: rgba(0, 206, 209, 0.15);
            border: 1px solid rgba(0, 206, 209, 0.3);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            background: rgba(0, 206, 209, 0.1);
            height: 10px;
            border-radius: 5px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress {
            background: linear-gradient(90deg, #00ced1, #ffd700);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
        }

        .claim-button {
            background: #00ced1;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 6px 12px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .claim-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        /* Awards Window Styles */
        #awards-window {
            background: rgba(0, 30, 46, 0.9);
        }

        #awards-window .modal-content {
            background: rgba(0, 30, 46, 0.95);
            color: #e0ffff;
            border: 1px solid #00ced1;
            box-shadow: 0 0 30px rgba(0, 206, 209, 0.2);
        }

        .award-item {
            background: rgba(0, 206, 209, 0.15);
            border: 1px solid rgba(0, 206, 209, 0.3);
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.2);
        }

        .award-info h3 {
            color: #ffd700;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
        }

        .skin-name {
            color: #e0ffff;
        }

        .sale-price {
            color: #ffd700;
            font-weight: bold;
        }

        .purchase-button {
            background: #00ced1;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .purchase-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
        }

        .purchase-button.disabled {
            background: #1a4657;
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Profile styles */
        .profile-container {
            background: rgba(0, 30, 46, 0.9);
            border: 1px solid #00ced1;
        }

        .profile-menu {
            background: rgba(0, 30, 46, 0.95);
            border: 1px solid #00ced1;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
        }

        .profile-menu li:hover {
            background: rgba(0, 206, 209, 0.2);
            color: #ffd700;
        }

        /* Bottom buttons styles */
        .bottom-button {
            background: rgba(0, 30, 46, 0.9);
            border: 1px solid #00ced1;
            box-shadow: 0 0 15px rgba(0, 206, 209, 0.2);
        }

        .bottom-button:hover {
            border-color: #ffd700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        .button-title {
            color: #e0ffff;
            text-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        }

        /* Music player styles */
        .music-player {
            background: rgba(0, 30, 46, 0.95);
            border: 1px solid #00ced1;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
        }

        .music-player-toggle {
            background: #00ced1;
            color: #ffffff;
        }

        .music-player-toggle:hover {
            background: #ffd700;
        }

        .controls button {
            color: #e0ffff;
            background: rgba(0, 206, 209, 0.2);
        }

        .controls button:hover {
            background: rgba(255, 215, 0, 0.3);
            color: #ffffff;
        }

        .playlist {
            background: rgba(0, 30, 46, 0.95);
            border-top: 1px solid #00ced1;
        }

        .playlist-items li:hover {
            background: rgba(0, 206, 209, 0.2);
            color: #ffd700;
        }

        .volume-slider {
            background: rgba(0, 206, 209, 0.2);
        }

        .volume-slider::-webkit-slider-thumb {
            background: #ffd700;
        }

        .volume-slider::-moz-range-thumb {
            background: #ffd700;
        }
    </style>
</head>
<body>
    <!-- Add currency box after body tag -->
    <div class="play-button-container">
        <a href="Game Modes.html" class="play-button">
            <div class="play-button-inner">
                <div class="play-icon">
                    <i class="fas fa-play"></i>
                </div>
                <span class="play-text">PLAY</span>
            </div>
            <div class="play-button-glow"></div>
        </a>
    </div>
    <!-- Replace the smoke-container div with this snow container -->
    <div class="snowfall-container"></div>

    <!-- Video Background -->
    <video id="video-background" autoplay muted loop>
        <source src="Event/Eventvideo.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
    <!-- Menu without play button -->
    <div class="menu">
        <div class="menu-items">
            <a href="home.html" class="menu-link active">
                <i class="fas fa-home"></i>
                <span>Home</span>
            </a>
            <a href="Store.html" class="menu-link">
                <i class="fas fa-store"></i>
                <span>Store</span>
            </a>
            <a href="event.html" class="menu-link">
                <i class="fas fa-calendar"></i>
                <span>Event</span>
            </a>
            <a href="Team Builder.html" class="menu-link">
                <i class="fas fa-users"></i>
                <span>Team Builder</span>
            </a>
            <a href="statistics.html" class="menu-link">
                <i class="fas fa-chart-bar"></i>
                <span>Statistics</span>
            </a>
        </div>
    </div>

    <!-- Profile Container -->
    <div id="profile-info" class="profile-container">
        <div class="username-title-container" onclick="toggleProfileMenu(event)">
            <h2 id="username-display"></h2>
            <div id="title-display"></div>
        </div>
        <img id="profile-image" src="" alt="Profile Icon" class="profile-icon" onclick="toggleProfileMenu(event)">
    </div>

    <!-- Currency Display -->
    <div class="currency-display">
        <div class="currency-item">
            <img src="res/img/fm.png" alt="FM">
            <span id="currency-amount">0</span>
        </div>
        <div class="currency-item">
            <img src="res/img/cm.png" alt="CM">
            <span id="cm-amount">0</span>
        </div>
        <div class="currency-item">
            <img src="res/img/qp.png" alt="QP">
            <span id="qp-amount">0</span>
        </div>
    </div>

    <!-- Profile Menu Pop-up -->
    <div id="profile-menu" class="profile-menu">
        <ul>
            <li onclick="window.location.href='character-progression.html'">Character Progression</li>
            <li onclick="window.location.href='Profile.html'">Profile</li>
            <li onclick="openChangeIconModal()">Change Icon</li>
            <li onclick="window.location.href='Collection.html'">Collection</li>
            <li onclick="logOut()">Log Out</li>
        </ul>
    </div>

    <!-- Modal for Changing Profile Icon -->
    <div id="change-icon-modal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeChangeIconModal()">&times;</span>
            <h2>Select Your Profile Icon</h2>
            <div id="icon-list">
                <!-- Icons will be dynamically loaded here -->
            </div>
        </div>
    </div>
    <!-- Champion Selector -->
    <div id="champion-selector-container">

        <div id="champion-selector">
            <a href="ch/Julia.html" class="champion-link">
                <img src="Icons/Julia.png" alt="Julia" class="champion-image">
                <span class="champion-name">Julia</span>
            </a>
            <a href="ch/Birdie.html" class="champion-link">
                <img src="Icons/Birdie.png" alt="Birdie" class="champion-image">
                <span class="champion-name">Birdie</span>
            </a>
            <a href="ch/Erron Black.html" class="champion-link">
                <img src="Icons/Erron Black.png" alt="Erron Black" class="champion-image">
                <span class="champion-name">Erron Black</span>
            </a>
            <a href="ch/Cham Cham.html" class="champion-link">
                <img src="Icons/Cham Cham.png" alt="Cham Cham" class="champion-image">
                <span class="champion-name">Cham Cham</span>
            </a>
            <a href="ch/Morrigan.html" class="champion-link">
                <img src="Icons/Morrigan.png" alt="Morrigan" class="champion-image">
                <span class="champion-name">Morrigan</span>
            </a>
            <a href="ch/Jun.html" class="champion-link">
                <img src="Icons/Jun.png" alt="Jun" class="champion-image">
                <span class="champion-name">Jun</span>
            </a>
            <a href="ch/Reptile.html" class="champion-link">
                <img src="Icons/Reptile.png" alt="Reptile" class="champion-image">
                <span class="champion-name">Reptile</span>
            </a>
            <a href="ch/Akuma.html" class="champion-link">
                <img src="Icons/Akuma.png" alt="Akuma" class="champion-image">
                <span class="champion-name">Akuma</span>
            </a>
            <a href="ch/Elphelt.html" class="champion-link">
                <img src="Icons/Elphelt.png" alt="Elphelt" class="champion-image">
                <span class="champion-name">Elphelt</span>
            </a>
            <a href="ch/Kotal Kahn.html" class="champion-link">
                <img src="Icons/Kotal Kahn.png" alt="Kotal Kahn" class="champion-image">
                <span class="champion-name">Kotal Kahn</span>
            </a>
            <a href="ch/Scorpion.html" class="champion-link">
                <img src="Icons/Scorpion.png" alt="Scorpion" class="champion-image">
                <span class="champion-name">Scorpion</span>
            </a>
            <a href="ch/Peacock.html" class="champion-link">
                <img src="Icons/Peacock.png" alt="Peacock" class="champion-image">
                <span class="champion-name">Peacock</span>
            </a>
            <a href="ch/Angel.html" class="champion-link">
                <img src="Icons/Angel.png" alt="Angel" class="champion-image">
                <span class="champion-name">Angel</span>
            </a>
            <a href="ch/Astaroth.html" class="champion-link">
                <img src="Icons/Astaroth.png" alt="Astaroth" class="champion-image">
                <span class="champion-name">Astaroth</span>
            </a>
            <a href="ch/Ibuki.html" class="champion-link">
                <img src="Icons/Ibuki.png" alt="Ibuki" class="champion-image">
                <span class="champion-name">Ibuki</span>
            </a>
            <a href="ch/R Mika.html" class="champion-link">
                <img src="Icons/R.Mika.png" alt="R.Mika" class="champion-image">
                <span class="champion-name">R.Mika</span>
            </a>
            <a href="ch/Raiden.html" class="champion-link">
                <img src="Icons/Raiden.png" alt="Raiden" class="champion-image">
                <span class="champion-name">Raiden</span>
            </a>
            <a href="ch/Yugo.html" class="champion-link">
                <img src="Icons/Yugo.png" alt="Yugo" class="champion-image">
                <span class="champion-name">Yugo</span>
            </a>
            <a href="ch/Talim.html" class="champion-link">
                <img src="Icons/Talim.png" alt="Talim" class="champion-image">
                <span class="champion-name">Talim</span>
            </a>
            <a href="ch/Noel.html" class="champion-link">
                <img src="Icons/Noel.png" alt="Noel" class="champion-image">
                <span class="champion-name">Noel</span>
            </a>
            <a href="ch/Blanka.html" class="champion-link">
                <img src="Icons/Blanka.png" alt="Blanka" class="champion-image">
                <span class="champion-name">Blanka</span>
            </a>
            <a href="ch/Nina.html" class="champion-link">
                <img src="Icons/Nina.png" alt="Nina" class="champion-image">
                <span class="champion-name">Nina</span>
            </a>
            <a href="ch/Ayane.html" class="champion-link">
                <img src="Icons/Ayane.png" alt="Ayane" class="champion-image">
                <span class="champion-name">Ayane</span>
            </a>
            <a href="ch/Siegfried.html" class="champion-link">
                <img src="Icons/Siegfried.png" alt="Siegfried" class="champion-image">
                <span class="champion-name">Siegfried</span>
            </a>
            <a href="ch/Shoma.html" class="champion-link">
                <img src="Icons/Shoma.png" alt="Shoma" class="champion-image">
                <span class="champion-name">Shoma</span>
            </a>
            <a href="ch/Juri.html" class="champion-link">
                <img src="Icons/Juri.png" alt="Juri" class="champion-image">
                <span class="champion-name">Juri</span>
            </a>
            <a href="ch/Sub Zero.html" class="champion-link">
                <img src="Icons/Sub Zero.png" alt="Sub Zero" class="champion-image">
                <span class="champion-name">Sub Zero</span>
            </a>
            <a href="ch/Christie.html" class="champion-link">
                <img src="Icons/Christie.png" alt="Christie" class="champion-image">
                <span class="champion-name">Christie</span>
            </a>
            <a href="ch/Kokoro.html" class="champion-link">
                <img src="Icons/Kokoro.png" alt="Kokoro" class="champion-image">
                <span class="champion-name">Kokoro</span>
            </a>
            <a href="ch/Eagle.html" class="champion-link">
                <img src="Icons/Eagle.png" alt="Eagle" class="champion-image">
                <span class="champion-name">Eagle</span>
            </a>
            <a href="ch/Sophitia.html" class="champion-link">
                <img src="Icons/Sophitia.png" alt="Sophitia" class="champion-image">
                <span class="champion-name">Sophitia</span>
            </a>
            <a href="ch/Shizumaru.html" class="champion-link">
                <img src="Icons/Shizumaru.png" alt="Shizumaru" class="champion-image">
                <span class="champion-name">Shizumaru</span>
            </a>
            <a href="ch/Kagome.html" class="champion-link">
                <img src="Icons/Kagome.png" alt="Kagome" class="champion-image">
                <span class="champion-name">Kagome</span>
            </a>
            <a href="ch/Kabal.html" class="champion-link">
                <img src="Icons/Kabal.png" alt="Kabal" class="champion-image">
                <span class="champion-name">Kabal</span>
            </a>
            <a href="ch/Kuma.html" class="champion-link">
                <img src="Icons/Kuma.png" alt="Kuma" class="champion-image">
                <span class="champion-name">Kuma</span>
            </a>
            <a href="ch/Alice.html" class="champion-link">
                <img src="Icons/Alice.png" alt="Alice" class="champion-image">
                <span class="champion-name">Alice</span>
            </a>
            <a href="ch/Shinnok.html" class="champion-link">
                <img src="Icons/Shinnok.png" alt="Shinnok" class="champion-image">
                <span class="champion-name">Shinnok</span>
            </a>
            <a href="ch/FANG.html" class="champion-link">
                <img src="Icons/FANG.png" alt="FANG" class="champion-image">
                <span class="champion-name">FANG</span>
            </a>
            <a href="ch/Lili.html" class="champion-link">
                <img src="Icons/Lili.png" alt="Lili" class="champion-image">
                <span class="champion-name">Lili</span>
            </a>
            <a href="ch/Mega Man.html" class="champion-link">
                <img src="Icons/Mega Man.png" alt="Mega Man" class="champion-image">
                <span class="champion-name">Mega Man</span>
            </a>
            <a href="ch/Mai.html" class="champion-link">
                <img src="Icons/Mai.png" alt="Mai" class="champion-image">
                <span class="champion-name">Mai</span>
            </a>
            <a href="ch/Zasalamel.html" class="champion-link">
                <img src="Icons/Zasalamel.png" alt="Zasalamel" class="champion-image">
                <span class="champion-name">Zasalamel</span>
            </a>
        </div>
    </div>
       <!-- Add these two lines -->
       <script src="recolor-data.js" type="module"></script>
       <script src="advent-calendar.js" type="module"></script>
    <script>
        // Wrap all DOM-dependent code in DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Firebase auth state
            initializeAuthState();

            // Create particles
            createParticles();

            // Initialize click handlers for profile image and container
            const profileInfo = document.getElementById('profile-info');
            const profileImage = document.getElementById('profile-image');
            const profileMenu = document.getElementById('profile-menu');
            const usernameDisplay = document.getElementById('username-display');

            // Global toggle function for the profile menu
            window.toggleProfileMenu = function(event) {
                if (event) {
                    event.stopPropagation();
                }
                if (profileMenu) {
                    profileMenu.classList.toggle('show');
                }
            }

            // Add click handlers
            if (profileInfo) {
                profileInfo.addEventListener('click', toggleProfileMenu);
            }
            if (profileImage) {
                profileImage.addEventListener('click', toggleProfileMenu);
            }
            if (usernameDisplay) {
                usernameDisplay.addEventListener('click', toggleProfileMenu);
            }

            // Close menu when clicking outside
            document.addEventListener('click', function(event) {
                if (profileMenu && profileMenu.classList.contains('show') && 
                    !profileInfo.contains(event.target) &&
                    !profileMenu.contains(event.target)) {
                    profileMenu.classList.remove('show');
                }
            });

            // Friend list functionality
            const toggleFriendListButton = document.getElementById("toggle-friend-list");
            const friendList = document.getElementById("friend-list");
            const addFriendButton = document.getElementById("add-friend-button");
            const friendNameInput = document.getElementById("friend-name-input");
            const friendListUL = document.getElementById("friend-list-ul");

            if (toggleFriendListButton && friendList) {
                toggleFriendListButton.addEventListener("click", function() {
                    friendList.style.display = friendList.style.display === "none" ? "block" : "none";
                });
            }

            if (addFriendButton && friendNameInput) {
                addFriendButton.addEventListener("click", async function() {
                    const friendName = friendNameInput.value;
                    if (friendName) {
                        try {
                            const userId = auth.currentUser.uid;
                            const usersRef = ref(database, 'users');
                            const snapshot = await get(usersRef);
                            let friendId = null;

                            snapshot.forEach(childSnapshot => {
                                const userData = childSnapshot.val();
                                if (userData.username === friendName) {
                                    friendId = childSnapshot.key;
                                }
                            });

                            if (friendId) {
                                const friendRef = ref(database, 'users/' + userId + '/friends');
                                const newFriendRef = push(friendRef);
                                await set(newFriendRef, {
                                    id: friendId,
                                    name: friendName
                                });
                                friendNameInput.value = '';
                                loadFriendList(userId);
                            } else {
                                alert('Username not found');
                            }
                        } catch (error) {
                            console.error('Error adding friend:', error);
                        }
                    }
                });
            }
        });

        // Functions that don't require immediate DOM access can stay outside
        function profile() {
            window.location.href = 'Profile.html';
        }

        function viewCollection() {
            window.location.href = 'Collection.html';
        }

        function toggleChampionSelector() {
            const championSelector = document.getElementById('champion-selector-container');
            const toggleButton = document.getElementById('toggle-champion-button');
            
            if (championSelector && toggleButton) {
                if (championSelector.style.display === 'none' || championSelector.style.display === '') {
                    championSelector.style.display = 'flex';
                    toggleButton.classList.add('rotated');
                } else {
                    championSelector.style.display = 'none';
                    toggleButton.classList.remove('rotated');
                }
            }
        }

        // Initialize Toggle Button State on Page Load
        document.addEventListener('DOMContentLoaded', function () {
            const championSelector = document.getElementById('champion-selector-container');
            const toggleButton = document.getElementById('toggle-champion-button');

            // Initially show the champion selector
            championSelector.style.display = 'flex';
        });

        // ===================== Particle Effect Initialization =====================
    </script>
    <!-- Advent Calendar Window -->
    <div id="advent-calendar-window" class="modal-window" style="display: none;">
        <div class="advent-calendar-content">
            <span class="close-button" data-action="closeCalendar">&times;</span>
            <h2>December 2024</h2>
            <div class="calendar-grid">
                <!-- Days will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Daily Reward Popup -->
    <div id="daily-reward-popup" style="display: none;">
        <div class="reward-content">
            <span class="close-button" data-action="closeReward">&times;</span>
            <h3>Daily Reward</h3>
            <img id="reward-image" src="" alt="Reward">
            <p id="reward-name"></p>
        </div>
    </div>

    <script type="module">
        import { closeAdventCalendar, closeRewardPopup } from './advent-calendar.js';
        
        // Add click handlers for close buttons
        document.addEventListener('click', (e) => {
            if (e.target.closest('.close-button[data-action="closeCalendar"]')) {
                closeAdventCalendar();
            } else if (e.target.closest('.close-button[data-action="closeReward"]')) {
                closeRewardPopup();
            }
        });
    </script>

    <!-- Add this after the Firebase initialization -->
    <script>
        // Add this after the Firebase initialization
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize profile menu click handler
            document.addEventListener('click', function(event) {
                const profileMenu = document.getElementById('profile-menu');
                const profileInfo = document.getElementById('profile-info');
                
                if (profileMenu && profileInfo) {
                    // Close menu if clicking outside
                    if (!profileInfo.contains(event.target) && !profileMenu.contains(event.target)) {
                        profileMenu.classList.remove('show');
                    }
                }
            });

            // Initialize profile container click handler
            const profileContainer = document.getElementById('profile-info');
            if (profileContainer) {
                profileContainer.addEventListener('click', function(event) {
                    event.stopPropagation();
                    const profileMenu = document.getElementById('profile-menu');
                    if (profileMenu) {
                        profileMenu.classList.toggle('show');
                    }
                });
            }

            // Initialize auth state
            initializeAuthState();
        });
    </script>

    <!-- Bottom Buttons Container -->
    <div class="bottom-buttons-container">
        <!-- Battlepass Button -->
        <div class="bottom-button" onclick="window.location.href='battlepass.html'">
            <img src="Event/Atlantis Event.jpeg" alt="Battlepass">
            <div class="button-content">
                <h3 class="button-title">Battlepass</h3>
            </div>
        </div>

        <!-- Quest Button -->
        <div class="bottom-button" onclick="openQuestWindow()">
            <img src="res/img/questbackground.webp" alt="Quests">
            <div class="button-content">
                <h3 class="button-title">Quests</h3>
            </div>
        </div>

        <!-- Changelog Button -->
        <div class="bottom-button" onclick="window.location.href='changelog.html'">
            <img src="Default Splash/Talim.jpeg" alt="Changelog">
            <div class="button-content">
                <h3 class="button-title">Changelog</h3>
            </div>
        </div>
    </div>

                <!-- Quest Window -->
                <div id="quest-window" class="modal" style="display: none;">
                    <div class="modal-content">
                        <span class="close" onclick="closeQuestWindow()">&times;</span>
                        <h2>Quests</h2>
                        <div class="quest-points">
                            <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                            <span id="quest-points-amount">0</span>
                        </div>
                        <div class="quest-list">
                            <div class="quest-item">
                                <div class="quest-info">
                                    <h3>Win 2 Games</h3>
                                    <div class="progress-bar">
                                        <div class="progress" id="win-games-progress"></div>
                                    </div>
                                    <span class="progress-text">0/2</span>
                                </div>
                                <div class="quest-reward">
                                    <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                                    <span>75</span>
                                </div>
                                <button class="claim-button" onclick="claimQuestReward('win-games', 75)">Claim</button>
                            </div>
                            <div class="quest-item">
                                <div class="quest-info">
                                    <h3>Lose 2 Games</h3>
                                    <div class="progress-bar">
                                        <div class="progress" id="lose-games-progress"></div>
                                    </div>
                                    <span class="progress-text">0/2</span>
                                </div>
                                <div class="quest-reward">
                                    <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                                    <span>25</span>
                                </div>
                                <button class="claim-button" onclick="claimQuestReward('lose-games', 25)">Claim</button>
                            </div>
                            <div class="quest-item">
                                <div class="quest-info">
                                    <h3>Win against Shinnok or Zasalamel</h3>
                                    <div class="progress-bar">
                                        <div class="progress" id="win-against-progress"></div>
                        </div>
                                    <span class="progress-text">0/1</span>
                                </div>
                                <div class="quest-reward">
                                    <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                                    <span>200</span>
                                </div>
                                <button class="claim-button" onclick="claimQuestReward('win-against', 200)">Claim</button>
                            </div>
                            <div class="quest-item">
                                <div class="quest-info">
                                    <h3>Win as Atlantean Champion</h3>
                                    <div class="progress-bar">
                                        <div class="progress" id="win-as-atlantean-progress"></div>
                                    </div>
                                    <span class="progress-text">0/1</span>
                                </div>
                                <div class="quest-reward">
                                    <img src="res/img/qp.png" alt="Quest Points" class="currency-icon">
                                    <span>100</span>
                                </div>
                                <button class="claim-button" onclick="claimQuestReward('win-as-atlantean', 100)">Claim</button>
                            </div>
                        </div>
                        <!-- Atlantis Rewards Section -->
                        <div class="recolors-section">
                            <h3>Atlantis Rewards</h3>
                            <div class="recolors-grid">
                                <div class="recolor-item">
                                    <img src="Loading Screen/Atlantean Kagome.png" alt="Atlantean Kagome">
                                    <h4>Atlantean Kagome</h4>
                                    <button class="claim-button" onclick="unlockAtlantisReward('atlantean-kagome', 2000, 'skin')">
                                        Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 2000
                                    </button>
                                </div>
                                <div class="recolor-item">
                                    <img src="Event/Atlantis Event.jpeg" alt="Welcome To Atlantis">
                                    <h4>Welcome To Atlantis (Song)</h4>
                                    <button class="claim-button" onclick="unlockAtlantisReward('welcome-to-atlantis', 450, 'song')">
                                        Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 450
                                    </button>
                                    <div class="demo-player">
                                        <audio id="atlantis-demo" src="Songs/Welcome To Atlantis (Event Theme).mp3"></audio>
                                        <button class="demo-button" onclick="toggleAtlantisSongDemo()">
                                            <i class="fas fa-play"></i> Preview
                                        </button>
                                    </div>
                                </div>
                                <div class="recolor-item">
                                    <img src="res/img/basicbox.png" alt="Free Lootbox">
                                    <h4>Free Lootbox</h4>
                                    <button class="claim-button" onclick="unlockAtlantisReward('free-lootbox', 1500, 'lootbox')">
                                        Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 1500
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Lili's Winter Festival Recolors Section -->
                        <div class="recolors-section">
                            <h3>Lili's Winter Festival Recolors</h3>
                            <div class="recolors-grid">
                                <div class="recolor-item">
                                    <img src="Loading Screen/Winter Festival Lili Holiday.png" alt="Winter Festival Lili Holiday">
                                    <h4>Winter Festival Lili Holiday</h4>
                                    <button class="claim-button" onclick="unlockRecolor('holiday', 1000)">
                                        Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 1000
                                    </button>
                                </div>
                                <div class="recolor-item">
                                    <img src="Loading Screen/Winter Festival Lili Snowy Blush.png" alt="Winter Festival Lili Snowy Blush">
                                    <h4>Winter Festival Lili Snowy Blush</h4>
                                    <button class="claim-button" onclick="unlockRecolor('snowy-blush', 1000)">
                                        Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 1000
                                    </button>
                                </div>
                                <div class="recolor-item">
                                    <img src="Loading Screen/Winter Festival Lili Golden.png" alt="Winter Festival Lili Golden">
                                    <h4>Winter Festival Lili Golden</h4>
                                    <button class="claim-button" onclick="unlockRecolor('golden', 1000)">
                                        Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 1000
                                    </button>
                                </div>
                                <div class="recolor-item">
                                    <img src="Loading Screen/Winter Festival Lili Snowflake.png" alt="Winter Festival Lili Snowflake">
                                    <h4>Winter Festival Lili Snowflake</h4>
                                    <button class="claim-button" onclick="unlockRecolor('snowflake', 1000)">
                                        Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 1000
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

    <script>
                    // ... existing script ...

                    // Quest Window Functions
                    async function openQuestWindow() {
    try {
        const auth = window.firebaseAuth;
        const database = window.firebaseDatabase;
        const questWindow = document.getElementById('quest-window');
        if (questWindow) {
            questWindow.style.display = 'block';
            await updateQuestPoints();
            await updateQuestProgress();

            // Check owned skins and update recolor buttons
            const user = auth.currentUser;
            if (user) {
                const userId = user.uid;
                const userRef = ref(database, `users/${userId}`);
                const snapshot = await get(userRef);
                const userData = snapshot.val() || {};
                const ownedSkins = userData.skins || {};
                const ownedSongs = userData.Songs || {};

                // Update Lili recolor buttons
                const recolorMap = {
                    'holiday': 'Winter Festival Lili Holiday',
                    'snowy-blush': 'Winter Festival Lili Snowy Blush',
                    'golden': 'Winter Festival Lili Golden',
                    'snowflake': 'Winter Festival Lili Snowflake'
                };

                // Update all recolor buttons
                for (const [recolorId, skinName] of Object.entries(recolorMap)) {
                    const claimButton = document.querySelector(`button[onclick="unlockRecolor('${recolorId}', 1000)"]`);
                    if (claimButton) {
                        if (ownedSkins[skinName]) {
                            claimButton.disabled = true;
                            claimButton.textContent = 'Claimed';
                            claimButton.style.backgroundColor = '#666';
                        } else {
                            claimButton.disabled = false;
                            claimButton.innerHTML = `Claim for <img src="res/img/qp.png" alt="Quest Points" class="currency-icon"> 1000`;
                            claimButton.style.backgroundColor = '#4682B4';
                        }
                    }
                }

                // Update Atlantis reward buttons
                // Check Atlantean Kagome skin
                const kagomeButton = document.querySelector(`button[onclick="unlockAtlantisReward('atlantean-kagome', 2000, 'skin')"]`);
                if (kagomeButton && ownedSkins['Atlantean Kagome']) {
                    kagomeButton.disabled = true;
                    kagomeButton.textContent = 'Claimed';
                    kagomeButton.style.backgroundColor = '#666';
                }

                // Check Welcome To Atlantis song
                const songButton = document.querySelector(`button[onclick="unlockAtlantisReward('welcome-to-atlantis', 450, 'song')"]`);
                if (songButton && ownedSongs['Welcome To Atlantis']) {
                    songButton.disabled = true;
                    songButton.textContent = 'Claimed';
                    songButton.style.backgroundColor = '#666';
                }

                // Check Free Lootbox
                const lootboxButton = document.querySelector(`button[onclick="unlockAtlantisReward('free-lootbox', 1000, 'lootbox')"]`);
                if (lootboxButton && userData.claimedQuestLootbox) {
                    lootboxButton.disabled = true;
                    lootboxButton.textContent = 'Claimed';
                    lootboxButton.style.backgroundColor = '#666';
                }
            }
        }
    } catch (error) {
        console.error('Error opening quest window:', error);
    }
}
            
                    async function claimQuestReward(questId, reward) {
                        const auth = window.firebaseAuth;
                        const database = window.firebaseDatabase;
                        const user = auth.currentUser;
                        if (!user) return;

                        const userId = user.uid;
                        const questRef = ref(database, `users/${userId}/quests/${questId}`);
                        const questSnapshot = await get(questRef);
                        const questData = questSnapshot.val();

                        if (questData && questData.completed && !questData.claimed) {
                            const updates = {};
                            
                            // Reset quest progress and status
                            updates[`users/${userId}/quests/${questId}/progress`] = 0;
                            updates[`users/${userId}/quests/${questId}/completed`] = false;
                            updates[`users/${userId}/quests/${questId}/claimed`] = false;
                            
                            // Add quest points
                            const userRef = ref(database, `users/${userId}`);
                            const userSnapshot = await get(userRef);
                            const currentQuestPoints = userSnapshot.val()?.questPoints || 0;
                            updates[`users/${userId}/questPoints`] = currentQuestPoints + reward;

                            // Apply all updates
                            await update(ref(database), updates);
                            
                            // Update display
                            await updateQuestProgress();
                        }
                    }

                    async function updateQuestPoints() {
                        const auth = window.firebaseAuth;
                        const database = window.firebaseDatabase;
                        const user = auth.currentUser;
                        if (!user) return;

                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();
                        const questPointsDisplay = document.getElementById('quest-points-amount');
                        if (questPointsDisplay) {
                            questPointsDisplay.textContent = userData?.questPoints || 0;
                        }
                    }

                    function closeQuestWindow() {
                        const questWindow = document.getElementById('quest-window');
                        if (questWindow) {
                            questWindow.style.display = 'none';
                        }
                    }

                    async function unlockRecolor(recolorId, cost) {
                        const auth = window.firebaseAuth;
                        const database = window.firebaseDatabase;
                        const user = auth.currentUser;
                        if (!user) return;

                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();

                        if (!userData) return;

                        const questPoints = userData.questPoints || 0;
                        const ownedSkins = userData.skins || {};

                        // Check if user already owns the skin
                        const recolorMap = {
                            'holiday': 'Winter Festival Lili Holiday',
                            'snowy-blush': 'Winter Festival Lili Snowy Blush',
                            'golden': 'Winter Festival Lili Golden',
                            'snowflake': 'Winter Festival Lili Snowflake'
                        };

                        const skinName = recolorMap[recolorId];
                        if (ownedSkins[skinName]) {
                            alert('You already own this skin!');
                            return;
                        }

                        if (questPoints >= cost) {
                            // Deduct quest points
                            const updates = {};
                            updates[`users/${userId}/questPoints`] = questPoints - cost;

                            // Add the recolor to user's skins
                            if (skinName) {
                                updates[`users/${userId}/skins/${skinName}`] = 1;
                            }

                            // Apply updates
                            await update(ref(database), updates);

                            // Update the quest window display
                            await updateQuestProgress();

                            // Disable the claim button
                            const claimButton = document.querySelector(`button[onclick="unlockRecolor('${recolorId}', ${cost})"]`);
                            if (claimButton) {
                                claimButton.disabled = true;
                                claimButton.textContent = 'Claimed';
                                claimButton.style.backgroundColor = '#666'; // Grayed out color
                            }

                            alert('Recolor unlocked successfully!');
                        } else {
                            alert('Not enough quest points!');
                        }
                    }

                    async function unlockAtlantisReward(rewardId, cost, type) {
                        const auth = window.firebaseAuth;
                        const database = window.firebaseDatabase;
                        const user = auth.currentUser;
                        if (!user) return;

                        const userId = user.uid;
                        const userRef = ref(database, `users/${userId}`);
                        const snapshot = await get(userRef);
                        const userData = snapshot.val();

                        if (!userData) return;

                        const questPoints = userData.questPoints || 0;

                        // Check if user has enough quest points
                        if (questPoints < cost) {
                            alert('Not enough quest points!');
                            return;
                        }

                        // Check if user already owns the reward
                        if (type === 'skin') {
                            const ownedSkins = userData.skins || {};
                            if (ownedSkins['Atlantean Kagome']) {
                                alert('You already own this skin!');
                                return;
                            }
                        } else if (type === 'song') {
                            const ownedSongs = userData.Songs || {};
                            if (ownedSongs['Welcome To Atlantis']) {
                                alert('You already own this song!');
                                return;
                            }
                        } else if (type === 'lootbox') {
                            const claimedLootbox = userData.claimedQuestLootbox;
                            if (claimedLootbox) {
                                alert('You have already claimed the free lootbox!');
                                return;
                            }
                        }

                        // Prepare updates
                        const updates = {};
                        updates[`users/${userId}/questPoints`] = questPoints - cost;

                        // Add the reward based on type
                        if (type === 'skin') {
                            updates[`users/${userId}/skins/Atlantean Kagome`] = 1;
                        } else if (type === 'song') {
                            updates[`users/${userId}/Songs/Welcome To Atlantis`] = 1;
                        } else if (type === 'lootbox') {
                            updates[`users/${userId}/claimedQuestLootbox`] = true;
                            // Add lootbox to inventory
                            const currentLootboxes = userData.lootboxes || 0;
                            updates[`users/${userId}/lootboxes`] = currentLootboxes + 1;
                        }

                        // Apply updates
                        await update(ref(database), updates);

                        // Update the quest window display
                        await updateQuestProgress();

                        // Disable the claim button
                        const claimButton = document.querySelector(`button[onclick="unlockAtlantisReward('${rewardId}', ${cost}, '${type}')"]`);
                        if (claimButton) {
                            claimButton.disabled = true;
                            claimButton.textContent = 'Claimed';
                            claimButton.style.backgroundColor = '#666';
                        }

                        alert('Reward claimed successfully!');
                    }

                    // Global variables for demo player
                    let atlantisDemoPlaying = false;
                    let atlantisDemoTimeout = null;

                    function toggleAtlantisSongDemo() {
                        const audio = document.getElementById('atlantis-demo');
                        const button = document.querySelector('.demo-button i');
                        
                        if (atlantisDemoPlaying) {
                            audio.pause();
                            button.className = 'fas fa-play';
                            window.atlantisDemoPlaying = false;
                            if (atlantisDemoTimeout) {
                                clearTimeout(atlantisDemoTimeout);
                                atlantisDemoTimeout = null;
                            }
                        } else {
                            // Load the audio if not loaded
                            if (!audio.src) {
                                audio.src = 'Songs/Welcome To Atlantis.mp3';
                            }

                            // Wait for metadata to load before playing
                            const playAudio = () => {
                                if (audio.duration) {
                                    audio.currentTime = audio.duration * 0.4;
                                    audio.play()
                                        .then(() => {
                                            button.className = 'fas fa-pause';
                                            window.atlantisDemoPlaying = true;

                                            // Stop preview after 15 seconds
                                            window.atlantisDemoTimeout = setTimeout(() => {
                                                if (audio.duration) {
                                                    audio.pause();
                                                    audio.currentTime = audio.duration * 0.4;
                                                }
                                                button.className = 'fas fa-play';
                                                window.atlantisDemoPlaying = false;
                                            }, 15000);
                                        })
                                        .catch(error => {
                                            console.error('Error playing audio:', error);
                                            button.className = 'fas fa-play';
                                            window.atlantisDemoPlaying = false;
                                        });
                                }
                            };

                            if (audio.readyState >= 2) { // HAVE_CURRENT_DATA or higher
                                playAudio();
                            } else {
                                audio.addEventListener('loadedmetadata', playAudio, { once: true });
                            }

                            // When the preview ends naturally
                            audio.onended = () => {
                                button.className = 'fas fa-play';
                                window.atlantisDemoPlaying = false;
                                if (atlantisDemoTimeout) {
                                    clearTimeout(atlantisDemoTimeout);
                                    atlantisDemoTimeout = null;
                                }
                            };
                        }
                    }
    </script>

                <style>
                    /* ... existing styles ... */

                    /* Quest Window Styles */
                    #quest-window .modal-content {
                        background: rgba(0, 30, 46, 0.95);
                        color: #e0ffff;
                        max-width: 1000px;
                        width: 95%;
                        padding: 30px;
                        border: 1px solid #00ced1;
                        box-shadow: 0 0 30px rgba(0, 206, 209, 0.2);
                    }

                    .quest-points {
                    display: flex;
                    align-items: center;
                        gap: 10px;
                        margin-bottom: 20px;
                        font-size: 1.2em;
                    }

                    .quest-points .currency-icon {
                    width: 24px;
                    height: 24px;
                }

                    .quest-reward .currency-icon,
                    .claim-button .currency-icon {
                        width: 16px;
                        height: 16px;
                    }

                    .quest-list {
                        margin-bottom: 30px;
                    }

                    .quest-item {
                        background: rgba(0, 206, 209, 0.15);
                        border: 1px solid rgba(0, 206, 209, 0.3);
                        padding: 15px;
                        border-radius: 8px;
                        margin-bottom: 15px;
                    display: flex;
                        justify-content: space-between;
                    align-items: center;
                    }

                    .quest-info {
                        flex-grow: 1;
                    }

                    .progress-bar {
                        background: rgba(0, 206, 209, 0.1);
                        height: 10px;
                        border-radius: 5px;
                        margin: 10px 0;
                        overflow: hidden;
                    }

                    .progress {
                        background: linear-gradient(90deg, #00ced1, #ffd700);
                        height: 100%;
                        width: 0%;
                        transition: width 0.3s ease;
                    }

                    .quest-reward {
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        margin: 0 20px;
                    }

                    .claim-button {
                        background: #00ced1;
                        color: #ffffff;
                        border: 1px solid rgba(255, 215, 0, 0.3);
                        padding: 6px 12px;
                        border-radius: 5px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        font-size: 0.9em;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                    }

                    .claim-button:hover {
                        background: #ffd700;
                        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
                        transform: translateY(-2px);
                    }

                    .recolors-section {
                        margin-top: 30px;
                    }

                    .recolors-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 20px;
                        margin-top: 20px;
                    }

                    .recolor-item {
                        background: rgba(0, 206, 209, 0.15);
                    padding: 15px;
                        border-radius: 8px;
                        text-align: center;
                }

                    .recolor-item img {
                    width: 100%;
                        height: auto;
                        border-radius: 5px;
                        margin-bottom: 10px;
                    }

                    .unlock-button {
                        background: #00ced1;
                        color: #ffffff;
                        border: 1px solid rgba(255, 215, 0, 0.3);
                        padding: 6px 12px;
                        border-radius: 5px;
                    cursor: pointer;
                        display: flex;
                        align-items: center;
                        gap: 5px;
                        margin: 10px auto;
                    transition: all 0.3s ease;
                }

                    .unlock-button:hover {
                        background: #ffd700;
                        box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
                    transform: translateY(-2px);
                    }

                    .currency-icon {
                        width: 20px;
                        height: 20px;
                    }

                    /* Demo Player Styles */
                    .demo-player {
                        margin-top: 10px;
                    }

                    .demo-button {
                        background: linear-gradient(135deg, #4d88b7, #90caf9);
                        border: 2px solid rgba(255, 255, 255, 0.8);
                        border-radius: 20px;
                        padding: 8px 16px;
                        color: white;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        margin: 0 auto;
                        font-size: 0.9em;
                    }

                    .demo-button:hover {
                        transform: scale(1.05);
                        box-shadow: 0 0 15px rgba(144, 202, 249, 0.6);
                        border-color: white;
                    }

                    .demo-button:active {
                        transform: scale(0.95);
                    }

                    .demo-button i {
                        font-size: 1.1em;
                        text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
                    }
                </style>

    <!-- 2024 Award Winners Window -->
    <div id="awards-window" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeAwardsWindow()">&times;</span>
            <h2>2024 Award Winners</h2>
            <div class="awards-list">
                <div class="award-item">
                    <div class="award-info">
                        <h3>Highest Winrate: Shizumaru</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Superhero Shizumaru.png" alt="Superhero Shizumaru" class="award-skin-image">
                        </div>
                        <div class="skin-name">Superhero Shizumaru</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">3000</span>
                            <span class="sale-price">1500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Superhero Shizumaru', 1500)">Purchase for 1500 FM</button>
                    </div>
                </div>
                <div class="award-item">
                    <div class="award-info">
                        <h3>Most Picked: Shizumaru</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Desert Demon Shizumaru.png" alt="Desert Demon Shizumaru" class="award-skin-image">
                        </div>
                        <div class="skin-name">Desert Demon Shizumaru</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">3000</span>
                            <span class="sale-price">1500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Desert Demon Shizumaru', 1500)">Purchase for 1500 FM</button>
                    </div>
                </div>
                <div class="award-item">
                    <div class="award-info">
                        <h3>Best E-sport: Noel</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Underworld Demon Noel.png" alt="Underworld Demon Noel" class="award-skin-image">
                        </div>
                        <div class="skin-name">Underworld Demon Noel</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">3000</span>
                            <span class="sale-price">1500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Underworld Demon Noel', 1500)">Purchase for 1500 FM</button>
                    </div>
                </div>
                <div class="award-item">
                    <div class="award-info">
                        <h3>Community Favourite: Shoma</h3>
                        <div class="image-container">
                            <img src="Loading Screen/Skater Shoma.png" alt="Skater Shoma" class="award-skin-image">
                        </div>
                        <div class="skin-name">Skater Shoma</div>
                        <div class="skin-price">
                            <img src="res/img/fm.png" alt="FM" class="currency-icon">
                            <span class="original-price">1000</span>
                            <span class="sale-price">500</span>
                        </div>
                        <button class="purchase-button" onclick="purchaseAwardSkin('Skater Shoma', 500)">Purchase for 500 FM</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Awards Window Styles */
        #awards-window {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 6000; /* Increased by 5000 */
            background: rgba(0, 30, 46, 0.9);
        }

        #awards-window .modal-content {
            background: rgba(0, 30, 46, 0.95);
            color: #e0ffff;
            max-width: 1400px;
            width: 95%;
            padding: 30px;
            border: 1px solid #00ced1;
            position: relative;
        }

        .awards-list {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 30px; /* Increased gap for better spacing */
            margin-top: 20px;
            padding: 0 20px; /* Added padding for better edge spacing */
        }

        .award-item {
            background: rgba(0, 206, 209, 0.15);
            padding: 20px;
            border-radius: 4px;
            text-align: center;
            max-width: 300px;
            margin: 0 auto;
            width: 100%;
        }

        .award-info {
            width: 100%;
        }

        .award-info h3 {
            margin-bottom: 15px;
            font-size: 1.2em;
            color: #ffd700;
        }

        .image-container {
            width: 100%;
            padding-top: 171.43%; /* 1800/1050 ≈ 171.43% for correct aspect ratio */
            position: relative;
            overflow: hidden;
            margin: 10px 0;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .award-skin-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .skin-name {
            font-size: 1.1em;
            margin: 10px 0;
            color: #e0ffff;
        }

        .skin-price {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            margin: 10px 0;
            font-size: 1.1em;
        }

        .original-price {
            text-decoration: line-through;
            color: #999;
        }

        .sale-price {
            color: #ffd700;
            font-weight: bold;
        }

        .purchase-button {
            background: #00ced1;
            color: #ffffff;
            border: 1px solid rgba(255, 215, 0, 0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            width: 80%;
            font-size: 1em;
        }

        .purchase-button:hover {
            background: #ffd700;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.4);
            transform: translateY(-2px);
        }

        .purchase-button.disabled {
            background: #1a4657;
            border-color: rgba(255, 255, 255, 0.1);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: #fff;
            background: rgba(255, 255, 255, 0.1);
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 1200px) {
            .awards-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .awards-list {
                grid-template-columns: 1fr;
            }
        }
    </style>

    <script>
        // Add these functions to your existing script
        window.openAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'block';
                updateAwardButtons();
            }
        }

        window.closeAwardsWindow = function() {
            const awardsWindow = document.getElementById('awards-window');
            if (awardsWindow) {
                awardsWindow.style.display = 'none';
            }
        }

        async function updateAwardButtons() {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();
            const ownedSkins = userData.skins || {};

            const awardSkins = [
                'Superhero Shizumaru',
                'Desert Demon Shizumaru',
                'Underworld Demon Noel',
                'Skater Shoma'
            ];

            awardSkins.forEach(skinName => {
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${getPriceForSkin(skinName)})"]`);
                if (button && ownedSkins[skinName]) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }
            });
        }

        function getPriceForSkin(skinName) {
            const prices = {
                'Superhero Shizumaru': 1500,
                'Desert Demon Shizumaru': 1500,
                'Underworld Demon Noel': 1500,
                'Skater Shoma': 500
            };
            return prices[skinName] || 0;
        }

        async function purchaseAwardSkin(skinName, price) {
            const auth = window.firebaseAuth;
            const database = window.firebaseDatabase;
            const user = auth.currentUser;
            if (!user) return;

            const userRef = ref(database, 'users/' + user.uid);
            const snapshot = await get(userRef);
            const userData = snapshot.val();

            if (!userData) return;

            const currentFM = userData.FM || 0;
            const ownedSkins = userData.skins || {};

            if (ownedSkins[skinName]) {
                alert('You already own this skin!');
                return;
            }

            if (currentFM >= price) {
                const updates = {};
                updates['FM'] = currentFM - price;
                updates[`skins/${skinName}`] = 1;

                await update(userRef, updates);

                // Update FM display
                const fmDisplay = document.getElementById('currency-amount');
                if (fmDisplay) {
                    fmDisplay.textContent = currentFM - price;
                }

                // Update button state
                const button = document.querySelector(`button[onclick="purchaseAwardSkin('${skinName}', ${price})"]`);
                if (button) {
                    button.disabled = true;
                    button.textContent = 'Owned';
                    button.classList.add('disabled');
                }

                alert(`You have successfully purchased ${skinName}!`);
            } else {
                alert("You don't have enough FM to purchase this skin.");
            }
        }
    </script>
    
    <!-- Music Player -->
    <button class="music-player-toggle">
        <i class="fas fa-music"></i>
    </button>
    <div class="music-player">
        <div class="music-player-header">
            <button class="playlist-toggle">
                <i class="fas fa-list"></i>
            </button>
        </div>
        <div class="cover-art">
            <img src="" alt="Cover Art">
        </div>
        <div class="music-info">
            <div class="song-title"></div>
            <div class="artist-name"></div>
        </div>
        <div class="progress-container">
            <div class="progress"></div>
            <div class="progress-handle"></div>
        </div>
        <div class="time-info">
            <span class="current-time">0:00</span>
            <span class="duration">0:00</span>
        </div>
        <div class="controls">
            <button class="shuffle-btn">
                <i class="fas fa-random"></i>
            </button>
            <button class="prev-btn">
                <i class="fas fa-step-backward"></i>
            </button>
            <button class="play-btn">
                <i class="fas fa-play"></i>
            </button>
            <button class="next-btn">
                <i class="fas fa-step-forward"></i>
            </button>
        </div>
        <div class="volume-control">
            <i class="fas fa-volume-up"></i>
            <input type="range" class="volume-slider" min="0" max="100" value="50">
        </div>
        <div class="playlist">
            <div class="playlist-header">
                <h3>Playlist</h3>
            </div>
            <ul class="playlist-items">
                <!-- Songs will be added here dynamically -->
            </ul>
        </div>
    </div>

    <button class="skin-highlight-toggle">
        <i class="fas fa-star"></i>
    </button>
    <div class="skin-highlight">
        <div class="skin-highlight-header">
            <h3>Featured Skins</h3>
        </div>
        <div class="skin-highlight-content">
            <!-- Skins will be loaded here dynamically -->
        </div>
    </div>

    <!-- Add Lightbox -->
    <div id="lightbox" class="lightbox">
        <div class="lightbox-content">
            <img id="lightbox-image" src="" alt="Skin Image">
            <button id="purchase-button" class="purchase-button" onclick="purchaseSkin()"></button>
            <button class="close-button" onclick="closeLightbox()">x</button>
        </div>
    </div>

    <style>
        /* Skin Highlight Styles */
        .skin-highlight-toggle {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 30, 46, 0.95);
            color: #e0ffff;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #00ced1;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
            transition: all 0.3s ease;
        }

        .skin-highlight-toggle:hover {
            background: rgba(0, 206, 209, 0.2);
            transform: translateY(-50%) scale(1.1);
        }

        .skin-highlight {
            position: fixed;
            left: -300px;
            top: 50%;
            transform: translateY(-50%);
            width: 300px;
            background: rgba(0, 30, 46, 0.95);
            border: 1px solid #00ced1;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 206, 209, 0.3);
            z-index: 999;
            transition: left 0.3s ease;
            backdrop-filter: blur(5px);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .skin-highlight.show {
            left: 70px;
        }

        .skin-highlight-header {
            padding: 15px;
            border-bottom: 1px solid #00ced1;
            text-align: center;
        }

        .skin-highlight-header h3 {
            margin: 0;
            color: #e0ffff;
            font-size: 1.2em;
        }

        .skin-highlight-content {
            padding: 15px;
            overflow-y: auto;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .featured-skin {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            cursor: pointer;
            background: #000; /* Add dark background */
            transform: translate3d(0, 0, 0); /* Force GPU acceleration */
        }

        .featured-skin:hover {
            transform: none; /* Remove container scale */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .featured-skin img {
            width: 100%;
            height: 152px; /* 16:9 aspect ratio for 270px width */
            object-fit: cover;
            display: block;
            image-rendering: -webkit-optimize-contrast; /* Improve image quality in Chrome/Safari */
            image-rendering: crisp-edges; /* Improve image quality in Firefox */
            backface-visibility: hidden; /* Prevent blurry text on transform */
            transform: translateZ(0); /* Force GPU acceleration */
            will-change: transform; /* Optimize for animations */
        }

        .featured-skin:hover img {
            transform: scale(1.05); /* Move scale to img instead of container */
            transition: transform 0.3s ease;
        }

        .featured-skin-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 10px;
            background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
            color: #fff;
        }

        .featured-skin-name {
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .featured-skin-price {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .featured-skin-price img {
            width: 16px;
            height: 16px;
        }

        /* Lightbox Styles */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.9);
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s ease;
        }

        .lightbox-content {
            position: relative;
            max-width: 80%;
            max-height: 80%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lightbox-content img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 10px;
        }

        .lightbox .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ffcc00;
            color: black;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .purchase-button {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background-color: grey;
            color: black;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 1em;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .purchase-button.enabled {
            background-color: gold;
        }

        .purchase-button.disabled {
            background-color: grey;
        }
    </style>

    <script>
        // Make functions globally available
        window.openLightbox = function(src, name, price) {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'flex';
            const img = document.getElementById('lightbox-image');
            img.src = src;
            const purchaseButton = document.getElementById('purchase-button');
            purchaseButton.dataset.skinName = name;
            purchaseButton.dataset.skinPrice = price;
            purchaseButton.textContent = `Purchase for ${price} FM`;
            purchaseButton.className = window.userFM >= price ? 'purchase-button enabled' : 'purchase-button disabled';
            if (window.userSkins && window.userSkins[name]) {
                purchaseButton.classList.add('disabled');
                purchaseButton.textContent = 'Owned';
            }
        };

        window.closeLightbox = function(event) {
            const lightbox = document.getElementById('lightbox');
            lightbox.style.display = 'none';
            if (event) {
                event.stopPropagation(); // Prevent the click from bubbling up
            }
        };

        window.purchaseSkin = async function() {
            const purchaseButton = document.getElementById('purchase-button');
            const skinName = purchaseButton.dataset.skinName;
            const skinPrice = parseInt(purchaseButton.dataset.skinPrice, 10);

            if (window.userFM >= skinPrice) {
                const newFM = window.userFM - skinPrice;
                const updates = {};
                updates['FM'] = newFM;
                updates[`skins/${skinName}`] = 1;
                await update(window.userRef, updates);
                document.getElementById('currency-amount').textContent = newFM;
                window.userFM = newFM;
                window.userSkins[skinName] = 1;
                closeLightbox();
                alert(`You have successfully purchased ${skinName}!`);
                
                // Update any matching skins in the highlight panel
                const skinElements = document.querySelectorAll('.featured-skin');
                skinElements.forEach(element => {
                    const nameElement = element.querySelector('.featured-skin-name');
                    if (nameElement && nameElement.textContent === skinName) {
                        element.classList.add('owned');
                    }
                });
            } else {
                alert("You don't have enough FM to purchase this skin.");
            }
        };

        // Initialize skin highlight functionality
        document.addEventListener('DOMContentLoaded', function() {
            const skinHighlightToggle = document.querySelector('.skin-highlight-toggle');
            const skinHighlight = document.querySelector('.skin-highlight');
            const musicPlayerToggle = document.querySelector('.music-player-toggle');
            const musicPlayer = document.querySelector('.music-player');
            
            if (skinHighlightToggle && skinHighlight) {
                skinHighlightToggle.addEventListener('click', function(event) {
                    event.stopPropagation();
                    skinHighlight.classList.toggle('show');
                });

                // Close skin highlight when clicking outside, but ignore music player clicks
                document.addEventListener('click', function(event) {
                    // Ignore clicks on music player elements
                    if (musicPlayer && (musicPlayer.contains(event.target) || musicPlayerToggle.contains(event.target))) {
                        return;
                    }
                    
                    // Handle skin highlight panel
                    if (!skinHighlight.contains(event.target) && 
                        !skinHighlightToggle.contains(event.target) && 
                        skinHighlight.classList.contains('show')) {
                        skinHighlight.classList.remove('show');
                    }
                });

                // Prevent skin highlight panel from closing when clicking inside it
                skinHighlight.addEventListener('click', function(event) {
                    event.stopPropagation();
                });

                // Load featured skins from Firebase
                const auth = window.firebaseAuth;
                const database = window.firebaseDatabase;
                
                const featuredSkinsRef = ref(database, 'Server/skinhighlight');
                get(featuredSkinsRef).then((snapshot) => {
                    if (snapshot.exists()) {
                        const featuredSkins = snapshot.val();
                        const skinHighlightContent = document.querySelector('.skin-highlight-content');
                        skinHighlightContent.innerHTML = ''; // Clear existing content

                        Object.values(featuredSkins).forEach(skin => {
                            const skinElement = document.createElement('div');
                            skinElement.className = 'featured-skin';
                            if (window.userSkins && window.userSkins[skin.name]) {
                                skinElement.classList.add('owned');
                            }
                            skinElement.innerHTML = `
                                <img src="${skin.image}" alt="${skin.name}">
                                <div class="featured-skin-info">
                                    <div class="featured-skin-name">${skin.name}</div>
                                    <div class="featured-skin-price">
                                        <img src="res/img/fm.png" alt="FM">
                                        <span>${skin.price}</span>
                                    </div>
                                </div>
                            `;
                            
                            // Add click handler to open lightbox
                            skinElement.addEventListener('click', (event) => {
                                event.stopPropagation();
                                openLightbox(skin.image, skin.name, skin.price);
                            });
                            
                            skinHighlightContent.appendChild(skinElement);
                        });
                    }
                }).catch((error) => {
                    console.error("Error loading featured skins:", error);
                });
            }
        });
    </script>
</body>
</html>