<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Fighters - ARAM</title>
    <link rel="icon" href="Icons/Profile/talim_desert.webp" type="image/webp">
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js" type="module"></script>
    <script src="https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js" type="module"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-color: #0A1428;
            --secondary-color: #1E2328;
            --accent-color: #C89B3C;
            --text-color: #F0E6D2;
            --border-color: #463714;
            --hover-color: #785A28;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--primary-color);
            color: var(--text-color);
            height: 100vh;
            display: grid;
            grid-template-columns: 300px 1fr 300px;
            grid-template-rows: 60px 1fr 100px;
            gap: 10px;
            padding: 10px;
        }

        /* Header Section */
        .header {
            grid-column: 1 / -1;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .phase-info {
            text-align: center;
        }

        /* Left Sidebar */
        .left-sidebar {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            overflow-y: auto;
            border-radius: 8px;
        }

        .team-member {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background-color: var(--primary-color);
            border-radius: 8px;
            position: relative;
            min-height: 120px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-blend-mode: multiply;
            background-color: rgba(0, 0, 0, 0.3);
        }

        .champion-portrait {
            width: 80px;
            height: 80px;
            border-radius: 12px;
            background-color: var(--border-color);
            overflow: hidden;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .champion-portrait img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .player-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding-right: 10px;
        }

        .player-name {
            font-weight: bold;
            color: var(--text-color);
            font-size: 1.1em;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .player-rank {
            font-size: 0.9em;
            color: var(--accent-color);
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        /* Main Content */
        .main-content {
            display: grid;
            grid-template-rows: auto 1fr;
            gap: 10px;
            max-height: calc(100vh - 180px);
            overflow: hidden;
            position: relative;
            border-radius: 8px;
            background-image: url('ARAM.jpeg');
            background-size: cover;
            background-position: center;
            z-index: 0;
        }

        /* Add overlay for main content background */
        .main-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(10, 20, 40, 0.85);
            z-index: 1;
            border-radius: 8px;
            pointer-events: none;
        }

        /* Ensure content inside main-content is above the overlay */
        .main-content > * {
            position: relative;
            z-index: 2;
        }

        /* ARAM-specific styles */
        .swap-options {
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 10px;
            background-color: transparent;
            margin-bottom: 10px;
        }

        .swap-option {
            width: 80px;
            height: 80px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }

        .swap-option:hover {
            transform: scale(1.1);
            border-color: var(--accent-color);
        }

        .swap-option img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .select-skin-button {
            padding: 8px 16px;
            background: linear-gradient(to bottom right, var(--accent-color), #785A28);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }

        .select-skin-button:hover {
            background: linear-gradient(45deg, #D4AF37, var(--accent-color));
        }

        /* Right Sidebar */
        .right-sidebar {
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 15px;
            padding: 15px;
            overflow-y: auto;
            border-radius: 8px;
        }

        /* Footer */
        .footer {
            grid-column: 1 / -1;
            background-color: var(--secondary-color);
            border: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            gap: 15px;
            height: 100%;
        }

        .footer-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .load-build-button {
            padding: 12px 24px;
            background: linear-gradient(to bottom right, var(--accent-color), #785A28);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .load-build-button.selected {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
        }

        .load-build-button:hover:not(.selected) {
            background: linear-gradient(45deg, #D4AF37, var(--accent-color));
        }

        .chat-section {
            flex: 0 1 500px;
            height: 80px;
            background-color: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            font-size: 14px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .chat-message {
            padding: 4px 8px;
            border-radius: 4px;
            background-color: var(--secondary-color);
            word-break: break-word;
            display: flex;
            flex-wrap: wrap;
            align-items: baseline;
            gap: 4px;
        }

        .chat-input {
            padding: 8px;
            background-color: var(--secondary-color);
            border: none;
            border-top: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 14px;
            width: 100%;
        }

        .start-match-button {
            padding: 12px 24px;
            background: linear-gradient(to bottom right, var(--accent-color), #785A28);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .start-match-button.ready {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        /* Add skin selection modal styles */
        .skin-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .skin-selection-content {
            background: var(--secondary-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .skin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .skin-card {
            background: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .skin-card:hover {
            transform: scale(1.05);
            border-color: var(--accent-color);
        }

        .skin-card img {
            width: 100%;
            aspect-ratio: 16/9;
            object-fit: cover;
            filter: brightness(0.8);
        }

        .skin-card:hover img {
            filter: brightness(1);
            transition: filter 0.3s ease;
        }

        .skin-name {
            padding: 10px;
            text-align: center;
            color: var(--text-color);
            font-size: 14px;
        }

        /* Volume Control Styles */
        .volume-control-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--secondary-color);
            padding: 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1001;
        }

        .play-music-button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            display: none;
            transition: color 0.3s ease;
        }

        .play-music-button:hover {
            color: var(--accent-color);
        }

        .play-music-button.show {
            display: block;
        }

        .volume-slider {
            -webkit-appearance: none;
            width: 100px;
            height: 4px;
            border-radius: 2px;
            background: var(--primary-color);
            outline: none;
        }

        .volume-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .volume-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            background: var(--hover-color);
        }

        .volume-icon {
            color: var(--text-color);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .volume-icon:hover {
            color: var(--accent-color);
        }

        /* Add build selection modal styles */
        .build-selection-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .build-selection-content {
            background: var(--secondary-color);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 1200px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .build-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
        }

        .build-card {
            background: var(--primary-color);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .build-card:hover {
            transform: scale(1.02);
            border-color: var(--accent-color);
        }

        .build-title {
            font-size: 18px;
            color: var(--accent-color);
            margin-bottom: 10px;
        }

        .build-info {
            font-size: 14px;
            color: var(--text-color);
            margin-bottom: 10px;
        }

        .build-items {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .build-item {
            width: 40px;
            height: 40px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .build-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .copy-build {
            padding: 12px 24px;
            background: linear-gradient(to bottom right, var(--accent-color), #785A28);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s ease;
        }

        .copy-build:hover {
            transform: translateY(-2px);
            background: linear-gradient(to bottom right, #D4AF37, var(--accent-color));
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .rating-button {
            padding: 8px 16px;
            background: var(--primary-color);
            color: var(--text-color);
            border: 2px solid var(--accent-color);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .rating-button:hover {
            background: var(--accent-color);
        }

        .rating-button.liked {
            background: var(--accent-color);
            color: var(--text-color);
        }

        .build-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
            gap: 10px;
        }
    </style>
</head>
<body>
    <!-- Background Image -->
    <!-- <img src="Event/Tokyo Mew Mew Event 2.png" alt="Background" class="background-image"> -->
    
    <audio id="background-music" preload="auto" loop>
        Your browser does not support the audio element.
    </audio>

    <!-- Header -->
    <header class="header">
        <div></div>
        <div class="phase-info">
            <h2>ARAM</h2>
            <p>All Random All Mid</p>
        </div>
        <div></div>
    </header>

    <!-- Left Sidebar (Blue Team) -->
    <aside class="left-sidebar">
        <div class="team-member" id="blue-1">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">You</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="blue-2">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 1</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="blue-3">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 2</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="blue-4">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 3</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="blue-5">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 4</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="swap-options">
            <!-- Swap options will be added here dynamically -->
        </div>
    </main>

    <!-- Right Sidebar (Red Team) -->
    <aside class="right-sidebar">
        <div class="team-member" id="red-1">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 5</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="red-2">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 6</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="red-3">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 7</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="red-4">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 8</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
        <div class="team-member" id="red-5">
            <div class="champion-portrait"></div>
            <div class="player-info">
                <div class="player-name">AI Player 9</div>
                <div class="player-rank">0 RP</div>
            </div>
        </div>
    </aside>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-buttons">
            <button class="start-match-button">START MATCH</button>
            <button class="load-build-button" id="loadBuildButton">LOAD BUILD</button>
        </div>
        <div class="chat-section">
            <div class="chat-messages"></div>
            <input type="text" class="chat-input" placeholder="Type a message...">
        </div>
        <div class="settings">
            <!-- Settings buttons will go here -->
        </div>
    </footer>

    <!-- Add Volume Control -->
    <div class="volume-control-container">
        <button class="play-music-button" id="playMusicButton">
            <i class="fas fa-play"></i>
        </button>
        <i class="fas fa-volume-up volume-icon" id="volumeIcon"></i>
        <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="20">
    </div>

    <!-- Skin Selection Modal -->
    <div class="skin-selection-modal" id="skinSelectionModal">
        <div class="skin-selection-content">
            <div class="skin-grid" id="skinGrid">
                <!-- Skins will be added here dynamically -->
            </div>
        </div>
    </div>

    <!-- Add this new modal -->
    <div class="build-selection-modal" id="buildSelectionModal">
        <div class="build-selection-content">
            <h2 class="role-select-title">Select Build</h2>
            <div class="build-grid" id="buildGrid">
                <!-- Builds will be added here dynamically -->
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-auth.js';
        import { getDatabase, ref, set, get, update } from 'https://www.gstatic.com/firebasejs/9.10.0/firebase-database.js';
        import { roles } from './roles.js';
        import { usernames } from './usernames.js';
        import { chatMessages, contextualResponses, timeBasedMessages } from './chat_messages.js';
        import { CURRENT_PATCH } from './patch.js'; // Import CURRENT_PATCH

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCqhxq6sPDU3EmuvvkBIIDJ-H6PsBc42Jg",
            authDomain: "project-fighters-by-fishb0nes.firebaseapp.com",
            databaseURL: "https://project-fighters-by-fishb0nes-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "project-fighters-by-fishb0nes",
            storageBucket: "project-fighters-by-fishb0nes.appspot.com",
            messagingSenderId: "867339299995",
            appId: "1:867339299995:web:99c379940014b9c05cea3e",
            measurementId: "G-LNEM6HR842"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        // Game state variables
        let selectedChampion = null;
        let swapOptions = [];
        let playerTeam = Math.random() < 0.5 ? 'blue' : 'red';
        let playerSlot = Math.floor(Math.random() * 5) + 1;
        let currentUser = null;
        let selectedSkin = null;
        let hasSwapped = false;
        let userData = null;
        let selectedBuild = null;

        // Move audio initialization to the top of the script
        const audio = document.getElementById('background-music');
        const volumeSlider = document.getElementById('volumeSlider');
        const volumeIcon = document.getElementById('volumeIcon');
        const playMusicButton = document.getElementById('playMusicButton');
        let lastVolume = 0.2;

        // Set initial volume
        audio.volume = 0.2;

        // Determine music path based on patch
        const musicPath = CURRENT_PATCH === "2.5" ? "Songs/team_up_tokyo_mew_mew.mp3" : "res/music/ranked.mp3";
        audio.src = musicPath;

        // Try to play audio and handle autoplay restrictions
        async function initializeAudio() {
            try {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        playMusicButton.style.display = 'none';
                    }).catch(err => {
                        console.log('Autoplay prevented:', err);
                        playMusicButton.classList.add('show');
                    });
                }
            } catch (err) {
                console.log('Autoplay prevented:', err);
                playMusicButton.classList.add('show');
            }
        }

        // Initialize audio when the page loads
        document.addEventListener('DOMContentLoaded', initializeAudio);

        // Try to play audio when user interacts with the page
        document.addEventListener('click', () => {
            if (audio.paused) {
                initializeAudio();
            }
        }, { once: true });

        // Add click event for play button with better error handling
        playMusicButton.addEventListener('click', async () => {
            try {
                const playPromise = audio.play();
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        playMusicButton.style.display = 'none';
                    }).catch(err => {
                        console.error('Failed to play audio:', err);
                        // Show error message to user
                        alert('Failed to play audio. Please check your browser settings.');
                    });
                }
            } catch (err) {
                console.error('Failed to play audio:', err);
                alert('Failed to play audio. Please check your browser settings.');
            }
        });

        // Update volume when slider changes
        volumeSlider.addEventListener('input', (e) => {
            const volume = e.target.value / 100;
            audio.volume = volume;
            lastVolume = volume;
            updateVolumeIcon(volume);
        });

        // Toggle mute/unmute when clicking the icon
        volumeIcon.addEventListener('click', () => {
            if (audio.volume > 0) {
                audio.volume = 0;
                volumeSlider.value = 0;
            } else {
                audio.volume = lastVolume;
                volumeSlider.value = lastVolume * 100;
            }
            updateVolumeIcon(audio.volume);
        });

        // Update volume icon based on volume level
        function updateVolumeIcon(volume) {
            volumeIcon.className = 'fas volume-icon';
            if (volume === 0) {
                volumeIcon.className += ' fa-volume-mute';
            } else if (volume < 0.5) {
                volumeIcon.className += ' fa-volume-down';
            } else {
                volumeIcon.className += ' fa-volume-up';
            }
        }

        // Function to generate random champions
        function assignRandomChampions() {
            const allChampions = new Set();
            Object.values(roles).forEach(roleChamps => {
                roleChamps.forEach(champ => allChampions.add(champ));
            });
            
            const availableChampions = Array.from(allChampions);
            const assignments = new Map();
            
            // Assign random champions to all players
            for (let team of ['blue', 'red']) {
                for (let slot = 1; slot <= 5; slot++) {
                    const randomIndex = Math.floor(Math.random() * availableChampions.length);
                    const champion = availableChampions.splice(randomIndex, 1)[0];
                    assignments.set(`${team}_${slot}`, champion);
                }
            }

            // Generate 3 random swap options for the player
            swapOptions = [];
            for (let i = 0; i < 3; i++) {
                if (availableChampions.length > 0) {
                    const randomIndex = Math.floor(Math.random() * availableChampions.length);
                    swapOptions.push(availableChampions.splice(randomIndex, 1)[0]);
                }
            }

            return assignments;
        }

        // Function to display swap options
        function displaySwapOptions() {
            const swapContainer = document.querySelector('.swap-options');
            swapContainer.innerHTML = '';
            
            swapOptions.forEach(champion => {
                const option = document.createElement('div');
                option.className = 'swap-option';
                option.innerHTML = `<img src="Icons/${champion}.png" alt="${champion}">`;
                option.addEventListener('click', () => swapChampion(champion));
                swapContainer.appendChild(option);
            });
        }

        // Function to swap champion
        function swapChampion(newChampion) {
            if (hasSwapped || selectedSkin) {
                return; // Prevent swapping if already swapped or skin selected
            }

            selectedChampion = newChampion;
            const memberElement = document.getElementById(`${playerTeam}-${playerSlot}`);
            const portrait = memberElement.querySelector('.champion-portrait');
            portrait.innerHTML = `<img src="Icons/${newChampion}.png" alt="${newChampion}">`;
            
            // Remove existing skin button if any
            const existingButton = memberElement.querySelector('.select-skin-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            // Add skin selection button
            const skinButton = document.createElement('button');
            skinButton.className = 'select-skin-button';
            skinButton.textContent = 'Select Skin';
            skinButton.onclick = () => showSkinSelection(newChampion);
            memberElement.appendChild(skinButton);

            hasSwapped = true; // Mark that the player has used their swap

            // Disable all swap options
            const swapOptions = document.querySelectorAll('.swap-option');
            swapOptions.forEach(option => {
                option.style.opacity = '0.5';
                option.style.cursor = 'not-allowed';
                option.removeEventListener('click', swapChampion);
            });
        }

        // Function to show skin selection
        async function showSkinSelection(champion) {
            const modal = document.getElementById('skinSelectionModal');
            const skinGrid = document.getElementById('skinGrid');
            skinGrid.innerHTML = '';

            try {
                // Get user's owned skins from Firebase
                const userRef = ref(database, `users/${currentUser.uid}/skins`);
                const snapshot = await get(userRef);
                const ownedSkins = snapshot.val() || {};

                // Import skin data
                const { characters } = await import('./characterskinref.js');
                const availableSkins = characters[champion] || [];
                
                // Create skin cards for owned skins
                availableSkins.forEach(skin => {
                    if (ownedSkins[skin]) {
                        const card = document.createElement('div');
                        card.className = 'skin-card';
                        
                        const img = document.createElement('img');
                        img.src = `Skins/${skin}.jpeg`;
                        img.onerror = function() {
                            this.src = `Skins/${skin}.png`;
                            this.onerror = function() {
                                this.src = `Skins/${skin}.jpg`;
                                this.onerror = function() {
                                    this.src = `Icons/${champion}.png`;
                                }
                            }
                        };
                        img.alt = skin;
                        img.className = 'skin-image';
                        
                        const name = document.createElement('div');
                        name.className = 'skin-name';
                        name.textContent = skin.replace(champion + " ", "");
                        
                        card.appendChild(img);
                        card.appendChild(name);
                        
                        card.addEventListener('click', () => {
                            selectSkin(skin);
                            modal.style.display = 'none';
                        });
                        
                        skinGrid.appendChild(card);
                    }
                });

                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading skins:', error);
            }
        }

        // Function to select skin
        function selectSkin(skin) {
            selectedSkin = skin;
            const memberElement = document.getElementById(`${playerTeam}-${playerSlot}`);
            
            // Try different image extensions for the skin
            const img = new Image();
            img.onload = function() {
                memberElement.style.backgroundImage = `url('${this.src}')`;
                memberElement.style.backgroundSize = 'cover';
                memberElement.style.backgroundPosition = 'center';
                
                // Show Load Build button after skin is selected with animation
                const loadBuildButton = document.getElementById('loadBuildButton');
                loadBuildButton.style.display = 'block';
                loadBuildButton.classList.add('available');
            };
            
            img.src = `Skins/${skin}.jpeg`;
            img.onerror = function() {
                this.src = `Skins/${skin}.png`;
                this.onerror = function() {
                    this.src = `Skins/${skin}.jpg`;
                    this.onerror = function() {
                        this.src = `Icons/${selectedChampion}.png`;
                    }
                }
            };

            // Disable swap options after skin selection
            const swapOptions = document.querySelectorAll('.swap-option');
            swapOptions.forEach(option => {
                option.style.opacity = '0.5';
                option.style.cursor = 'not-allowed';
                option.removeEventListener('click', swapChampion);
            });
        }

        // Initialize game
        async function initializeGame(championAssignments) {
            // Set up player names and champions
            for (let team of ['blue', 'red']) {
                for (let slot = 1; slot <= 5; slot++) {
                    const memberElement = document.getElementById(`${team}-${slot}`);
                    const portrait = memberElement.querySelector('.champion-portrait');
                    const champion = championAssignments.get(`${team}_${slot}`);
                    
                    if (team === playerTeam && slot === playerSlot) {
                        selectedChampion = champion;
                        memberElement.classList.add('player-slot');
                        const skinButton = document.createElement('button');
                        skinButton.className = 'select-skin-button';
                        skinButton.textContent = 'Select Skin';
                        skinButton.onclick = () => showSkinSelection(champion);
                        memberElement.appendChild(skinButton);
                    } else {
                        // AI player - automatically select a random skin
                        try {
                            const { characters } = await import('./characterskinref.js');
                            const availableSkins = characters[champion] || [champion];
                            const randomSkin = availableSkins[Math.floor(Math.random() * availableSkins.length)];
                            
                            // Try different image formats for the skin
                            const img = new Image();
                            img.onload = function() {
                                memberElement.style.backgroundImage = `url('${this.src}')`;
                                memberElement.style.backgroundSize = 'cover';
                                memberElement.style.backgroundPosition = 'center';
                            };
                            
                            const tryLoadImage = (skin, extensions = ['jpeg', 'png', 'jpg', 'jfif']) => {
                                if (extensions.length === 0) {
                                    img.src = `Icons/${champion}.png`;
                                    return;
                                }
                                
                                img.src = `Skins/${skin}.${extensions[0]}`;
                                img.onerror = () => tryLoadImage(skin, extensions.slice(1));
                            };
                            
                            tryLoadImage(randomSkin);
                        } catch (error) {
                            console.error('Error selecting AI skin:', error);
                        }
                    }
                    
                    portrait.innerHTML = `<img src="Icons/${champion}.png" alt="${champion}">`;
                }
            }

            // Start chat system
            startAIChat();
        }

        // Add this helper function for role assignment
        function assignStealthRoles() {
            const roles = ['Top', 'Jungle', 'Mid', 'Adc', 'Support'];
            const assignments = {
                blue: {},
                red: {}
            };

            // Shuffle roles for each team
            for (const team of ['blue', 'red']) {
                const shuffledRoles = [...roles].sort(() => Math.random() - 0.5);
                for (let slot = 1; slot <= 5; slot++) {
                    assignments[team][slot] = shuffledRoles[slot - 1];
                }
            }

            return assignments;
        }

        // Update startGame function
        async function startGame() {
            try {
                // Generate a unique queue ID
                const queueId = Date.now().toString(36) + Math.random().toString(36).substr(2);
                
                // Get current user's data
                const userRef = ref(database, `users/${currentUser.uid}`);
                const userSnapshot = await get(userRef);
                const userData = userSnapshot.val();

                // Assign stealth roles
                const roleAssignments = assignStealthRoles();

                // Collect game information
                const gameInfo = {
                    queueId,
                    timestamp: Date.now(),
                    gameMode: 'ARAM',
                    players: {}
                };

                // Collect information for all players
                for (let team of ['blue', 'red']) {
                    for (let slot = 1; slot <= 5; slot++) {
                        const memberElement = document.getElementById(`${team}-${slot}`);
                        const championPortrait = memberElement.querySelector('.champion-portrait img');
                        const champion = championPortrait ? championPortrait.alt : null;
                        
                        if (team === playerTeam && slot === playerSlot) {
                            gameInfo.players[`${team}_${slot}`] = {
                                name: userData.username || currentUser.email.split('@')[0],
                                champion: champion,
                                skin: selectedSkin || champion,
                                build: selectedBuild || null,
                                team,
                                isAI: false,
                                uid: currentUser.uid,
                                profileIcon: userData.icon || 'Birdie.png',
                                playerSlot: slot,
                                playerTeam: team,
                                role: roleAssignments[team][slot] // Add stealth role
                            };
                        } else {
                            // Get the background image URL which contains the skin
                            const backgroundImage = memberElement.style.backgroundImage;
                            let aiSkin = champion; // Default to champion name if no skin is found
                            
                            // Extract skin name from background image URL if it exists
                            if (backgroundImage) {
                                const match = backgroundImage.match(/Skins\/(.*?)\.(jpeg|jpg|png|jfif)/);
                                if (match) {
                                    aiSkin = match[1];
                                }
                            }
                            
                            gameInfo.players[`${team}_${slot}`] = {
                                name: memberElement.querySelector('.player-name').textContent,
                                champion: champion,
                                skin: aiSkin,
                                build: null,
                                team,
                                isAI: true,
                                role: roleAssignments[team][slot] // Add stealth role
                            };
                        }
                    }
                }

                console.log('Starting ARAM game with role assignments:', roleAssignments);

                // Save to Firebase
                const queueRef = ref(database, `Queue/${queueId}`);
                await set(queueRef, gameInfo);

                // Store queue ID and redirect
                sessionStorage.setItem('currentQueueId', queueId);
                window.location.href = 'Game_ARAM.html';
            } catch (error) {
                console.error('Error starting game:', error);
                alert('Error starting the game. Please try again.');
            }
        }

        // Update onAuthStateChanged function
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                
                // Get user data including ARAM games
                const userRef = ref(database, `users/${user.uid}`);
                const snapshot = await get(userRef);
                userData = snapshot.val(); // Store user data globally

                // Get player's ARAM games
                const aramGames = userData.aramGames || 0;

                // Update player name and ARAM games
                const playerElement = document.getElementById(`${playerTeam}-${playerSlot}`);
                const nameElement = playerElement.querySelector('.player-name');
                const statsElement = playerElement.querySelector('.player-rank');
                nameElement.textContent = userData.username || user.email.split('@')[0];
                statsElement.textContent = `${aramGames} ARAM Games`;

                // Shuffle usernames for AI players
                const shuffledUsernames = [...usernames].sort(() => Math.random() - 0.5);
                let aiNameIndex = 0;

                // Update AI player names and generate random ARAM games
                for (let team of ['blue', 'red']) {
                    for (let slot = 1; slot <= 5; slot++) {
                        if (team !== playerTeam || slot !== playerSlot) {
                            const memberElement = document.getElementById(`${team}-${slot}`);
                            const nameElement = memberElement.querySelector('.player-name');
                            const statsElement = memberElement.querySelector('.player-rank');
                            
                            nameElement.textContent = shuffledUsernames[aiNameIndex++];
                            
                            // Generate random ARAM games (between 0 and 200)
                            const randomGames = Math.floor(Math.random() * 201);
                            statsElement.textContent = `${randomGames} ARAM Games`;
                        }
                    }
                }

                const championAssignments = assignRandomChampions();
                displaySwapOptions();
                initializeGame(championAssignments);
            } else {
                window.location.href = 'index.html';
            }
        });

        // Chat system
        const chatMessagesContainer = document.querySelector('.chat-messages');
        const chatInput = document.querySelector('.chat-input');
        let lastMessageTime = Date.now();

        function addChatMessage(message, sender = 'System') {
            const messageElement = document.createElement('div');
            messageElement.className = 'chat-message';
            
            const senderSpan = document.createElement('span');
            senderSpan.style.color = sender === 'System' ? '#C89B3C' : '#F0E6D2';
            senderSpan.style.fontWeight = 'bold';
            senderSpan.textContent = sender + ': ';
            
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            
            messageElement.appendChild(senderSpan);
            messageElement.appendChild(messageSpan);
            
            chatMessagesContainer.appendChild(messageElement);
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        // Handle player chat input
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && chatInput.value.trim()) {
                const message = chatInput.value.trim();
                addChatMessage(message, userData?.username || auth.currentUser?.email?.split('@')[0]);
                chatInput.value = '';
                
                // Trigger AI response after player message
                setTimeout(() => {
                    generateAIResponse();
                }, Math.random() * 1000 + 500); // Random delay between 500-1500ms
            }
        });

        // AI Chat system
        function startAIChat() {
            // Initial welcome message
            addChatMessage('Welcome to ARAM! Select your champion and prepare for battle!');
            
            // Set up periodic AI messages
            setInterval(() => {
                if (Date.now() - lastMessageTime > 15000) { // 15 seconds since last message
                    generateAIResponse();
                }
            }, 5000); // Check every 5 seconds
        }

        function generateAIResponse() {
            const responses = [
                "Let's do this!",
                "Good luck everyone!",
                "Remember to have fun!",
                "May the best team win!",
                "Time to show our skills!",
                "This is going to be epic!",
                "Ready for an amazing match?",
                "Let's give it our all!",
                "Victory awaits!",
                "The battle is about to begin!"
            ];

            const aiPlayers = [...usernames].filter(name => 
                name !== (userData?.username || auth.currentUser?.email?.split('@')[0])
            );

            const randomAI = aiPlayers[Math.floor(Math.random() * aiPlayers.length)];
            const randomMessage = responses[Math.floor(Math.random() * responses.length)];
            
            addChatMessage(randomMessage, randomAI);
            lastMessageTime = Date.now();
        }

        // Add event listener for the start match button
        document.querySelector('.start-match-button').addEventListener('click', startGame);

        // Add build selection functionality
        document.getElementById('loadBuildButton').addEventListener('click', async () => {
            const modal = document.getElementById('buildSelectionModal');
            const buildGrid = document.getElementById('buildGrid');
            buildGrid.innerHTML = '';

            if (!selectedChampion) {
                buildGrid.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--text-color);">Please select a champion first.</div>`;
                modal.style.display = 'flex';
                return;
            }
            
            try {
                const allBuilds = [];
                const allPatchesRef = ref(database, 'builds');
                const patchesSnapshot = await get(allPatchesRef);

                if (patchesSnapshot.exists()) {
                    const patchPromises = [];
                    patchesSnapshot.forEach(patchChild => {
                        const patchKey = patchChild.key; // e.g., "2_1_1", "2_5"
                        const buildsPerPatchRef = ref(database, `builds/${patchKey}`);
                        patchPromises.push(get(buildsPerPatchRef).then(buildsSnapshot => {
                            if (buildsSnapshot.exists()) {
                                buildsSnapshot.forEach(childSnapshot => {
                                    const build = childSnapshot.val();
                                    if (build.character === selectedChampion) {
                                        allBuilds.push({
                                            id: childSnapshot.key,
                                            patchForDisplay: patchKey.replace(/_/g, '.'),
                                            patchForDB: patchKey,
                                            ...build
                                        });
                                    }
                                });
                            }
                        }));
                    });
                    await Promise.all(patchPromises);
                }

                if (allBuilds.length > 0) {
                    allBuilds.sort((a, b) => (b.likes || 0) - (a.likes || 0));

                    allBuilds.forEach(build => {
                        const card = document.createElement('div');
                        card.className = 'build-card';

                        const header = document.createElement('div');
                        header.className = 'build-header';
                        header.innerHTML = `
                            <div class="build-title">${build.name || 'Unnamed Build'}</div>
                            <div class="build-info">
                                <span>by ${build.creatorName || 'Anonymous'}</span>
                                <span>• Patch ${build.patchForDisplay}</span>
                            </div>
                        `;

                        const items = document.createElement('div');
                        items.className = 'build-items';
                        
                        build.items.forEach(itemId => {
                            if (itemId) {
                                const itemDiv = document.createElement('div');
                                itemDiv.className = 'build-item';
                                const img = document.createElement('img');
                                
                                img.onerror = function() {
                                    if (this.src.endsWith('.webp')) {
                                        this.src = `Items/${itemId}.jpeg`;
                                    } else if (this.src.endsWith('.jpeg')) {
                                        this.src = `Items/${itemId}.png`;
                                    } else if (this.src.endsWith('.png')) {
                                        this.src = `Items/${itemId}.jpg`;
                                    }
                                };
                                
                                img.src = `Items/${itemId}.webp`;
                                img.alt = itemId;
                                itemDiv.appendChild(img);
                                items.appendChild(itemDiv);
                            }
                        });

                        const actions = document.createElement('div');
                        actions.className = 'build-actions';
                        
                        const likeButton = document.createElement('button');
                        likeButton.className = `rating-button ${build.likedByCurrentUser ? 'liked' : ''}`;
                        likeButton.innerHTML = `
                            <i class="fas fa-thumbs-up"></i>
                            <span>${build.likes || 0}</span>
                        `;
                        likeButton.onclick = () => likeBuild(build.id, build.patchForDB);

                        const loadButton = document.createElement('button');
                        loadButton.className = 'copy-build';
                        loadButton.innerHTML = '<i class="fas fa-check"></i> Select Build';
                        loadButton.onclick = () => {
                            selectBuild(build);
                            modal.style.display = 'none';
                        };

                        actions.appendChild(likeButton);
                        actions.appendChild(loadButton);

                        card.appendChild(header);
                        card.appendChild(items);
                        card.appendChild(actions);
                        buildGrid.appendChild(card);
                    });
                } else {
                    buildGrid.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: var(--text-color);">
                            No builds found for ${selectedChampion}. 
                            <br><br>
                            <button class="copy-build" onclick="location.href='build-planner.html?character=${encodeURIComponent(selectedChampion)}'">
                                <i class="fas fa-plus"></i> Create New Build
                            </button>
                        </div>
                    `;
                }
                modal.style.display = 'flex';
            } catch (error) {
                console.error('Error loading builds:', error);
                buildGrid.innerHTML = ` 
                    <div style="text-align: center; padding: 20px; color: var(--text-color);">
                        Error loading builds. Please try again later. (${error.message})
                    </div>
                `;
                modal.style.display = 'flex';
            }
        });

        // Add like build functionality
        async function likeBuild(buildId, buildPatchVersion) {
            try {
                const user = auth.currentUser;
                if (!user) return;

                const buildRef = ref(database, `builds/${buildPatchVersion}/${buildId}`);
                const snapshot = await get(buildRef);
                
                if (snapshot.exists()) {
                    const build = snapshot.val();
                    const likes = (build.likes || 0) + 1;
                    await update(buildRef, { likes });
                    
                    const modal = document.getElementById('buildSelectionModal');
                    const allLikeButtons = modal.querySelectorAll(`.build-card button.rating-button`);
                    allLikeButtons.forEach(btn => {
                        const onclickAttr = btn.getAttribute('onclick');
                        if (onclickAttr && onclickAttr.includes(`likeBuild('${buildId}'`) && onclickAttr.includes(`'${buildPatchVersion}'`)) {
                            btn.classList.add('liked');
                            const likesSpan = btn.querySelector('span');
                            if (likesSpan) {
                                likesSpan.textContent = likes;
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Error liking build:', error);
            }
        }

        // Add selectBuild function
        async function selectBuild(build) {
            try {
                // Store the selected build globally
                selectedBuild = build;
                
                // Update the UI to show the build has been selected
                const loadBuildButton = document.getElementById('loadBuildButton');
                loadBuildButton.innerHTML = '<i class="fas fa-check"></i> BUILD SELECTED';
                loadBuildButton.classList.add('selected');
                
                console.log('Build selected:', selectedBuild);
            } catch (error) {
                console.error('Error selecting build:', error);
            }
        }
    </script>
</body>
</html> 